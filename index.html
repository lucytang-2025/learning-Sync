<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>复习打卡计划</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .app-description {
            font-size: 14px;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: #f1f5f9;
            border-bottom: 1px solid #e2e8f0;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .tab.active {
            background: white;
            color: #4facfe;
            border-bottom: 3px solid #4facfe;
        }

        .tab-content {
            display: none;
            padding: 20px;
            min-height: 500px;
        }

        .tab-content.active {
            display: block;
        }

        .task-list {
            margin-bottom: 20px;
        }

        .task-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #4facfe;
            transition: transform 0.2s;
        }

        .task-item:hover {
            transform: translateY(-2px);
        }

        .task-item.overdue {
            border-left-color: #ff6b6b;
            background: #fff5f5;
        }

        .task-item.completed {
            border-left-color: #1dd1a1;
            background: #f0fff4;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .task-name {
            font-weight: 600;
            font-size: 18px;
        }

        .task-status {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: white;
        }

        .status-overdue {
            background: #ff6b6b;
        }

        .status-today {
            background: #4ecdc4;
        }

        .status-completed {
            background: #1dd1a1;
        }

        .status-pending {
            background: #feca57;
        }

        .task-progress {
            margin: 10px 0;
        }

        .progress-bar {
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
            border-radius: 4px;
            transition: width 0.5s;
        }

        .progress-text {
            font-size: 12px;
            color: #64748b;
            margin-top: 5px;
        }

        .task-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #4facfe;
            color: white;
        }

        .btn-primary:hover {
            background: #3a9bf7;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #475569;
        }

        .btn-secondary:hover {
            background: #cbd5e1;
        }

        .btn-danger {
            background: #ff6b6b;
            color: white;
        }

        .btn-danger:hover {
            background: #ff5252;
        }

        .recorder-container, .photo-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .recorder-header, .photo-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .recorder-display {
            text-align: center;
            margin: 20px 0;
        }

        .timer {
            font-size: 48px;
            font-weight: 700;
            color: #4facfe;
            margin: 20px 0;
        }

        .recorder-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .recorder-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .record-btn {
            background: #ff6b6b;
            color: white;
        }

        .record-btn.recording {
            animation: pulse 1.5s infinite;
        }

        .pause-btn {
            background: #feca57;
            color: white;
        }

        .stop-btn {
            background: #48dbfb;
            color: white;
        }

        .play-btn {
            background: #1dd1a1;
            color: white;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .waveform {
            height: 100px;
            background: #f8fafc;
            border-radius: 10px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }

        .waveform-bar {
            position: absolute;
            bottom: 0;
            width: 4px;
            background: #4facfe;
            border-radius: 2px 2px 0 0;
        }

        .recordings-list, .photos-list {
            margin-top: 20px;
        }

        .recording-item, .photo-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .recording-info, .photo-info {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .recording-name, .photo-name {
            font-weight: 600;
        }

        .recording-duration, .photo-time {
            font-size: 12px;
            color: #64748b;
        }

        .photo-preview {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            margin-right: 15px;
        }

        .checkin-mode-selector {
            display: flex;
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #cbd5e1;
        }

        .checkin-mode {
            flex: 1;
            padding: 12px;
            text-align: center;
            background: #f8fafc;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .checkin-mode.active {
            background: #4facfe;
            color: white;
        }

        .photo-preview-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        .captured-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .camera-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        #video {
            width: 100%;
            max-width: 400px;
            border-radius: 10px;
            background: #000;
        }

        .canvas-container {
            display: none;
        }

        #canvas {
            max-width: 100%;
            border-radius: 10px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .hidden {
            display: none;
        }

        .task-form-container, .edit-task-form {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #475569;
        }

        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 16px;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        footer {
            text-align: center;
            padding: 20px;
            color: #64748b;
            font-size: 14px;
            border-top: 1px solid #e2e8f0;
        }

        .recording-status {
            text-align: center;
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            font-weight: 600;
        }

        .status-recording {
            background: #fff5f5;
            color: #ff6b6b;
        }

        .status-playing {
            background: #f0fff4;
            color: #1dd1a1;
        }

        .checkin-history {
            margin-top: 10px;
        }

        .history-item {
            padding: 8px 12px;
            border-left: 3px solid #4facfe;
            background: #f8fafc;
            margin-bottom: 8px;
            border-radius: 0 8px 8px 0;
            font-size: 12px;
        }

        .history-date {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .history-status {
            font-size: 11px;
            color: #64748b;
        }

        .task-description-display {
            background: #f8fafc;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #4facfe;
        }

        .task-description-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #475569;
        }

        .task-description-content {
            color: #64748b;
            line-height: 1.5;
        }

        .subject-chinese {
            color: #4facfe;
        }

        .subject-math {
            color: #764ba2;
        }

        .subject-english {
            color: #ff6b6b;
        }

        .subject-science {
            color: #1dd1a1;
        }

        .subject-other {
            color: #feca57;
        }

        .today-tasks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .tasks-count {
            background: #4facfe;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>复习打卡计划</h1>
            <p class="app-description">日积月累、持之以恒，冲刺100分</p>
        </header>

        <div class="tabs">
            <div class="tab active" data-tab="today">今日任务</div>
            <div class="tab" data-tab="tasks">任务管理</div>
            <div class="tab" data-tab="recorder">打卡</div>
            <div class="tab" data-tab="data">数据管理</div>
        </div>

        <div class="tab-content active" id="today-tab">
            <div class="today-tasks-header">
                <h2>今日任务</h2>
                <div class="tasks-count" id="today-tasks-count">0/0 个任务</div>
            </div>
            <div class="task-list" id="today-tasks">
                <!-- 今日任务将通过JavaScript动态生成 -->
            </div>
        </div>

        <div class="tab-content" id="tasks-tab">
            <h2>任务管理</h2>
            
            <div id="task-form" class="task-form-container hidden">
                <h3>新建任务</h3>
                <div class="form-group">
                    <label for="task-subject">科目</label>
                    <select id="task-subject">
                        <option value="语文">语文</option>
                        <option value="数学">数学</option>
                        <option value="英语">英语</option>
                        <option value="科学">科学</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="task-name">任务名称</label>
                    <input type="text" id="task-name" placeholder="输入任务名称">
                </div>
                <div class="form-group">
                    <label for="task-desc">任务描述</label>
                    <textarea id="task-desc" placeholder="输入任务描述（可选）"></textarea>
                </div>
                <div class="task-actions">
                    <button class="btn btn-primary" id="save-task">保存任务</button>
                    <button class="btn btn-secondary" id="cancel-task">取消</button>
                </div>
            </div>

            <div id="edit-task-form" class="edit-task-form hidden">
                <h3>编辑任务</h3>
                <div class="form-group">
                    <label for="edit-task-subject">科目</label>
                    <select id="edit-task-subject">
                        <option value="语文">语文</option>
                        <option value="数学">数学</option>
                        <option value="英语">英语</option>
                        <option value="科学">科学</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-task-name">任务名称</label>
                    <input type="text" id="edit-task-name" placeholder="输入任务名称">
                </div>
                <div class="form-group">
                    <label for="edit-task-desc">任务描述</label>
                    <textarea id="edit-task-desc" placeholder="输入任务描述（可选）"></textarea>
                </div>
                <div class="task-actions">
                    <button class="btn btn-primary" id="update-task">更新任务</button>
                    <button class="btn btn-secondary" id="cancel-edit-task">取消</button>
                </div>
            </div>
            
            <button class="btn btn-primary" id="add-task-btn">新建任务</button>
            
            <div class="task-list" id="all-tasks">
                <!-- 所有任务将通过JavaScript动态生成 -->
            </div>
        </div>

        <div class="tab-content" id="recorder-tab">
            <h2>打卡</h2>
            
            <!-- 打卡模式选择器 -->
            <div class="checkin-mode-selector">
                <div class="checkin-mode active" data-mode="record">录音打卡</div>
                <div class="checkin-mode" data-mode="photo">拍照打卡</div>
            </div>
            
            <!-- 录音打卡容器 -->
            <div class="recorder-container" id="record-container">
                <div class="recorder-header">
                    <h3 id="recorder-task-name">选择任务进行打卡</h3>
                    <p id="recorder-checkpoint">请先从今日任务中选择一个任务</p>
                </div>
                
                <div id="recorder-task-description" class="task-description-display hidden">
                    <div class="task-description-title">任务描述</div>
                    <div class="task-description-content" id="recorder-task-desc-content"></div>
                </div>
                
                <div class="recording-status hidden" id="recording-status"></div>
                
                <div class="recorder-display">
                    <div class="timer" id="timer">00:00:00</div>
                    <div class="waveform" id="waveform">
                        <!-- 波形图将通过JavaScript动态生成 -->
                    </div>
                </div>
                
                <div class="recorder-controls">
                    <button class="recorder-btn record-btn" id="record-btn" title="开始录音">
                        ●
                    </button>
                    <button class="recorder-btn pause-btn hidden" id="pause-btn" title="暂停">
                        ❚❚
                    </button>
                    <button class="recorder-btn stop-btn hidden" id="stop-btn" title="停止">
                        ■
                    </button>
                    <button class="recorder-btn play-btn hidden" id="play-btn" title="播放">
                        ▶
                    </button>
                </div>

                <audio id="audio-player" class="audio-player hidden" controls></audio>
                
                <div class="task-actions">
                    <button class="btn btn-primary" id="submit-recording" disabled>提交打卡</button>
                    <button class="btn btn-secondary" id="reset-recorder">重置</button>
                </div>
            </div>
            
            <!-- 拍照打卡容器 -->
            <div class="photo-container hidden" id="photo-container">
                <div class="photo-header">
                    <h3 id="photo-task-name">选择任务进行打卡</h3>
                    <p id="photo-checkpoint">请先从今日任务中选择一个任务</p>
                </div>
                
                <div id="photo-task-description" class="task-description-display hidden">
                    <div class="task-description-title">任务描述</div>
                    <div class="task-description-content" id="photo-task-desc-content"></div>
                </div>
                
                <div class="camera-container">
                    <video id="video" autoplay playsinline></video>
                    <canvas id="canvas" class="canvas-container"></canvas>
                    
                    <div class="photo-preview-container hidden" id="photo-preview-container">
                        <img id="captured-image" class="captured-image" src="" alt="拍摄的照片">
                    </div>
                    
                    <div class="task-actions">
                        <button class="btn btn-primary" id="capture-btn">拍照</button>
                        <button class="btn btn-secondary" id="retake-btn" style="display: none;">重拍</button>
                        <button class="btn btn-primary" id="submit-photo" disabled>提交打卡</button>
                        <button class="btn btn-secondary" id="reset-camera">重置</button>
                    </div>
                </div>
            </div>
            
            <!-- 打卡记录 -->
            <div class="recordings-list" id="recordings-list">
                <h3>录音打卡记录</h3>
                <!-- 录音记录将通过JavaScript动态生成 -->
            </div>
            
            <div class="photos-list" id="photos-list">
                <h3>拍照打卡记录</h3>
                <!-- 拍照记录将通过JavaScript动态生成 -->
            </div>
        </div>

        <div class="tab-content" id="data-tab">
            <h2>数据管理</h2>
            
            <div class="task-actions">
                <button class="btn btn-primary" id="export-data-btn">导出数据</button>
                <button class="btn btn-danger" id="clear-data-btn">清除所有数据</button>
            </div>
            
            <div class="task-list" style="margin-top: 20px;">
                <div class="task-item">
                    <div class="task-header">
                        <div class="task-name">数据统计</div>
                    </div>
                    <div class="progress-text">
                        <div>总任务数: <span id="stats-total-tasks">0</span></div>
                        <div>已完成任务: <span id="stats-completed-tasks">0</span></div>
                        <div>今日录音: <span id="stats-total-recordings">0</span></div>
                        <div>今日照片: <span id="stats-total-photos">0</span></div>
                    </div>
                </div>
            </div>
            
            <div class="task-item">
                <div class="task-header">
                    <div class="task-name">使用说明</div>
                </div>
                <div class="progress-text">
                    <ol>
                        <li>在"任务管理"中创建学习任务</li>
                        <li>在"今日任务"中查看今天需要完成的任务</li>
                        <li>使用"打卡"功能记录学习过程</li>
                        <li>支持录音打卡和拍照打卡两种方式</li>
                        <li>录音和照片只保留当天数据，第二天自动清理</li>
                    </ol>
                </div>
            </div>
        </div>

        <footer>
            <p>复习打卡计划 &copy; 2023 - 坚持每天打卡，成就更好的自己</p>
        </footer>
    </div>

    <script>
        // 应用数据
        const appData = {
            tasks: [],
            recordings: [],
            photos: [],
            currentTask: null,
            currentRecording: null,
            currentPhoto: null,
            isRecording: false,
            isPaused: false,
            isPlaying: false,
            timerInterval: null,
            recordingTime: 0,
            mediaRecorder: null,
            audioChunks: [],
            currentMode: 'record',
            stream: null
        };

        // DOM 元素
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const todayTasksEl = document.getElementById('today-tasks');
        const todayTasksCountEl = document.getElementById('today-tasks-count');
        const allTasksEl = document.getElementById('all-tasks');
        const taskFormEl = document.getElementById('task-form');
        const editTaskFormEl = document.getElementById('edit-task-form');
        const addTaskBtn = document.getElementById('add-task-btn');
        const saveTaskBtn = document.getElementById('save-task');
        const cancelTaskBtn = document.getElementById('cancel-task');
        const updateTaskBtn = document.getElementById('update-task');
        const cancelEditTaskBtn = document.getElementById('cancel-edit-task');
        
        // 打卡相关元素
        const recordModeBtn = document.querySelector('.checkin-mode[data-mode="record"]');
        const photoModeBtn = document.querySelector('.checkin-mode[data-mode="photo"]');
        const recordContainer = document.getElementById('record-container');
        const photoContainer = document.getElementById('photo-container');
        
        const recorderTaskNameEl = document.getElementById('recorder-task-name');
        const recorderCheckpointEl = document.getElementById('recorder-checkpoint');
        const photoTaskNameEl = document.getElementById('photo-task-name');
        const photoCheckpointEl = document.getElementById('photo-checkpoint');
        
        const recordingStatusEl = document.getElementById('recording-status');
        const timerEl = document.getElementById('timer');
        const waveformEl = document.getElementById('waveform');
        const recordBtn = document.getElementById('record-btn');
        const pauseBtn = document.getElementById('pause-btn');
        const stopBtn = document.getElementById('stop-btn');
        const playBtn = document.getElementById('play-btn');
        const audioPlayer = document.getElementById('audio-player');
        const submitRecordingBtn = document.getElementById('submit-recording');
        const resetRecorderBtn = document.getElementById('reset-recorder');
        
        // 拍照相关元素
        const videoEl = document.getElementById('video');
        const canvasEl = document.getElementById('canvas');
        const captureBtn = document.getElementById('capture-btn');
        const retakeBtn = document.getElementById('retake-btn');
        const submitPhotoBtn = document.getElementById('submit-photo');
        const resetCameraBtn = document.getElementById('reset-camera');
        const photoPreviewContainer = document.getElementById('photo-preview-container');
        const capturedImageEl = document.getElementById('captured-image');
        
        // 记录列表
        const recordingsListEl = document.getElementById('recordings-list');
        const photosListEl = document.getElementById('photos-list');
        
        // 数据管理
        const exportDataBtn = document.getElementById('export-data-btn');
        const clearDataBtn = document.getElementById('clear-data-btn');
        const statsTotalTasksEl = document.getElementById('stats-total-tasks');
        const statsCompletedTasksEl = document.getElementById('stats-completed-tasks');
        const statsTotalRecordingsEl = document.getElementById('stats-total-recordings');
        const statsTotalPhotosEl = document.getElementById('stats-total-photos');

        // 初始化应用
        function initApp() {
            console.log('初始化应用...');
            
            // 添加每日清理检查
            checkDailyCleanup();
            
            loadLocalData();
            setupEventListeners();
            
            renderTodayTasks();
            renderAllTasks();
            renderRecordings();
            renderPhotos();
            renderDataStats();
            
            console.log('应用初始化完成');
        }

        // 每日清理检查
        function checkDailyCleanup() {
            const lastCleanupDate = localStorage.getItem('lastCleanupDate');
            const today = new Date().toDateString();
            
            if (lastCleanupDate !== today) {
                strictDailyCleanup();
                localStorage.setItem('lastCleanupDate', today);
            }
        }

        // 严格的每日清零 - 只保留今天的录音和照片
        function strictDailyCleanup() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // 清理录音
            const originalRecordingsCount = appData.recordings.length;
            appData.recordings = appData.recordings.filter(recording => {
                const recordingDate = new Date(recording.date);
                recordingDate.setHours(0, 0, 0, 0);
                return recordingDate.getTime() === today.getTime();
            });
            
            // 清理照片
            const originalPhotosCount = appData.photos.length;
            appData.photos = appData.photos.filter(photo => {
                const photoDate = new Date(photo.date);
                photoDate.setHours(0, 0, 0, 0);
                return photoDate.getTime() === today.getTime();
            });
            
            const deletedRecordings = originalRecordingsCount - appData.recordings.length;
            const deletedPhotos = originalPhotosCount - appData.photos.length;
            
            if (deletedRecordings > 0 || deletedPhotos > 0) {
                saveRecordings();
                savePhotos();
                console.log(`严格清理：删除了 ${deletedRecordings} 个录音和 ${deletedPhotos} 张照片`);
            }
        }

        // 获取默认任务
        function getDefaultTasks() {
            return [
                {
                    id: 1,
                    subject: '英语',
                    name: '单词记忆',
                    description: '每天记忆30个新单词，复习前一天的单词',
                    createDate: new Date().toISOString(),
                    status: 'active',
                    checkins: []
                },
                {
                    id: 2,
                    subject: '数学',
                    name: '习题练习',
                    description: '完成教材课后习题，重点练习薄弱环节',
                    createDate: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                    status: 'active',
                    checkins: []
                }
            ];
        }

        // 保存任务数据
        function saveTasks() {
            localStorage.setItem('checkinTasks', JSON.stringify(appData.tasks));
        }

        // 保存录音数据
        function saveRecordings() {
            localStorage.setItem('checkinRecordings', JSON.stringify(appData.recordings));
        }

        // 保存照片数据
        function savePhotos() {
            localStorage.setItem('checkinPhotos', JSON.stringify(appData.photos));
        }

        // 从本地加载数据
        function loadLocalData() {
            const savedTasks = localStorage.getItem('checkinTasks');
            const savedRecordings = localStorage.getItem('checkinRecordings');
            const savedPhotos = localStorage.getItem('checkinPhotos');
            
            if (savedTasks) {
                appData.tasks = JSON.parse(savedTasks);
            } else {
                appData.tasks = getDefaultTasks();
            }
            
            if (savedRecordings) {
                appData.recordings = JSON.parse(savedRecordings);
            } else {
                appData.recordings = [];
            }
            
            if (savedPhotos) {
                appData.photos = JSON.parse(savedPhotos);
            } else {
                appData.photos = [];
            }
            
            saveLocalData();
        }

        // 保存数据到本地
        function saveLocalData() {
            saveTasks();
            saveRecordings();
            savePhotos();
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 标签页切换
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });

            // 任务管理
            addTaskBtn.addEventListener('click', showTaskForm);
            saveTaskBtn.addEventListener('click', saveTask);
            cancelTaskBtn.addEventListener('click', hideTaskForm);
            updateTaskBtn.addEventListener('click', updateTask);
            cancelEditTaskBtn.addEventListener('click', hideEditTaskForm);

            // 打卡模式切换
            recordModeBtn.addEventListener('click', () => switchCheckinMode('record'));
            photoModeBtn.addEventListener('click', () => switchCheckinMode('photo'));

            // 录音控制
            recordBtn.addEventListener('click', startRecording);
            pauseBtn.addEventListener('click', togglePause);
            stopBtn.addEventListener('click', stopRecording);
            playBtn.addEventListener('click', playRecording);
            submitRecordingBtn.addEventListener('click', submitRecording);
            resetRecorderBtn.addEventListener('click', resetRecorder);

            // 拍照控制
            captureBtn.addEventListener('click', capturePhoto);
            retakeBtn.addEventListener('click', retakePhoto);
            submitPhotoBtn.addEventListener('click', submitPhoto);
            resetCameraBtn.addEventListener('click', resetCamera);
        }

        // 切换标签页
        function switchTab(tabId) {
            tabs.forEach(tab => {
                if (tab.getAttribute('data-tab') === tabId) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            tabContents.forEach(content => {
                if (content.id === `${tabId}-tab`) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });

            if (tabId === 'today') {
                renderTodayTasks();
            } else if (tabId === 'tasks') {
                renderAllTasks();
            } else if (tabId === 'recorder') {
                renderRecordings();
                renderPhotos();
            } else if (tabId === 'data') {
                renderDataStats();
            }
        }

        // 切换打卡模式
        function switchCheckinMode(mode) {
            appData.currentMode = mode;
            
            // 更新模式按钮状态
            document.querySelectorAll('.checkin-mode').forEach(btn => {
                if (btn.getAttribute('data-mode') === mode) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // 显示对应的容器
            recordContainer.classList.add('hidden');
            photoContainer.classList.add('hidden');
            
            if (mode === 'record') {
                recordContainer.classList.remove('hidden');
                if (appData.currentTask) {
                    updateRecorderTaskInfo();
                }
            } else if (mode === 'photo') {
                photoContainer.classList.remove('hidden');
                if (appData.currentTask) {
                    updatePhotoTaskInfo();
                }
                initCamera();
            }
        }

        // 更新录音界面的任务信息
        function updateRecorderTaskInfo() {
            recorderTaskNameEl.textContent = `${appData.currentTask.subject} - ${appData.currentTask.name}`;
            recorderCheckpointEl.textContent = '点击开始录音进行打卡';
            
            if (appData.currentTask.description) {
                document.getElementById('recorder-task-desc-content').textContent = appData.currentTask.description;
                document.getElementById('recorder-task-description').classList.remove('hidden');
            } else {
                document.getElementById('recorder-task-description').classList.add('hidden');
            }
        }

        // 更新拍照界面的任务信息
        function updatePhotoTaskInfo() {
            photoTaskNameEl.textContent = `${appData.currentTask.subject} - ${appData.currentTask.name}`;
            photoCheckpointEl.textContent = '点击拍照进行打卡';
            
            if (appData.currentTask.description) {
                document.getElementById('photo-task-desc-content').textContent = appData.currentTask.description;
                document.getElementById('photo-task-description').classList.remove('hidden');
            } else {
                document.getElementById('photo-task-description').classList.add('hidden');
            }
        }

        // 初始化摄像头
        async function initCamera() {
            try {
                if (appData.stream) {
                    appData.stream.getTracks().forEach(track => track.stop());
                }
                
                appData.stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                videoEl.srcObject = appData.stream;
                
                // 显示视频，隐藏预览
                videoEl.classList.remove('hidden');
                photoPreviewContainer.classList.add('hidden');
                captureBtn.style.display = 'block';
                retakeBtn.style.display = 'none';
                submitPhotoBtn.disabled = true;
                
            } catch (error) {
                console.error('摄像头初始化失败:', error);
                alert('无法访问摄像头，请检查权限设置');
            }
        }

        // 拍照
        function capturePhoto() {
            const context = canvasEl.getContext('2d');
            canvasEl.width = videoEl.videoWidth;
            canvasEl.height = videoEl.videoHeight;
            context.drawImage(videoEl, 0, 0, canvasEl.width, canvasEl.height);
            
            // 显示预览，隐藏视频
            capturedImageEl.src = canvasEl.toDataURL('image/jpeg');
            photoPreviewContainer.classList.remove('hidden');
            videoEl.classList.add('hidden');
            captureBtn.style.display = 'none';
            retakeBtn.style.display = 'block';
            submitPhotoBtn.disabled = false;
            
            // 停止摄像头流以释放资源
            if (appData.stream) {
                appData.stream.getTracks().forEach(track => track.stop());
            }
        }

        // 重拍
        function retakePhoto() {
            initCamera();
        }

        // 重置摄像头
        function resetCamera() {
            if (appData.stream) {
                appData.stream.getTracks().forEach(track => track.stop());
                appData.stream = null;
            }
            videoEl.srcObject = null;
            photoPreviewContainer.classList.add('hidden');
            videoEl.classList.add('hidden');
            captureBtn.style.display = 'block';
            retakeBtn.style.display = 'none';
            submitPhotoBtn.disabled = true;
            appData.currentPhoto = null;
        }

        // 开始录音
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                appData.mediaRecorder = new MediaRecorder(stream);
                appData.audioChunks = [];
                
                appData.mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        appData.audioChunks.push(event.data);
                    }
                };
                
                appData.mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(appData.audioChunks, { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    appData.currentRecording = {
                        id: Date.now(),
                        taskId: appData.currentTask.id,
                        date: new Date().toISOString(),
                        duration: appData.recordingTime,
                        audioUrl: audioUrl,
                        audioBlob: audioBlob
                    };
                    
                    stream.getTracks().forEach(track => track.stop());
                    
                    recordBtn.classList.remove('recording', 'hidden');
                    pauseBtn.classList.add('hidden');
                    stopBtn.classList.add('hidden');
                    playBtn.classList.remove('hidden');
                    submitRecordingBtn.disabled = false;
                    
                    audioPlayer.src = audioUrl;
                    audioPlayer.classList.remove('hidden');
                    
                    console.log('录音完成');
                };
                
                appData.isRecording = true;
                appData.isPaused = false;
                appData.recordingTime = 0;
                
                recordBtn.classList.add('recording');
                pauseBtn.classList.remove('hidden');
                stopBtn.classList.remove('hidden');
                recordBtn.classList.add('hidden');
                
                updatePlaybackStatus('录音中...', 'status-recording');
                
                appData.mediaRecorder.start();
                
                appData.timerInterval = setInterval(() => {
                    appData.recordingTime += 10;
                    updateTimer();
                    updateWaveform();
                }, 10);
                
            } catch (error) {
                console.error('录音启动失败:', error);
                alert('无法访问麦克风，请检查权限设置');
            }
        }

        // 暂停录音
        function togglePause() {
            if (!appData.mediaRecorder) return;
            
            if (appData.isPaused) {
                appData.mediaRecorder.resume();
                appData.isPaused = false;
                pauseBtn.innerHTML = '❚❚';
                updatePlaybackStatus('录音中...', 'status-recording');
                
                appData.timerInterval = setInterval(() => {
                    appData.recordingTime += 10;
                    updateTimer();
                    updateWaveform();
                }, 10);
            } else {
                appData.mediaRecorder.pause();
                appData.isPaused = true;
                clearInterval(appData.timerInterval);
                pauseBtn.innerHTML = '▶';
                updatePlaybackStatus('录音已暂停', 'status-playing');
            }
        }

        // 停止录音
        function stopRecording() {
            if (!appData.mediaRecorder || appData.mediaRecorder.state === 'inactive') return;
            
            appData.mediaRecorder.stop();
            appData.isRecording = false;
            appData.isPaused = false;
            
            clearInterval(appData.timerInterval);
            
            recordBtn.classList.remove('recording', 'hidden');
            pauseBtn.classList.add('hidden');
            stopBtn.classList.add('hidden');
            playBtn.classList.remove('hidden');
            submitRecordingBtn.disabled = false;
            
            recordingStatusEl.classList.add('hidden');
        }

        // 播放录音
        function playRecording() {
            if (!appData.currentRecording) {
                console.log('没有当前录音可播放');
                return;
            }
            
            audioPlayer.src = appData.currentRecording.audioUrl;
            audioPlayer.classList.remove('hidden');
            audioPlayer.play().catch(error => {
                console.error('播放失败:', error);
                alert('播放录音失败');
            });
        }

        // 提交录音
        function submitRecording() {
            if (!appData.currentRecording) {
                alert('请先完成录音！');
                return;
            }
            
            appData.recordings.push(appData.currentRecording);
            saveRecordings();
            
            // 记录打卡
            recordCheckin('recording', appData.currentRecording.id);
            
            resetRecorder();
            renderRecordings();
            renderTodayTasks();
            renderAllTasks();
            renderDataStats();
            
            alert('打卡成功！');
        }

        // 提交照片
        function submitPhoto() {
            if (!capturedImageEl.src) {
                alert('请先拍照！');
                return;
            }
            
            const photo = {
                id: Date.now(),
                taskId: appData.currentTask.id,
                date: new Date().toISOString(),
                imageUrl: capturedImageEl.src
            };
            
            appData.photos.push(photo);
            savePhotos();
            
            // 记录打卡
            recordCheckin('photo', photo.id);
            
            resetCamera();
            renderPhotos();
            renderTodayTasks();
            renderAllTasks();
            renderDataStats();
            
            alert('打卡成功！');
        }

        // 记录打卡
        function recordCheckin(type, mediaId) {
            const task = appData.tasks.find(t => t.id === appData.currentTask.id);
            if (!task) return;
            
            const today = new Date().toISOString().split('T')[0];
            const hasCheckedInToday = task.checkins.some(checkin => 
                checkin.date.startsWith(today)
            );
            
            if (!hasCheckedInToday) {
                task.checkins.push({
                    date: new Date().toISOString(),
                    type: type,
                    mediaId: mediaId
                });
                saveTasks();
            }
        }

        // 重置录音器
        function resetRecorder() {
            appData.isRecording = false;
            appData.isPaused = false;
            appData.recordingTime = 0;
            
            clearInterval(appData.timerInterval);
            
            recordBtn.classList.remove('recording', 'hidden');
            pauseBtn.classList.add('hidden');
            stopBtn.classList.add('hidden');
            playBtn.classList.add('hidden');
            submitRecordingBtn.disabled = true;
            
            audioPlayer.classList.add('hidden');
            audioPlayer.src = '';
            recordingStatusEl.classList.add('hidden');
            
            updateTimer();
            clearWaveform();
            appData.currentRecording = null;
        }

        // 更新播放状态显示
        function updatePlaybackStatus(message, statusClass) {
            recordingStatusEl.textContent = message;
            recordingStatusEl.className = 'recording-status ' + statusClass;
            recordingStatusEl.classList.remove('hidden');
        }

        // 更新计时器
        function updateTimer() {
            timerEl.textContent = formatTime(appData.recordingTime);
        }

        // 格式化时间
        function formatTime(milliseconds) {
            const totalSeconds = Math.floor(milliseconds / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            const ms = Math.floor((milliseconds % 1000) / 10);
            
            if (hours > 0) {
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${ms.toString().padStart(2, '0')}`;
        }

        // 更新波形图
        function updateWaveform() {
            if (Math.random() < 0.3) {
                const bar = document.createElement('div');
                bar.className = 'waveform-bar';
                bar.style.height = `${10 + Math.random() * 80}px`;
                bar.style.left = `${Math.random() * 95}%`;
                waveformEl.appendChild(bar);
                
                if (waveformEl.children.length > 50) {
                    waveformEl.removeChild(waveformEl.firstChild);
                }
            }
        }

        // 清空波形图
        function clearWaveform() {
            waveformEl.innerHTML = '';
        }

        // 显示任务表单
        function showTaskForm() {
            taskFormEl.classList.remove('hidden');
            hideEditTaskForm();
            document.getElementById('task-subject').value = '语文';
            document.getElementById('task-name').value = '';
            document.getElementById('task-desc').value = '';
        }

        // 隐藏任务表单
        function hideTaskForm() {
            taskFormEl.classList.add('hidden');
        }

        // 显示编辑任务表单
        function showEditTaskForm(taskId) {
            const task = appData.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            appData.editingTask = task;
            editTaskFormEl.classList.remove('hidden');
            hideTaskForm();
            
            document.getElementById('edit-task-subject').value = task.subject;
            document.getElementById('edit-task-name').value = task.name;
            document.getElementById('edit-task-desc').value = task.description || '';
        }

        // 隐藏编辑任务表单
        function hideEditTaskForm() {
            editTaskFormEl.classList.add('hidden');
            appData.editingTask = null;
        }

        // 保存任务
        function saveTask() {
            const subject = document.getElementById('task-subject').value;
            const name = document.getElementById('task-name').value.trim();
            const desc = document.getElementById('task-desc').value.trim();
            
            if (!name) {
                alert('请输入任务名称');
                return;
            }
            
            const newTask = {
                id: Date.now(),
                subject: subject,
                name: name,
                description: desc,
                createDate: new Date().toISOString(),
                status: 'active',
                checkins: []
            };
            
            appData.tasks.push(newTask);
            saveTasks();
            hideTaskForm();
            
            renderAllTasks();
            renderTodayTasks();
            renderDataStats();
        }

        // 更新任务
        function updateTask() {
            if (!appData.editingTask) return;
            
            const subject = document.getElementById('edit-task-subject').value;
            const name = document.getElementById('edit-task-name').value.trim();
            const desc = document.getElementById('edit-task-desc').value.trim();
            
            if (!name) {
                alert('请输入任务名称');
                return;
            }
            
            appData.editingTask.subject = subject;
            appData.editingTask.name = name;
            appData.editingTask.description = desc;
            
            saveTasks();
            hideEditTaskForm();
            renderAllTasks();
            renderTodayTasks();
            renderDataStats();
        }

        // 删除任务
        function deleteTask(taskId) {
            if (confirm('确定要删除这个任务吗？此操作将永久删除任务及其相关数据，不可恢复！')) {
                appData.tasks = appData.tasks.filter(t => t.id !== taskId);
                appData.recordings = appData.recordings.filter(r => r.taskId !== taskId);
                appData.photos = appData.photos.filter(p => p.taskId !== taskId);
                
                saveTasks();
                saveRecordings();
                savePhotos();
                
                renderAllTasks();
                renderTodayTasks();
                renderRecordings();
                renderPhotos();
                renderDataStats();
            }
        }

        // 开始打卡
        function startCheckin(taskId) {
            const task = appData.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            appData.currentTask = task;
            
            switchTab('recorder');
            
            // 默认显示录音打卡模式
            switchCheckinMode('record');
            
            resetRecorder();
            resetCamera();
        }

        // 删除录音
        function deleteRecording(recordingId) {
            if (confirm('确定要删除这个录音吗？')) {
                appData.recordings = appData.recordings.filter(r => r.id !== recordingId);
                saveRecordings();
                renderRecordings();
                renderDataStats();
            }
        }

        // 删除照片
        function deletePhoto(photoId) {
            if (confirm('确定要删除这张照片吗？')) {
                appData.photos = appData.photos.filter(p => p.id !== photoId);
                savePhotos();
                renderPhotos();
                renderDataStats();
            }
        }

        // 渲染今日任务
        function renderTodayTasks() {
            todayTasksEl.innerHTML = '';
            
            const today = new Date().toISOString().split('T')[0];
            let totalTasks = 0;
            let completedTasks = 0;
            
            // 分离已完成和未完成的任务
            const activeTasks = [];
            const completedTasksList = [];
            
            appData.tasks.forEach(task => {
                if (task.status !== 'active') return;
                
                const hasCheckedInToday = task.checkins.some(checkin => 
                    checkin.date.startsWith(today)
                );
                
                totalTasks++;
                if (hasCheckedInToday) {
                    completedTasks++;
                    completedTasksList.push({task, hasCheckedInToday});
                } else {
                    activeTasks.push({task, hasCheckedInToday});
                }
            });
            
            todayTasksCountEl.textContent = `${completedTasks}/${totalTasks} 个任务`;
            
            // 按科目排序：语文、英语、数学、其他
            const subjectOrder = { '语文': 1, '英语': 2, '数学': 3, '科学': 4, '其他': 5 };
            
            activeTasks.sort((a, b) => {
                const subjectA = subjectOrder[a.task.subject] || 6;
                const subjectB = subjectOrder[b.task.subject] || 6;
                return subjectA - subjectB;
            });
            
            completedTasksList.sort((a, b) => {
                const subjectA = subjectOrder[a.task.subject] || 6;
                const subjectB = subjectOrder[b.task.subject] || 6;
                return subjectA - subjectB;
            });
            
            // 合并任务列表：未完成的任务在前，已完成的任务在后
            const sortedTasks = [...activeTasks, ...completedTasksList];
            
            if (sortedTasks.length === 0) {
                todayTasksEl.innerHTML = `
                    <div class="empty-state">
                        <i>📅</i>
                        <p>今天没有打卡任务，放松一下吧！</p>
                    </div>
                `;
                return;
            }
            
            sortedTasks.forEach(({task, hasCheckedInToday}) => {
                const taskEl = document.createElement('div');
                taskEl.className = `task-item ${hasCheckedInToday ? 'completed' : ''}`;
                
                const subjectClass = `subject-${task.subject === '语文' ? 'chinese' : 
                                    task.subject === '数学' ? 'math' : 
                                    task.subject === '英语' ? 'english' : 
                                    task.subject === '科学' ? 'science' : 'other'}`;
                
                taskEl.innerHTML = `
                    <div class="task-header">
                        <div class="task-name ${subjectClass}">${task.subject} - ${task.name}</div>
                        <div class="task-status ${hasCheckedInToday ? 'status-completed' : 'status-today'}">
                            ${hasCheckedInToday ? '✓ 今日已打卡' : '未完成'}
                        </div>
                    </div>
                    ${task.description ? `<p>${task.description}</p>` : ''}
                    <div class="task-actions">
                        ${!hasCheckedInToday ? 
                            `<button class="btn btn-primary" onclick="startCheckin(${task.id})">打卡</button>` : 
                            `<button class="btn btn-secondary" onclick="startCheckin(${task.id})" disabled>已完成</button>`}
                        <button class="btn btn-secondary" onclick="showEditTaskForm(${task.id})">编辑</button>
                        <button class="btn btn-danger" onclick="deleteTask(${task.id})">删除</button>
                    </div>
                `;
                
                todayTasksEl.appendChild(taskEl);
            });
        }

        // 渲染所有任务
        function renderAllTasks() {
            allTasksEl.innerHTML = '';
            
            if (appData.tasks.length === 0) {
                allTasksEl.innerHTML = `
                    <div class="empty-state">
                        <i>📝</i>
                        <p>还没有任何任务，点击"新建任务"开始吧！</p>
                    </div>
                `;
                return;
            }
            
            // 按科目排序：语文、英语、数学、其他
            const subjectOrder = { '语文': 1, '英语': 2, '数学': 3, '科学': 4, '其他': 5 };
            
            const sortedTasks = [...appData.tasks].sort((a, b) => {
                const subjectA = subjectOrder[a.subject] || 6;
                const subjectB = subjectOrder[b.subject] || 6;
                return subjectA - subjectB;
            });
            
            sortedTasks.forEach(task => {
                const taskEl = document.createElement('div');
                taskEl.className = 'task-item';
                
                const today = new Date().toISOString().split('T')[0];
                const hasCheckedInToday = task.checkins.some(checkin => 
                    checkin.date.startsWith(today)
                );
                
                const subjectClass = `subject-${task.subject === '语文' ? 'chinese' : 
                                    task.subject === '数学' ? 'math' : 
                                    task.subject === '英语' ? 'english' : 
                                    task.subject === '科学' ? 'science' : 'other'}`;
                
                taskEl.innerHTML = `
                    <div class="task-header">
                        <div class="task-name ${subjectClass}">${task.subject} - ${task.name}</div>
                        <div class="task-status ${hasCheckedInToday ? 'status-completed' : 'status-today'}">
                            ${hasCheckedInToday ? '今日已打卡' : '今日未打卡'}
                        </div>
                    </div>
                    ${task.description ? `<p>${task.description}</p>` : ''}
                    <div class="task-progress">
                        <div class="progress-text">
                            已打卡 ${task.checkins.length} 次
                        </div>
                    </div>
                    <div class="task-actions">
                        <button class="btn btn-primary" onclick="startCheckin(${task.id})">打卡</button>
                        <button class="btn btn-secondary" onclick="showEditTaskForm(${task.id})">编辑</button>
                        <button class="btn btn-danger" onclick="deleteTask(${task.id})">删除</button>
                    </div>
                `;
                
                allTasksEl.appendChild(taskEl);
            });
        }

        // 渲染录音记录
        function renderRecordings() {
            recordingsListEl.innerHTML = '<h3>录音打卡记录</h3>';
            
            if (appData.recordings.length === 0) {
                recordingsListEl.innerHTML += `
                    <div class="empty-state">
                        <i>🎤</i>
                        <p>还没有任何录音记录</p>
                    </div>
                `;
                return;
            }
            
            // 只显示今天的录音
            const today = new Date().toISOString().split('T')[0];
            const todayRecordings = appData.recordings.filter(recording => 
                recording.date.startsWith(today)
            );
            
            if (todayRecordings.length === 0) {
                recordingsListEl.innerHTML += `
                    <div class="empty-state">
                        <i>🎤</i>
                        <p>今天还没有录音记录</p>
                    </div>
                `;
                return;
            }
            
            // 按时间倒序排列
            todayRecordings.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            todayRecordings.forEach(recording => {
                const recordingEl = document.createElement('div');
                recordingEl.className = 'recording-item';
                
                const task = appData.tasks.find(t => t.id === recording.taskId);
                const taskName = task ? `${task.subject} - ${task.name}` : '未知任务';
                const date = new Date(recording.date).toLocaleString();
                
                recordingEl.innerHTML = `
                    <div class="recording-info">
                        <div class="recording-name">${taskName}</div>
                        <div class="recording-duration">${date} | 时长: ${formatTime(recording.duration)}</div>
                    </div>
                    <div class="task-actions">
                        <button class="btn btn-secondary" onclick="playSavedRecording(${recording.id})">播放</button>
                        <button class="btn btn-danger" onclick="deleteRecording(${recording.id})">删除</button>
                    </div>
                `;
                
                recordingsListEl.appendChild(recordingEl);
            });
        }

        // 渲染照片记录
        function renderPhotos() {
            photosListEl.innerHTML = '<h3>拍照打卡记录</h3>';
            
            if (appData.photos.length === 0) {
                photosListEl.innerHTML += `
                    <div class="empty-state">
                        <i>📷</i>
                        <p>还没有任何拍照记录</p>
                    </div>
                `;
                return;
            }
            
            // 只显示今天的照片
            const today = new Date().toISOString().split('T')[0];
            const todayPhotos = appData.photos.filter(photo => 
                photo.date.startsWith(today)
            );
            
            if (todayPhotos.length === 0) {
                photosListEl.innerHTML += `
                    <div class="empty-state">
                        <i>📷</i>
                        <p>今天还没有拍照记录</p>
                    </div>
                `;
                return;
            }
            
            // 按时间倒序排列
            todayPhotos.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            todayPhotos.forEach(photo => {
                const photoEl = document.createElement('div');
                photoEl.className = 'photo-item';
                
                const task = appData.tasks.find(t => t.id === photo.taskId);
                const taskName = task ? `${task.subject} - ${task.name}` : '未知任务';
                const date = new Date(photo.date).toLocaleString();
                
                photoEl.innerHTML = `
                    <img src="${photo.imageUrl}" class="photo-preview" alt="打卡照片">
                    <div class="photo-info">
                        <div class="photo-name">${taskName}</div>
                        <div class="photo-time">${date}</div>
                    </div>
                    <div class="task-actions">
                        <button class="btn btn-danger" onclick="deletePhoto(${photo.id})">删除</button>
                    </div>
                `;
                
                photosListEl.appendChild(photoEl);
            });
        }

        // 播放保存的录音
        function playSavedRecording(recordingId) {
            const recording = appData.recordings.find(r => r.id === recordingId);
            if (!recording) return;
            
            switchTab('recorder');
            switchCheckinMode('record');
            
            audioPlayer.src = recording.audioUrl;
            audioPlayer.classList.remove('hidden');
            audioPlayer.play().catch(error => {
                console.error('播放失败:', error);
                alert('播放录音失败');
            });
        }

        // 渲染数据统计
        function renderDataStats() {
            const totalTasks = appData.tasks.length;
            const today = new Date().toISOString().split('T')[0];
            
            const completedTasks = appData.tasks.filter(task => 
                task.checkins.some(checkin => checkin.date.startsWith(today))
            ).length;
            
            const todayRecordings = appData.recordings.filter(recording => 
                recording.date.startsWith(today)
            ).length;
            
            const todayPhotos = appData.photos.filter(photo => 
                photo.date.startsWith(today)
            ).length;
            
            statsTotalTasksEl.textContent = totalTasks;
            statsCompletedTasksEl.textContent = completedTasks;
            statsTotalRecordingsEl.textContent = todayRecordings;
            statsTotalPhotosEl.textContent = todayPhotos;
        }

        // 导出数据
        function exportData() {
            const exportData = {
                tasks: appData.tasks,
                recordings: appData.recordings,
                photos: appData.photos,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `复习打卡计划备份_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('数据导出成功！');
        }

        // 清除所有数据
        function clearAllData() {
            if (!confirm('确定要清除所有数据吗？此操作不可撤销！')) {
                return;
            }
            
            if (!confirm('再次确认：这将删除所有任务、录音和照片，确定要继续吗？')) {
                return;
            }
            
            appData.tasks = [];
            appData.recordings = [];
            appData.photos = [];
            
            localStorage.removeItem('checkinTasks');
            localStorage.removeItem('checkinRecordings');
            localStorage.removeItem('checkinPhotos');
            localStorage.removeItem('lastCleanupDate');
            
            appData.currentTask = null;
            appData.currentRecording = null;
            appData.currentPhoto = null;
            
            renderTodayTasks();
            renderAllTasks();
            renderRecordings();
            renderPhotos();
            renderDataStats();
            
            alert('所有数据已清除！');
        }

        // 初始化应用
        window.onload = initApp;
    </script>
</body>
</html>