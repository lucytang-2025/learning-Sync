<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>复习打卡计划 - 安全存储版</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .app-description {
            font-size: 14px;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: #f1f5f9;
            border-bottom: 1px solid #e2e8f0;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .tab.active {
            background: white;
            color: #4facfe;
            border-bottom: 3px solid #4facfe;
        }

        .tab-content {
            display: none;
            padding: 20px;
            min-height: 500px;
        }

        .tab-content.active {
            display: block;
        }

        .task-list {
            margin-bottom: 20px;
        }

        .task-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #4facfe;
            transition: transform 0.2s;
        }

        .task-item:hover {
            transform: translateY(-2px);
        }

        .task-item.overdue {
            border-left-color: #ff6b6b;
            background: #fff5f5;
        }

        .task-item.completed {
            border-left-color: #1dd1a1;
            background: #f0fff4;
        }

        .task-item.pending-review {
            border-left-color: #feca57;
            background: #fff9e6;
        }

        .task-item.needs-redo {
            border-left-color: #ff9f43;
            background: #fff9e6;
        }

        .task-item.pinned {
            border-left-color: #ff9ff3;
            background: #fff5f9;
            box-shadow: 0 4px 12px rgba(255, 159, 243, 0.2);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .task-name {
            font-weight: 600;
            font-size: 18px;
        }

        .task-status {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: white;
        }

        .status-overdue {
            background: #ff6b6b;
        }

        .status-today {
            background: #4ecdc4;
        }

        .status-future {
            background: #45aaf2;
        }

        .status-completed {
            background: #1dd1a1;
        }

        .status-pending {
            background: #feca57;
        }

        .status-pending-review {
            background: #ff9ff3;
        }

        .status-rejected {
            background: #ff9f43;
        }

        .status-needs-redo {
            background: #ff9f43;
            color: white;
        }

        .task-progress {
            margin: 10px 0;
        }

        .progress-bar {
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
            border-radius: 4px;
            transition: width 0.5s;
        }

        .progress-text {
            font-size: 12px;
            color: #64748b;
            margin-top: 5px;
        }

        .task-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #4facfe;
            color: white;
        }

        .btn-primary:hover {
            background: #3a9bf7;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #475569;
        }

        .btn-secondary:hover {
            background: #cbd5e1;
        }

        .btn-danger {
            background: #ff6b6b;
            color: white;
        }

        .btn-danger:hover {
            background: #ff5252;
        }

        .btn-warning {
            background: #ff9f43;
            color: white;
        }

        .btn-warning:hover {
            background: #ff8c2a;
        }

        .btn-disabled {
            background: #cbd5e1;
            color: #94a3b8;
            cursor: not-allowed;
        }

        .btn-disabled:hover {
            background: #cbd5e1;
        }

        .btn-pin {
            background: #ff9ff3;
            color: white;
        }

        .btn-pin:hover {
            background: #ff85e6;
        }

        .btn-unpin {
            background: #c8d6e5;
            color: #576574;
        }

        .btn-unpin:hover {
            background: #b2bec3;
        }

        .recorder-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .recorder-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .recorder-display {
            text-align: center;
            margin: 20px 0;
        }

        .timer {
            font-size: 48px;
            font-weight: 700;
            color: #4facfe;
            margin: 20px 0;
        }

        .recorder-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .recorder-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .record-btn {
            background: #ff6b6b;
            color: white;
        }

        .record-btn.recording {
            animation: pulse 1.5s infinite;
        }

        .pause-btn {
            background: #feca57;
            color: white;
        }

        .stop-btn {
            background: #48dbfb;
            color: white;
        }

        .play-btn {
            background: #1dd1a1;
            color: white;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .waveform {
            height: 100px;
            background: #f8fafc;
            border-radius: 10px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }

        .waveform-bar {
            position: absolute;
            bottom: 0;
            width: 4px;
            background: #4facfe;
            border-radius: 2px 2px 0 0;
        }

        .recordings-list {
            margin-top: 20px;
        }

        .recording-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .recording-info {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .recording-name {
            font-weight: 600;
        }

        .recording-duration {
            font-size: 12px;
            color: #64748b;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px 0;
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .calendar-nav-btn {
            background: #4facfe;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .calendar-nav-btn:hover {
            background: #3a9bf7;
        }

        .calendar-title {
            font-size: 18px;
            font-weight: 600;
            color: #475569;
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 10px;
        }

        .calendar-weekday {
            text-align: center;
            font-weight: 600;
            padding: 10px 0;
            color: #475569;
            background: #f8fafc;
            border-radius: 5px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            padding: 5px;
            position: relative;
            border: 2px solid transparent;
        }

        .calendar-day:hover {
            background: #f1f5f9;
        }

        .calendar-day.active {
            background: #4facfe;
            color: white;
        }

        .calendar-day.selected {
            background: #ff6b6b;
            color: white;
            border-color: #ff6b6b;
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .calendar-day.today {
            border-color: #ff6b6b;
        }

        .calendar-day.other-month {
            color: #cbd5e1;
        }

        .day-number {
            font-size: 16px;
            font-weight: 600;
        }

        .task-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin-top: 2px;
        }

        .indicator-overdue {
            background: #ff6b6b;
        }

        .indicator-today {
            background: #4ecdc4;
        }

        .indicator-future {
            background: #45aaf2;
        }

        .indicator-completed {
            background: #1dd1a1;
        }

        .indicator-pending-review {
            background: #ff9ff3;
        }

        .indicator-rejected {
            background: #ff9f43;
        }

        .indicator-needs-redo {
            background: #ff9f43;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #475569;
        }

        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 16px;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .hidden {
            display: none;
        }

        .checkin-history {
            margin-top: 10px;
        }

        .history-item {
            padding: 8px 12px;
            border-left: 3px solid #4facfe;
            background: #f8fafc;
            margin-bottom: 8px;
            border-radius: 0 8px 8px 0;
            font-size: 12px;
        }

        .history-date {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .history-status {
            font-size: 11px;
            color: #64748b;
        }

        .status-completed {
            color: #1dd1a1;
        }

        .status-pending {
            color: #feca57;
        }

        .status-missed {
            color: #ff6b6b;
        }

        .status-pending-review {
            color: #ff9ff3;
        }

        .status-needs-redo {
            color: #ff9f43;
        }

        footer {
            text-align: center;
            padding: 20px;
            color: #64748b;
            font-size: 14px;
            border-top: 1px solid #e2e8f0;
        }

        .task-form-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .audio-player {
            width: 100%;
            margin: 10px 0;
        }

        .recording-status {
            text-align: center;
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            font-weight: 600;
        }

        .status-recording {
            background: #fff5f5;
            color: #ff6b6b;
        }

        .status-playing {
            background: #f0fff4;
            color: #1dd1a1;
        }

        .last-recording-time {
            font-size: 12px;
            color: #64748b;
            margin-top: 5px;
        }

        .edit-task-form {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .compact-checkin-info {
            font-size: 12px;
            color: #64748b;
            margin-top: 5px;
        }

        .compact-checkin-item {
            display: inline-block;
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 5px;
            margin-bottom: 3px;
        }
        
        .data-management-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .data-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .data-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-card {
            background: #f8fafc;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            border-left: 4px solid #4facfe;
        }

        .stat-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: #4facfe;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #64748b;
        }

        .instructions-list {
            padding-left: 20px;
            margin-top: 10px;
        }

        .instructions-list li {
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        .modal-header h3 {
            margin: 0;
            color: #475569;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #64748b;
        }

        .close-btn:hover {
            color: #475569;
        }

        .modal-body {
            padding: 20px;
        }

        .data-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        .data-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .data-section h4 {
            margin-bottom: 10px;
            color: #475569;
        }

        .data-section p {
            margin-bottom: 15px;
            color: #64748b;
            font-size: 14px;
        }

        .data-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .stat-label {
            color: #64748b;
            font-size: 14px;
        }

        .stat-value {
            font-weight: 600;
            color: #475569;
        }

        .hidden {
            display: none !important;
        }

        .subject-chinese {
            color: #4facfe;
        }

        .subject-math {
            color: #764ba2;
        }

        .subject-english {
            color: #ff6b6b;
        }

        .subject-science {
            color: #1dd1a1;
        }

        .subject-other {
            color: #feca57;
        }

        .task-details-modal {
            max-width: 600px;
        }

        .checkin-progress {
            margin-top: 15px;
        }

        .checkin-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .checkin-day {
            font-weight: 600;
            width: 120px;
        }

        .checkin-status {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-icon {
            font-size: 16px;
        }

        .status-completed-icon {
            color: #1dd1a1;
        }

        .status-pending-icon {
            color: #feca57;
        }

        .status-missed-icon {
            color: #ff6b6b;
        }

        .status-needs-redo-icon {
            color: #ff9f43;
        }

        .today-tasks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .tasks-count {
            background: #4facfe;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .rejection-reason {
            font-size: 12px;
            color: #ff6b6b;
            margin-top: 5px;
            padding: 5px;
            background: #fff5f5;
            border-radius: 4px;
            border-left: 3px solid #ff6b6b;
        }

        .redo-notice {
            background: #fff9e6;
            border: 1px solid #ff9f43;
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
            font-size: 14px;
            width: 100%;
        }

        .redo-notice h4 {
            color: #ff9f43;
            margin-bottom: 5px;
        }

        .storage-warning {
            background: #fff5f5;
            border: 2px solid #ff6b6b;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }

        .storage-warning.high {
            background: #fff5f5;
            border-color: #ff6b6b;
            animation: pulse-warning 2s infinite;
        }

        .storage-warning.medium {
            background: #fff9e6;
            border-color: #feca57;
        }

        .storage-warning.low {
            background: #f0fff4;
            border-color: #1dd1a1;
        }

        @keyframes pulse-warning {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .storage-size {
            font-weight: 700;
            font-size: 18px;
            margin: 5px 0;
        }

        .storage-size.high {
            color: #ff6b6b;
        }

        .storage-size.medium {
            color: #feca57;
        }

        .storage-size.low {
            color: #1dd1a1;
        }

        .rejection-history {
            margin-top: 10px;
            padding: 10px;
            background: #f8fafc;
            border-radius: 6px;
        }

        .rejection-history-item {
            padding: 8px;
            margin-bottom: 5px;
            background: white;
            border-radius: 4px;
            border-left: 3px solid #ff9f43;
        }

        .rejection-date {
            font-size: 11px;
            color: #64748b;
        }

        .rejection-reason-text {
            font-size: 12px;
            color: #475569;
        }

        /* 新增样式 - 重做功能 */
        .redo-badge {
            background: #ff9f43;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            margin-left: 8px;
            font-weight: normal;
        }

        .redo-management {
            background: #fff9e6;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid #ff9f43;
        }

        .redo-management h4 {
            color: #ff9f43;
            margin-bottom: 10px;
        }

        .redo-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 3px solid #ff9f43;
        }

        .redo-info {
            flex: 1;
        }

        .redo-reason {
            font-size: 12px;
            color: #64748b;
            margin-top: 3px;
        }

        .redo-deadline {
            font-size: 11px;
            color: #ff6b6b;
            margin-top: 2px;
        }

        /* 自定义日期打卡 */
        .schedule-type-selector {
            display: flex;
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #cbd5e1;
        }
        
        .schedule-type {
            flex: 1;
            padding: 12px;
            text-align: center;
            background: #f8fafc;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .schedule-type.active {
            background: #4facfe;
            color: white;
        }
        
        .custom-schedule-container {
            margin-top: 15px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .daily-schedule-container {
            margin-top: 15px;
            padding: 15px;
            background: #f0f9ff;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .custom-date-input {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .custom-date-input label {
            width: 120px;
            margin-bottom: 0;
            margin-right: 10px;
        }
        
        .custom-date-input input {
            flex: 1;
        }
        
        .add-date-btn {
            background: #4facfe;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .custom-dates-list {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .custom-date-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: white;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 3px solid #4facfe;
        }
        
        .remove-date-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        /* 任务描述显示 */
        .task-description-display {
            background: #f8fafc;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #4facfe;
            white-space: pre-line;
        }

        .task-description-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #475569;
        }

        .task-description-content {
            color: #64748b;
            line-height: 1.5;
            white-space: pre-line;
        }

        /* 日历任务数量指示器 */
        .task-count-indicator {
            position: absolute;
            top: 2px;
            right: 2px;
            background: #ff6b6b;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .calendar-day {
            position: relative;
        }

        /* 每日打卡标识 */
        .daily-task-badge {
            display: inline-block;
            background: #4facfe;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            margin-left: 8px;
            font-weight: normal;
        }

        .daily-schedule-info {
            background: #f0f9ff;
            border-radius: 6px;
            padding: 10px;
            margin: 8px 0;
            border-left: 3px solid #4facfe;
        }

        .daily-schedule-dates {
            font-size: 12px;
            color: #64748b;
        }

        /* 频率选择器样式 */
        .frequency-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 8px;
        }

        .frequency-option {
            padding: 10px;
            text-align: center;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .frequency-option.active {
            background: #4facfe;
            color: white;
            border-color: #4facfe;
        }

        .frequency-option:hover {
            border-color: #4facfe;
        }

        /* 每周日期选择器 */
        .weekly-days-selector {
            margin-top: 10px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .weekdays {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }

        .weekday {
            flex: 1;
            padding: 8px;
            text-align: center;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .weekday.active {
            background: #4facfe;
            color: white;
            border-color: #4facfe;
        }

        .weekday:hover {
            border-color: #4facfe;
        }

        /* 频率显示标签 */
        .frequency-badge {
            display: inline-block;
            background: #4facfe;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            margin-left: 8px;
            font-weight: normal;
        }

        .daily-frequency-info {
            background: #f0f9ff;
            border-radius: 6px;
            padding: 8px;
            margin: 5px 0;
            font-size: 12px;
            color: #64748b;
        }

        /* 打卡方式选择器样式 */
        .checkin-type-selector {
            display: flex;
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #cbd5e1;
        }
        
        .checkin-type {
            flex: 1;
            padding: 12px;
            text-align: center;
            background: #f8fafc;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .checkin-type.active {
            background: #4facfe;
            color: white;
        }

        /* 拍照打卡样式 */
        .photo-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .photo-preview {
            width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-radius: 8px;
            margin: 15px 0;
            border: 2px dashed #cbd5e1;
        }

        .photo-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .photo-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .photo-btn-primary {
            background: #4facfe;
            color: white;
        }

        .photo-btn-primary:hover {
            background: #3a9bf7;
        }

        .photo-btn-secondary {
            background: #e2e8f0;
            color: #475569;
        }

        .photo-btn-secondary:hover {
            background: #cbd5e1;
        }

        .photo-btn-danger {
            background: #ff6b6b;
            color: white;
        }

        .photo-btn-danger:hover {
            background: #ff5252;
        }

        /* 实时预览样式 */
        .camera-preview {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            border-radius: 8px;
            margin: 15px 0;
            border: 2px solid #cbd5e1;
            background: #000;
        }

        .camera-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .camera-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .camera-btn-primary {
            background: #4facfe;
            color: white;
        }

        .camera-btn-primary:hover {
            background: #3a9bf7;
        }

        .camera-btn-secondary {
            background: #e2e8f0;
            color: #475569;
        }

        .camera-btn-secondary:hover {
            background: #cbd5e1;
        }

        .camera-btn-danger {
            background: #ff6b6b;
            color: white;
        }

        .camera-btn-danger:hover {
            background: #ff5252;
        }

        .camera-status {
            text-align: center;
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            font-weight: 600;
        }

        .status-camera-active {
            background: #f0fff4;
            color: #1dd1a1;
        }

        .status-camera-error {
            background: #fff5f5;
            color: #ff6b6b;
        }
        
        /* 第一天打卡次数设置 */
        .first-day-checkin-count {
            margin-top: 10px;
            padding: 10px;
            background: #f0f9ff;
            border-radius: 6px;
            border: 1px solid #cbd5e1;
        }
        
        .checkin-count-input {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 8px;
        }
        
        .checkin-count-input input {
            width: 80px;
        }
        
        .checkin-count-info {
            font-size: 12px;
            color: #64748b;
            margin-top: 5px;
        }
        
        /* 置顶标识 */
        .pinned-badge {
            display: inline-block;
            background: #ff9ff3;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            margin-left: 8px;
            font-weight: normal;
        }
        
        /* Excel导出按钮样式 */
        .btn-excel {
            background: #1dd1a1;
            color: white;
        }
        
        .btn-excel:hover {
            background: #10a17e;
        }
        
        /* 存储容量指示器 */
        .capacity-bar {
            height: 10px;
            background: #e2e8f0;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .capacity-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ecdc4, #45aaf2);
            border-radius: 5px;
            transition: width 0.5s;
        }
        
        .capacity-info {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #64748b;
        }
        
        .capacity-safe {
            color: #1dd1a1;
            font-weight: bold;
        }
        
        .capacity-warning {
            color: #feca57;
            font-weight: bold;
        }
        
        .capacity-danger {
            color: #ff6b6b;
            font-weight: bold;
        }
        
        /* 新增：录音管理按钮样式 */
        .btn-manage {
            background: #a29bfe;
            color: white;
        }
        
        .btn-manage:hover {
            background: #8c7ae6;
        }
        
        /* 录音管理模态框样式 */
        .recording-manage-modal {
            max-width: 800px;
        }
        
        .recordings-table-container {
            max-height: 400px;
            overflow-y: auto;
            margin: 15px 0;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        
        .recordings-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .recordings-table th {
            background: #f8fafc;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #475569;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 0;
        }
        
        .recordings-table td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .recordings-table tr:hover {
            background: #f8fafc;
        }
        
        .recording-size {
            font-family: monospace;
            font-size: 12px;
            color: #64748b;
        }
        
        .no-recordings {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }
        
        /* 删除确认样式 */
        .delete-confirm {
            background: #fff5f5;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #ff6b6b;
        }
        
        .delete-confirm h4 {
            color: #ff6b6b;
            margin-bottom: 10px;
        }
        
        .delete-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>复习打卡计划 - 安全存储版</h1>
            <p class="app-description">日积月累、持之以恒，数据安全存储</p>
        </header>

        <div class="tabs">
            <div class="tab active" data-tab="today">今日任务</div>
            <div class="tab" data-tab="tasks">任务管理</div>
            <div class="tab" data-tab="calendar">日历视图</div>
            <div class="tab" data-tab="checkin">打卡</div>
            <div class="tab" data-tab="data">数据管理</div>
        </div>

        <div class="tab-content active" id="today-tab">
            <div class="today-tasks-header">
                <h2>今日任务</h2>
                <div class="tasks-count" id="today-tasks-count">0/0 个任务</div>
            </div>
            <div class="task-list" id="today-tasks">
                <!-- 今日任务将通过JavaScript动态生成 -->
            </div>
        </div>

        <div class="tab-content" id="tasks-tab">
            <h2>任务管理</h2>
            
            <div id="task-form" class="task-form-container hidden">
                <h3>新建任务</h3>
                <div class="form-group">
                    <label for="task-subject">科目</label>
                    <select id="task-subject">
                        <option value="语文">语文</option>
                        <option value="英语">英语</option>
                        <option value="数学">数学</option>
                        <option value="科学">科学</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="task-name">任务名称</label>
                    <input type="text" id="task-name" placeholder="输入任务名称">
                </div>
                <div class="form-group">
                    <label for="task-desc">任务描述</label>
                    <textarea id="task-desc" placeholder="输入任务描述（可选）"></textarea>
                </div>
                <div class="form-group">
                    <label for="task-date">开始日期</label>
                    <input type="date" id="task-date">
                </div>
                
                <div class="form-group first-day-checkin-count">
                    <label for="first-day-count">第一天打卡次数</label>
                    <div class="checkin-count-input">
                        <input type="number" id="first-day-count" min="1" max="10" value="1" placeholder="1">
                        <span>次</span>
                    </div>
                    <div class="checkin-count-info">
                        设置第一天需要完成的打卡次数，后续每天只需打卡1次
                    </div>
                </div>
                
                <div class="form-group">
                    <label>打卡计划类型</label>
                    <div class="schedule-type-selector">
                        <div class="schedule-type active" data-type="default">默认计划</div>
                        <div class="schedule-type" data-type="daily">每日打卡</div>
                        <div class="schedule-type" data-type="custom">自定义日期</div>
                    </div>
                </div>
                
                <div id="default-schedule-info" class="custom-schedule-container">
                    <p><strong>默认打卡计划:</strong> 第1, 2, 3, 5, 8, 15, 30, 90, 180天打卡</p>
                </div>
                
                <div id="daily-schedule-container" class="daily-schedule-container hidden">
                    <p><strong>每日打卡设置:</strong> 设置任务的打卡频率和时间范围</p>
                    
                    <div class="form-group">
                        <label for="daily-start-date">开始日期</label>
                        <input type="date" id="daily-start-date">
                    </div>
                    
                    <div class="form-group">
                        <label for="daily-end-date">结束日期（可选）</label>
                        <input type="date" id="daily-end-date">
                        <small>如果不设置结束日期，任务将一直持续</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="daily-duration">任务持续天数（可选）</label>
                        <input type="number" id="daily-duration" min="1" max="365" placeholder="例如：30天">
                        <small>如果不设置结束日期，可以用持续天数</small>
                    </div>
                    
                    <div class="form-group">
                        <label>打卡频率</label>
                        <div class="frequency-selector">
                            <div class="frequency-option active" data-frequency="daily">每天</div>
                            <div class="frequency-option" data-frequency="2days">每2天</div>
                            <div class="frequency-option" data-frequency="3days">每3天</div>
                            <div class="frequency-option" data-frequency="weekly">每周</div>
                        </div>
                    </div>
                    
                    <div id="weekly-days-selector" class="weekly-days-selector hidden">
                        <label>选择每周打卡日</label>
                        <div class="weekdays">
                            <div class="weekday" data-day="0">日</div>
                            <div class="weekday" data-day="1">一</div>
                            <div class="weekday" data-day="2">二</div>
                            <div class="weekday" data-day="3">三</div>
                            <div class="weekday" data-day="4">四</div>
                            <div class="weekday" data-day="5">五</div>
                            <div class="weekday" data-day="6">六</div>
                        </div>
                    </div>
                </div>
                
                <div id="custom-schedule-container" class="custom-schedule-container hidden">
                    <p><strong>自定义打卡日期:</strong> 请添加具体的打卡日期</p>
                    
                    <div class="custom-date-input">
                        <label for="custom-date">打卡日期</label>
                        <input type="date" id="custom-date">
                    </div>
                    
                    <button class="add-date-btn" id="add-custom-date">添加日期</button>
                    
                    <div class="custom-dates-list" id="custom-dates-list">
                        <!-- 自定义日期列表将在这里动态生成 -->
                    </div>
                </div>
                
                <div class="task-actions">
                    <button class="btn btn-primary" id="save-task">保存任务</button>
                    <button class="btn btn-secondary" id="cancel-task">取消</button>
                </div>
            </div>

            <div id="edit-task-form" class="edit-task-form hidden">
                <h3>编辑任务</h3>
                <div class="form-group">
                    <label for="edit-task-subject">科目</label>
                    <select id="edit-task-subject">
                        <option value="语文">语文</option>
                        <option value="英语">英语</option>
                        <option value="数学">数学</option>
                        <option value="科学">科学</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-task-name">任务名称</label>
                    <input type="text" id="edit-task-name" placeholder="输入任务名称">
                </div>
                <div class="form-group">
                    <label for="edit-task-desc">任务描述</label>
                    <textarea id="edit-task-desc" placeholder="输入任务描述（可选）"></textarea>
                </div>
                <div class="task-actions">
                    <button class="btn btn-primary" id="update-task">更新任务</button>
                    <button class="btn btn-secondary" id="cancel-edit-task">取消</button>
                </div>
            </div>
            
            <button class="btn btn-primary" id="add-task-btn">新建任务</button>
            
            <div class="task-list" id="all-tasks">
                <!-- 所有任务将通过JavaScript动态生成 -->
            </div>
        </div>

        <div class="tab-content" id="calendar-tab">
            <h2>日历视图</h2>
            <div class="calendar-header">
                <div class="calendar-nav">
                    <button class="calendar-nav-btn" id="prev-month">←</button>
                    <button class="calendar-nav-btn" id="next-month">→</button>
                </div>
                <div class="calendar-title" id="calendar-title"></div>
                <button class="btn btn-secondary" id="today-btn">今天</button>
            </div>
            <div class="calendar" id="calendar">
                <!-- 日历将通过JavaScript动态生成 -->
            </div>
            <div class="checkin-history" id="selected-date-tasks">
                <!-- 选中日期的任务将通过JavaScript动态生成 -->
            </div>
        </div>

        <div class="tab-content" id="checkin-tab">
            <h2>打卡</h2>
            
            <div class="checkin-type-selector">
                <div class="checkin-type active" data-type="record">录音打卡</div>
                <div class="checkin-type" data-type="photo">拍照打卡</div>
            </div>
            
            <div class="recorder-container" id="record-container">
                <div class="recorder-header">
                    <h3 id="recorder-task-name">选择任务进行打卡</h3>
                    <p id="recorder-checkpoint">请先从今日任务中选择一个任务</p>
                </div>
                
                <div id="recorder-task-description" class="task-description-display hidden">
                    <div class="task-description-title">任务描述</div>
                    <div class="task-description-content" id="recorder-task-desc-content"></div>
                </div>
                
                <div class="recording-status hidden" id="recording-status"></div>
                
                <div class="recorder-display">
                    <div class="timer" id="timer">00:00:00</div>
                    <div class="waveform" id="waveform">
                        <!-- 波形图将通过JavaScript动态生成 -->
                    </div>
                </div>
                
                <div class="recorder-controls">
                    <button class="recorder-btn record-btn" id="record-btn" title="开始录音">
                        ●
                    </button>
                    <button class="recorder-btn pause-btn hidden" id="pause-btn" title="暂停">
                        ❚❚
                    </button>
                    <button class="recorder-btn stop-btn hidden" id="stop-btn" title="停止">
                        ■
                    </button>
                    <button class="recorder-btn play-btn hidden" id="play-btn" title="播放">
                        ▶
                    </button>
                </div>

                <audio id="audio-player" class="audio-player hidden" controls></audio>
                
                <div class="task-actions">
                    <button class="btn btn-primary" id="submit-recording" disabled>提交打卡</button>
                    <button class="btn btn-secondary" id="reset-recorder">重置</button>
                </div>
            </div>
            
            <div class="photo-container hidden" id="photo-container">
                <div class="recorder-header">
                    <h3 id="photo-task-name">选择任务进行打卡</h3>
                    <p id="photo-checkpoint">请先从今日任务中选择一个任务</p>
                </div>
                
                <div id="photo-task-description" class="task-description-display hidden">
                    <div class="task-description-title">任务描述</div>
                    <div class="task-description-content" id="photo-task-desc-content"></div>
                </div>
                
                <div class="camera-preview-container">
                    <video id="camera-preview" class="camera-preview hidden" autoplay playsinline></video>
                    <img id="photo-preview" class="photo-preview hidden" alt="照片预览">
                </div>
                
                <div class="camera-status hidden" id="camera-status"></div>
                
                <div class="camera-controls">
                    <button class="camera-btn camera-btn-primary" id="start-camera-btn">启动摄像头</button>
                    <button class="camera-btn camera-btn-primary" id="take-photo-btn" disabled>拍照</button>
                    <button class="camera-btn camera-btn-secondary" id="retake-photo-btn" disabled>重拍</button>
                    <button class="camera-btn camera-btn-danger" id="stop-camera-btn" disabled>关闭摄像头</button>
                </div>
                
                <div class="task-actions">
                    <button class="btn btn-primary" id="submit-photo" disabled>提交打卡</button>
                    <button class="btn btn-secondary" id="reset-photo">重置</button>
                </div>
            </div>
            
            <div class="recordings-list" id="recordings-list">
                <h3>今日打卡记录</h3>
                <!-- 打卡记录将通过JavaScript动态生成 -->
            </div>
        </div>

        <div class="tab-content" id="data-tab">
            <h2>数据管理</h2>
            
            <div class="data-management-container">
                <div class="data-card">
                    <h3>存储容量状态</h3>
                    <div class="capacity-bar">
                        <div class="capacity-fill" id="capacity-fill" style="width: 0%"></div>
                    </div>
                    <div class="capacity-info">
                        <span id="capacity-text">当前使用: 0 MB / 250 MB</span>
                        <span id="capacity-status" class="capacity-safe">安全</span>
                    </div>
                    <p>IndexedDB数据库可安全存储大量数据，不用担心数据被浏览器清理。</p>
                </div>
                
                <div class="data-card">
                    <h3>数据备份与恢复</h3>
                    <p>将数据导出为JSON文件进行备份，或从备份文件恢复数据。</p>
                    
                    <div class="data-actions">
                        <button class="btn btn-primary" id="show-data-modal">管理数据</button>
                        <button class="btn btn-excel" id="export-excel-btn">导出为Excel</button>
                        <button class="btn btn-manage" id="manage-recordings-btn">管理录音/照片</button>
                        <button class="btn btn-secondary" id="clear-data-btn">清除所有数据</button>
                    </div>
                </div>
                
                <div class="data-card">
                    <h3>数据统计</h3>
                    <div id="storage-warning" class="storage-warning hidden">
                        <h4>⚠️ 存储空间警告</h4>
                        <div class="storage-size" id="storage-size-display">0 MB</div>
                        <p id="storage-message">当前数据存储量正常</p>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">📝</div>
                            <div class="stat-number" id="stats-total-tasks">0</div>
                            <div class="stat-label">总任务数</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">✅</div>
                            <div class="stat-number" id="stats-completed-tasks">0</div>
                            <div class="stat-label">已完成</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">🎤</div>
                            <div class="stat-number" id="stats-total-recordings">0</div>
                            <div class="stat-label">今日录音</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">📷</div>
                            <div class="stat-number" id="stats-total-photos">0</div>
                            <div class="stat-label">今日照片</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">📊</div>
                            <div class="stat-number" id="stats-data-size">0 MB</div>
                            <div class="stat-label">数据大小</div>
                        </div>
                    </div>
                </div>
                
                <div class="data-card">
                    <h3>使用说明</h3>
                    <ol class="instructions-list">
                        <li><strong>安全存储:</strong> 所有数据使用IndexedDB存储，支持至少250MB数据，不会被浏览器自动清理</li>
                        <li>使用"导出数据"功能将数据保存为JSON文件作为备份</li>
                        <li>使用"导出为Excel"功能将任务数据导出为电子表格</li>
                        <li>使用"管理录音/照片"功能手动删除不需要的媒体文件以释放空间</li>
                        <li>在其他设备上使用"导入数据"功能恢复备份</li>
                        <li>注意：导入数据将覆盖当前设备上的所有数据</li>
                        <li>每个任务只保留最新一次打卡录音或照片</li>
                        <li>删除的任务会永久删除，不占用存储空间</li>
                        <li>打卡记录会在第二天自动清零，只保留今日记录</li>
                    </ol>
                </div>
            </div>
        </div>

        <footer>
            <p>复习打卡计划 - 安全存储版 &copy; 2023 - 使用IndexedDB安全存储，支持大量数据</p>
        </footer>
    </div>

    <!-- 数据管理模态框 -->
    <div id="data-management-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>数据管理</h3>
                <button class="close-btn" id="close-data-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="data-section">
                    <h4>存储容量</h4>
                    <div class="capacity-bar">
                        <div class="capacity-fill" id="modal-capacity-fill" style="width: 0%"></div>
                    </div>
                    <div class="capacity-info">
                        <span id="modal-capacity-text">当前使用: 0 MB / 250 MB</span>
                        <span id="modal-capacity-status" class="capacity-safe">安全</span>
                    </div>
                    <p>IndexedDB数据库可安全存储大量数据，不用担心数据被浏览器清理。</p>
                </div>
                
                <div class="data-section">
                    <h4>导出数据</h4>
                    <p>将您的任务和打卡记录导出为JSON文件，用于备份。</p>
                    <button class="btn btn-primary" id="export-data-btn">导出数据</button>
                </div>
                
                <div class="data-section">
                    <h4>导出为Excel</h4>
                    <p>将任务数据导出为Excel电子表格，方便查看和统计。</p>
                    <button class="btn btn-excel" id="export-excel-modal-btn">导出为Excel</button>
                </div>
                
                <div class="data-section">
                    <h4>导入数据</h4>
                    <p>从JSON文件导入任务和打卡记录，将覆盖当前设备上的所有数据。</p>
                    <input type="file" id="import-data-file" accept=".json" style="margin: 10px 0;">
                    <button class="btn btn-danger" id="import-data-btn" disabled>导入数据</button>
                </div>
                
                <div class="data-section">
                    <h4>数据统计</h4>
                    <div class="data-stats">
                        <div class="stat-item">
                            <span class="stat-label">任务总数:</span>
                            <span class="stat-value" id="stat-total-tasks">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">已完成任务:</span>
                            <span class="stat-value" id="stat-completed-tasks">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">今日录音:</span>
                            <span class="stat-value" id="stat-total-recordings">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">今日照片:</span>
                            <span class="stat-value" id="stat-total-photos">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">数据大小:</span>
                            <span class="stat-value" id="stat-data-size">0 MB</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 任务详情模态框 -->
    <div id="task-details-modal" class="modal hidden">
        <div class="modal-content task-details-modal">
            <div class="modal-header">
                <h3 id="task-details-title">任务详情</h3>
                <button class="close-btn" id="close-task-details">&times;</button>
            </div>
            <div class="modal-body">
                <div id="task-details-content">
                    <!-- 任务详情内容将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 重做管理模态框 -->
    <div id="redo-management-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>重做管理</h3>
                <button class="close-btn" id="close-redo-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="redo-management">
                    <h4>需要重做的打卡</h4>
                    <div id="redo-tasks-list">
                        <!-- 重做任务列表将在这里动态生成 -->
                    </div>
                </div>
                <div class="form-group">
                    <label for="redo-reason-input">重做原因</label>
                    <textarea id="redo-reason-input" placeholder="请输入要求重做的原因..."></textarea>
                </div>
                <div class="form-group">
                    <label for="redo-deadline-input">重做截止日期</label>
                    <input type="date" id="redo-deadline-input">
                </div>
                <div class="task-actions">
                    <button class="btn btn-warning" id="mark-redo-btn">标记为需要重做</button>
                    <button class="btn btn-secondary" id="cancel-redo-btn">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增：录音管理模态框 -->
    <div id="recordings-manage-modal" class="modal hidden">
        <div class="modal-content recording-manage-modal">
            <div class="modal-header">
                <h3>管理录音和照片</h3>
                <button class="close-btn" id="close-recordings-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="data-section">
                    <h4>存储空间概览</h4>
                    <div class="capacity-bar">
                        <div class="capacity-fill" id="manage-capacity-fill" style="width: 0%"></div>
                    </div>
                    <div class="capacity-info">
                        <span id="manage-capacity-text">当前使用: 0 MB / 250 MB</span>
                        <span id="manage-capacity-status" class="capacity-safe">安全</span>
                    </div>
                    <p>录音和照片占用大量存储空间，定期清理不需要的文件可以释放空间。</p>
                </div>
                
                <div class="data-section">
                    <h4>录音文件</h4>
                    <div class="recordings-table-container">
                        <table class="recordings-table" id="recordings-table">
                            <thead>
                                <tr>
                                    <th width="40">
                                        <input type="checkbox" id="select-all-recordings">
                                    </th>
                                    <th width="120">日期</th>
                                    <th>任务</th>
                                    <th width="80">类型</th>
                                    <th width="80">大小</th>
                                    <th width="60">操作</th>
                                </tr>
                            </thead>
                            <tbody id="recordings-table-body">
                                <!-- 录音列表将在这里动态生成 -->
                            </tbody>
                        </table>
                    </div>
                    <div id="no-recordings-message" class="no-recordings hidden">
                        <p>没有找到录音文件</p>
                    </div>
                </div>
                
                <div class="data-section">
                    <h4>照片文件</h4>
                    <div class="recordings-table-container">
                        <table class="recordings-table" id="photos-table">
                            <thead>
                                <tr>
                                    <th width="40">
                                        <input type="checkbox" id="select-all-photos">
                                    </th>
                                    <th width="120">日期</th>
                                    <th>任务</th>
                                    <th width="80">类型</th>
                                    <th width="80">大小</th>
                                    <th width="60">操作</th>
                                </tr>
                            </thead>
                            <tbody id="photos-table-body">
                                <!-- 照片列表将在这里动态生成 -->
                            </tbody>
                        </table>
                    </div>
                    <div id="no-photos-message" class="no-recordings hidden">
                        <p>没有找到照片文件</p>
                    </div>
                </div>
                
                <div class="data-section">
                    <h4>批量操作</h4>
                    <div class="delete-confirm" id="delete-confirm-section" style="display: none;">
                        <h4>⚠️ 确认删除</h4>
                        <p>您选择了 <span id="selected-count">0</span> 个文件，总共占用 <span id="selected-size">0 MB</span>。</p>
                        <p>删除后无法恢复，确定要删除吗？</p>
                        <div class="delete-actions">
                            <button class="btn btn-danger" id="confirm-delete-btn">确认删除</button>
                            <button class="btn btn-secondary" id="cancel-delete-btn">取消</button>
                        </div>
                    </div>
                    <div class="task-actions">
                        <button class="btn btn-danger" id="delete-selected-btn" disabled>删除选中项</button>
                        <button class="btn btn-warning" id="delete-old-btn">删除30天前的文件</button>
                        <button class="btn btn-secondary" id="close-manage-modal">完成</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 应用数据
        const appData = {
            tasks: [],
            recordings: [],
            photos: [],
            feedbacks: [],
            currentTask: null,
            currentRecording: null,
            currentPhoto: null,
            isRecording: false,
            isPaused: false,
            isPlaying: false,
            timerInterval: null,
            recordingTime: 0,
            mediaRecorder: null,
            audioChunks: [],
            audioContext: null,
            analyser: null,
            currentCalendarDate: new Date(),
            selectedCalendarDate: null,
            recordingState: null,
            editingTask: null,
            currentCheckpointIndex: null,
            currentCheckinType: 'record',
            customDates: [],
            currentScheduleType: 'default',
            currentFrequency: 'daily',
            selectedWeekdays: [1, 2, 3, 4, 5],
            cameraStream: null,
            isCameraActive: false,
            isRedo: false,
            redoTask: null,
            redoCheckpointIndex: null,
            // 新增：录音管理状态
            selectedRecordings: new Set(),
            selectedPhotos: new Set()
        };

        // 默认打卡时间表
        const checkinSchedule = [1, 2, 3, 5, 8, 15, 30, 90, 180];

        // IndexedDB存储管理 - 增强版
        class DataStorage {
            constructor() {
                this.dbName = 'CheckinAppDB';
                this.version = 8; // 增加版本号以支持新功能
                this.db = null;
            }

            async open() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        console.log('IndexedDB连接成功');
                        resolve(this.db);
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        
                        // 创建所有需要的对象存储
                        if (!db.objectStoreNames.contains('tasks')) {
                            const taskStore = db.createObjectStore('tasks', { keyPath: 'id' });
                            taskStore.createIndex('subject', 'subject', { unique: false });
                            taskStore.createIndex('status', 'status', { unique: false });
                            taskStore.createIndex('createDate', 'createDate', { unique: false });
                        }
                        
                        if (!db.objectStoreNames.contains('recordings')) {
                            const recordingStore = db.createObjectStore('recordings', { keyPath: 'id' });
                            recordingStore.createIndex('taskId', 'taskId', { unique: false });
                            recordingStore.createIndex('date', 'date', { unique: false });
                        }
                        
                        if (!db.objectStoreNames.contains('photos')) {
                            const photoStore = db.createObjectStore('photos', { keyPath: 'id' });
                            photoStore.createIndex('taskId', 'taskId', { unique: false });
                            photoStore.createIndex('date', 'date', { unique: false });
                        }
                        
                        if (!db.objectStoreNames.contains('feedbacks')) {
                            db.createObjectStore('feedbacks', { keyPath: 'id' });
                        }
                        
                        if (!db.objectStoreNames.contains('settings')) {
                            db.createObjectStore('settings', { keyPath: 'key' });
                        }
                        
                        if (!db.objectStoreNames.contains('app_state')) {
                            db.createObjectStore('app_state', { keyPath: 'key' });
                        }
                    };
                });
            }

            // 任务相关操作
            async saveTask(task) {
                if (!this.db) await this.open();
                return this.saveToStore('tasks', task);
            }

            async getTask(taskId) {
                if (!this.db) await this.open();
                return this.getFromStore('tasks', taskId);
            }

            async getAllTasks() {
                if (!this.db) await this.open();
                return this.getAllFromStore('tasks');
            }

            async saveAllTasks(tasks) {
                if (!this.db) await this.open();
                return this.saveAllToStore('tasks', tasks);
            }

            async deleteTask(taskId) {
                if (!this.db) await this.open();
                return this.deleteFromStore('tasks', taskId);
            }

            // 录音相关操作
            async saveRecording(recording) {
                if (!this.db) await this.open();
                return this.saveToStore('recordings', recording);
            }

            async getRecording(recordingId) {
                if (!this.db) await this.open();
                return this.getFromStore('recordings', recordingId);
            }

            async getRecordingsByTask(taskId) {
                if (!this.db) await this.open();
                const recordings = await this.getAllFromStore('recordings');
                return recordings.filter(r => r.taskId === taskId);
            }

            async getTodayRecordings() {
                if (!this.db) await this.open();
                const recordings = await this.getAllFromStore('recordings');
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                
                return recordings.filter(r => {
                    const recordDate = new Date(r.date);
                    recordDate.setHours(0, 0, 0, 0);
                    return recordDate >= today && recordDate < tomorrow;
                });
            }

            async getAllRecordings() {
                if (!this.db) await this.open();
                return this.getAllFromStore('recordings');
            }

            async deleteRecording(recordingId) {
                if (!this.db) await this.open();
                return this.deleteFromStore('recordings', recordingId);
            }

            async deleteMultipleRecordings(recordingIds) {
                if (!this.db) await this.open();
                
                const transaction = this.db.transaction(['recordings'], 'readwrite');
                const store = transaction.objectStore('recordings');
                
                const promises = recordingIds.map(id => {
                    return new Promise((resolve, reject) => {
                        const request = store.delete(id);
                        request.onsuccess = () => resolve();
                        request.onerror = () => reject(request.error);
                    });
                });
                
                return Promise.all(promises);
            }

            // 照片相关操作
            async savePhoto(photo) {
                if (!this.db) await this.open();
                return this.saveToStore('photos', photo);
            }

            async getPhoto(photoId) {
                if (!this.db) await this.open();
                return this.getFromStore('photos', photoId);
            }

            async getPhotosByTask(taskId) {
                if (!this.db) await this.open();
                const photos = await this.getAllFromStore('photos');
                return photos.filter(p => p.taskId === taskId);
            }

            async getTodayPhotos() {
                if (!this.db) await this.open();
                const photos = await this.getAllFromStore('photos');
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                
                return photos.filter(p => {
                    const photoDate = new Date(p.date);
                    photoDate.setHours(0, 0, 0, 0);
                    return photoDate >= today && photoDate < tomorrow;
                });
            }

            async getAllPhotos() {
                if (!this.db) await this.open();
                return this.getAllFromStore('photos');
            }

            async deletePhoto(photoId) {
                if (!this.db) await this.open();
                return this.deleteFromStore('photos', photoId);
            }

            async deleteMultiplePhotos(photoIds) {
                if (!this.db) await this.open();
                
                const transaction = this.db.transaction(['photos'], 'readwrite');
                const store = transaction.objectStore('photos');
                
                const promises = photoIds.map(id => {
                    return new Promise((resolve, reject) => {
                        const request = store.delete(id);
                        request.onsuccess = () => resolve();
                        request.onerror = () => reject(request.error);
                    });
                });
                
                return Promise.all(promises);
            }

            // 通用存储方法
            async saveToStore(storeName, data) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.put(data);
                    
                    request.onsuccess = () => resolve(data.id);
                    request.onerror = () => reject(request.error);
                });
            }

            async getFromStore(storeName, key) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.get(key);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async getAllFromStore(storeName) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.getAll();
                    
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = () => reject(request.error);
                });
            }

            async deleteFromStore(storeName, key) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.delete(key);
                    
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }

            // 批量操作
            async saveAllToStore(storeName, items) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    
                    // 先清空
                    const clearRequest = store.clear();
                    
                    clearRequest.onsuccess = () => {
                        const promises = items.map(item => {
                            return new Promise((res, rej) => {
                                const request = store.put(item);
                                request.onsuccess = () => res();
                                request.onerror = () => rej(request.error);
                            });
                        });
                        
                        Promise.all(promises).then(resolve).catch(reject);
                    };
                    
                    clearRequest.onerror = () => reject(clearRequest.error);
                });
            }

            // 应用设置
            async saveSetting(key, value) {
                if (!this.db) await this.open();
                return this.saveToStore('settings', { key, value });
            }

            async getSetting(key) {
                if (!this.db) await this.open();
                const setting = await this.getFromStore('settings', key);
                return setting ? setting.value : null;
            }

            // 清理旧数据（保留最近30天）
            async cleanupOldData() {
                if (!this.db) await this.open();
                
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                // 清理录音
                await this.cleanupStoreByDate('recordings', thirtyDaysAgo);
                
                // 清理照片
                await this.cleanupStoreByDate('photos', thirtyDaysAgo);
                
                console.log('旧数据清理完成');
            }

            async cleanupStoreByDate(storeName, cutoffDate) {
                const items = await this.getAllFromStore(storeName);
                const oldItems = items.filter(item => {
                    const itemDate = new Date(item.date);
                    return itemDate < cutoffDate;
                });
                
                for (const item of oldItems) {
                    await this.deleteFromStore(storeName, item.id);
                }
            }

            // 获取存储统计信息
            async getStorageStats() {
                if (!this.db) await this.open();
                
                const tasks = await this.getAllTasks();
                const recordings = await this.getAllRecordings();
                const photos = await this.getAllPhotos();
                
                let totalSize = 0;
                
                // 计算录音数据大小
                recordings.forEach(recording => {
                    if (recording.audioData) {
                        const base64Length = recording.audioData.length - (recording.audioData.indexOf(',') + 1);
                        totalSize += Math.floor(base64Length * 3 / 4);
                    }
                });
                
                // 计算照片数据大小
                photos.forEach(photo => {
                    if (photo.imageData) {
                        const base64Length = photo.imageData.length - (photo.imageData.indexOf(',') + 1);
                        totalSize += Math.floor(base64Length * 3 / 4);
                    }
                });
                
                // 任务和设置数据大小
                const tasksJson = JSON.stringify(tasks);
                totalSize += tasksJson.length;
                
                const totalSizeMB = totalSize / (1024 * 1024);
                const maxCapacityMB = 250; // IndexedDB通常支持250MB以上
                const usagePercent = Math.min((totalSizeMB / maxCapacityMB) * 100, 100);
                
                return {
                    tasksCount: tasks.length,
                    recordingsCount: recordings.length,
                    photosCount: photos.length,
                    totalSize: totalSize,
                    totalSizeMB: totalSizeMB.toFixed(2),
                    maxCapacityMB: maxCapacityMB,
                    usagePercent: usagePercent.toFixed(1),
                    estimatedMaxCapacity: maxCapacityMB
                };
            }

            // 清空所有数据
            async clearAllData() {
                if (!this.db) await this.open();
                
                const stores = ['tasks', 'recordings', 'photos', 'feedbacks', 'settings', 'app_state'];
                
                for (const storeName of stores) {
                    try {
                        const transaction = this.db.transaction([storeName], 'readwrite');
                        const store = transaction.objectStore(storeName);
                        await new Promise((resolve, reject) => {
                            const request = store.clear();
                            request.onsuccess = () => resolve();
                            request.onerror = () => reject(request.error);
                        });
                    } catch (error) {
                        console.error(`清空${storeName}失败:`, error);
                    }
                }
                
                console.log('所有数据已清空');
            }
        }

        // 初始化存储实例
        const dataStorage = new DataStorage();

        // DOM 元素
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const todayTasksEl = document.getElementById('today-tasks');
        const todayTasksCountEl = document.getElementById('today-tasks-count');
        const allTasksEl = document.getElementById('all-tasks');
        const taskFormEl = document.getElementById('task-form');
        const editTaskFormEl = document.getElementById('edit-task-form');
        const addTaskBtn = document.getElementById('add-task-btn');
        const saveTaskBtn = document.getElementById('save-task');
        const cancelTaskBtn = document.getElementById('cancel-task');
        const updateTaskBtn = document.getElementById('update-task');
        const cancelEditTaskBtn = document.getElementById('cancel-edit-task');
        const calendarEl = document.getElementById('calendar');
        const calendarTitleEl = document.getElementById('calendar-title');
        const prevMonthBtn = document.getElementById('prev-month');
        const nextMonthBtn = document.getElementById('next-month');
        const todayBtn = document.getElementById('today-btn');
        const selectedDateTasksEl = document.getElementById('selected-date-tasks');
        
        // 打卡相关元素
        const checkinTypeSelectors = document.querySelectorAll('.checkin-type');
        const recordContainer = document.getElementById('record-container');
        const photoContainer = document.getElementById('photo-container');
        
        // 录音打卡元素
        const recorderTaskNameEl = document.getElementById('recorder-task-name');
        const recorderCheckpointEl = document.getElementById('recorder-checkpoint');
        const recordingStatusEl = document.getElementById('recording-status');
        const timerEl = document.getElementById('timer');
        const waveformEl = document.getElementById('waveform');
        const recordBtn = document.getElementById('record-btn');
        const pauseBtn = document.getElementById('pause-btn');
        const stopBtn = document.getElementById('stop-btn');
        const playBtn = document.getElementById('play-btn');
        const audioPlayer = document.getElementById('audio-player');
        const submitRecordingBtn = document.getElementById('submit-recording');
        const resetRecorderBtn = document.getElementById('reset-recorder');
        
        // 拍照打卡元素
        const photoTaskNameEl = document.getElementById('photo-task-name');
        const photoCheckpointEl = document.getElementById('photo-checkpoint');
        const cameraPreview = document.getElementById('camera-preview');
        const photoPreview = document.getElementById('photo-preview');
        const cameraStatusEl = document.getElementById('camera-status');
        const startCameraBtn = document.getElementById('start-camera-btn');
        const takePhotoBtn = document.getElementById('take-photo-btn');
        const retakePhotoBtn = document.getElementById('retake-photo-btn');
        const stopCameraBtn = document.getElementById('stop-camera-btn');
        const submitPhotoBtn = document.getElementById('submit-photo');
        const resetPhotoBtn = document.getElementById('reset-photo');
        
        // 任务描述显示元素
        const recorderTaskDescriptionEl = document.getElementById('recorder-task-description');
        const recorderTaskDescContentEl = document.getElementById('recorder-task-desc-content');
        const photoTaskDescriptionEl = document.getElementById('photo-task-description');
        const photoTaskDescContentEl = document.getElementById('photo-task-desc-content');
        
        const recordingsListEl = document.getElementById('recordings-list');

        const dataManagementModal = document.getElementById('data-management-modal');
        const closeDataModalBtn = document.getElementById('close-data-modal');
        const showDataModalBtn = document.getElementById('show-data-modal');
        const exportDataBtn = document.getElementById('export-data-btn');
        const exportExcelBtn = document.getElementById('export-excel-btn');
        const exportExcelModalBtn = document.getElementById('export-excel-modal-btn');
        const importDataFile = document.getElementById('import-data-file');
        const importDataBtn = document.getElementById('import-data-btn');
        const clearDataBtn = document.getElementById('clear-data-btn');

        const taskDetailsModal = document.getElementById('task-details-modal');
        const taskDetailsTitle = document.getElementById('task-details-title');
        const taskDetailsContent = document.getElementById('task-details-content');
        const closeTaskDetailsBtn = document.getElementById('close-task-details');

        // 重做管理模态框元素
        const redoManagementModal = document.getElementById('redo-management-modal');
        const closeRedoModalBtn = document.getElementById('close-redo-modal');
        const redoTasksList = document.getElementById('redo-tasks-list');
        const redoReasonInput = document.getElementById('redo-reason-input');
        const redoDeadlineInput = document.getElementById('redo-deadline-input');
        const markRedoBtn = document.getElementById('mark-redo-btn');
        const cancelRedoBtn = document.getElementById('cancel-redo-btn');

        // 存储容量显示元素
        const capacityFillEl = document.getElementById('capacity-fill');
        const capacityTextEl = document.getElementById('capacity-text');
        const capacityStatusEl = document.getElementById('capacity-status');
        const modalCapacityFillEl = document.getElementById('modal-capacity-fill');
        const modalCapacityTextEl = document.getElementById('modal-capacity-text');
        const modalCapacityStatusEl = document.getElementById('modal-capacity-status');

        // 新增：自定义日期相关元素
        const scheduleTypeSelectors = document.querySelectorAll('.schedule-type');
        const defaultScheduleInfo = document.getElementById('default-schedule-info');
        const dailyScheduleContainer = document.getElementById('daily-schedule-container');
        const customScheduleContainer = document.getElementById('custom-schedule-container');
        const customDateInput = document.getElementById('custom-date');
        const addCustomDateBtn = document.getElementById('add-custom-date');
        const customDatesList = document.getElementById('custom-dates-list');
        
        // 新增：每日打卡相关元素
        const dailyStartDateInput = document.getElementById('daily-start-date');
        const dailyEndDateInput = document.getElementById('daily-end-date');
        const dailyDurationInput = document.getElementById('daily-duration');
        
        // 新增：存储警告相关元素
        const storageWarningEl = document.getElementById('storage-warning');
        const storageSizeDisplayEl = document.getElementById('storage-size-display');
        const storageMessageEl = document.getElementById('storage-message');
        
        // 新增：录音管理相关元素
        const manageRecordingsBtn = document.getElementById('manage-recordings-btn');
        const recordingsManageModal = document.getElementById('recordings-manage-modal');
        const closeRecordingsModalBtn = document.getElementById('close-recordings-modal');
        const closeManageModalBtn = document.getElementById('close-manage-modal');
        const recordingsTableBody = document.getElementById('recordings-table-body');
        const photosTableBody = document.getElementById('photos-table-body');
        const selectAllRecordingsBtn = document.getElementById('select-all-recordings');
        const selectAllPhotosBtn = document.getElementById('select-all-photos');
        const deleteSelectedBtn = document.getElementById('delete-selected-btn');
        const deleteOldBtn = document.getElementById('delete-old-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const deleteConfirmSection = document.getElementById('delete-confirm-section');
        const selectedCountEl = document.getElementById('selected-count');
        const selectedSizeEl = document.getElementById('selected-size');
        const noRecordingsMessage = document.getElementById('no-recordings-message');
        const noPhotosMessage = document.getElementById('no-photos-message');
        const manageCapacityFillEl = document.getElementById('manage-capacity-fill');
        const manageCapacityTextEl = document.getElementById('manage-capacity-text');
        const manageCapacityStatusEl = document.getElementById('manage-capacity-status');

        // 初始化应用
        async function initApp() {
            console.log('初始化应用...');
            
            await loadLocalData();
            setupEventListeners();
            setupCheckinEventListeners();
            setupDataManagementEventListeners();
            setupTaskDetailsEventListeners();
            setupCustomDateEventListeners();
            setupRedoEventListeners();
            setupRecordingsManageEventListeners(); // 新增：录音管理事件监听
            
            restoreRecordingUrls();
            
            renderTodayTasks();
            renderAllTasks();
            renderCalendar();
            renderRecordings();
            renderDataStats();
            
            // 设置默认日期
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('task-date').value = today;
            dailyStartDateInput.value = today;
            
            console.log('应用初始化完成');
        }

        // 从IndexedDB加载数据
        async function loadLocalData() {
            try {
                console.log('从IndexedDB加载数据...');
                
                // 从IndexedDB加载任务
                appData.tasks = await dataStorage.getAllTasks();
                
                // 从IndexedDB加载今日打卡记录
                appData.recordings = await dataStorage.getTodayRecordings();
                appData.photos = await dataStorage.getTodayPhotos();
                
                // 加载设置和状态
                const lastCleanupDate = await dataStorage.getSetting('lastCleanupDate');
                const today = new Date().toDateString();
                
                if (lastCleanupDate !== today) {
                    // 执行每日清理
                    await dataStorage.cleanupOldData();
                    await dataStorage.saveSetting('lastCleanupDate', today);
                }
                
                // 如果没有任务，使用默认任务
                if (appData.tasks.length === 0) {
                    console.log('没有找到任务，使用默认任务');
                    appData.tasks = getDefaultTasks();
                    await dataStorage.saveAllTasks(appData.tasks);
                }
                
                // 加载反馈
                appData.feedbacks = await dataStorage.getAllFromStore('feedbacks');
                
                console.log('数据加载完成:', {
                    tasks: appData.tasks.length,
                    recordings: appData.recordings.length,
                    photos: appData.photos.length
                });
                
            } catch (error) {
                console.error('从IndexedDB加载数据失败:', error);
                
                // 降级到默认数据
                console.log('使用默认数据');
                appData.tasks = getDefaultTasks();
                appData.recordings = [];
                appData.photos = [];
                appData.feedbacks = [];
            }
        }

        // 获取默认任务
        function getDefaultTasks() {
            return [
                {
                    id: Date.now(),
                    subject: '英语',
                    name: '学习英语',
                    description: '每天学习30分钟英语，包括单词记忆、语法练习和听力训练',
                    createDate: new Date().toISOString(),
                    status: 'active',
                    checkins: [],
                    scheduleType: 'default',
                    firstDayCheckinCount: 1,
                    pinned: false
                },
                {
                    id: Date.now() + 1,
                    subject: '数学',
                    name: '数学练习',
                    description: '每天完成10道数学题，巩固基础知识',
                    createDate: new Date().toISOString(),
                    status: 'active',
                    checkins: [],
                    scheduleType: 'default',
                    firstDayCheckinCount: 1,
                    pinned: false
                }
            ];
        }

        // 保存任务数据到IndexedDB
        async function saveTasks() {
            try {
                console.log('保存任务数据到IndexedDB...');
                await dataStorage.saveAllTasks(appData.tasks);
                console.log('任务数据保存成功');
            } catch (e) {
                console.error('保存任务数据失败:', e);
            }
        }

        // 设置事件监听器
        function setupEventListeners() {
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });

            addTaskBtn.addEventListener('click', showTaskForm);
            saveTaskBtn.addEventListener('click', saveNewTask);
            cancelTaskBtn.addEventListener('click', hideTaskForm);
            updateTaskBtn.addEventListener('click', updateTask);
            cancelEditTaskBtn.addEventListener('click', hideEditTaskForm);

            prevMonthBtn.addEventListener('click', () => navigateCalendar(-1));
            nextMonthBtn.addEventListener('click', () => navigateCalendar(1));
            todayBtn.addEventListener('click', goToToday);
        }

        // 设置数据管理事件监听器
        function setupDataManagementEventListeners() {
            showDataModalBtn.addEventListener('click', showDataManagementModal);
            closeDataModalBtn.addEventListener('click', hideDataManagementModal);
            exportDataBtn.addEventListener('click', exportData);
            exportExcelBtn.addEventListener('click', exportToExcel);
            exportExcelModalBtn.addEventListener('click', exportToExcel);
            importDataFile.addEventListener('change', handleImportFileSelect);
            importDataBtn.addEventListener('click', importData);
            clearDataBtn.addEventListener('click', clearAllData);
        }

        // 新增：设置录音管理事件监听器
        function setupRecordingsManageEventListeners() {
            manageRecordingsBtn.addEventListener('click', showRecordingsManageModal);
            closeRecordingsModalBtn.addEventListener('click', hideRecordingsManageModal);
            closeManageModalBtn.addEventListener('click', hideRecordingsManageModal);
            
            selectAllRecordingsBtn.addEventListener('change', (e) => {
                const isChecked = e.target.checked;
                document.querySelectorAll('.recording-checkbox').forEach(cb => {
                    cb.checked = isChecked;
                    const recordingId = parseInt(cb.dataset.id);
                    if (isChecked) {
                        appData.selectedRecordings.add(recordingId);
                    } else {
                        appData.selectedRecordings.delete(recordingId);
                    }
                });
                updateDeleteButtonState();
            });
            
            selectAllPhotosBtn.addEventListener('change', (e) => {
                const isChecked = e.target.checked;
                document.querySelectorAll('.photo-checkbox').forEach(cb => {
                    cb.checked = isChecked;
                    const photoId = parseInt(cb.dataset.id);
                    if (isChecked) {
                        appData.selectedPhotos.add(photoId);
                    } else {
                        appData.selectedPhotos.delete(photoId);
                    }
                });
                updateDeleteButtonState();
            });
            
            deleteSelectedBtn.addEventListener('click', showDeleteConfirm);
            deleteOldBtn.addEventListener('click', deleteOldRecordings);
            confirmDeleteBtn.addEventListener('click', deleteSelectedItems);
            cancelDeleteBtn.addEventListener('click', hideDeleteConfirm);
        }

        // 设置任务详情事件监听器
        function setupTaskDetailsEventListeners() {
            closeTaskDetailsBtn.addEventListener('click', hideTaskDetails);
        }

        // 设置重做事件监听
        function setupRedoEventListeners() {
            closeRedoModalBtn.addEventListener('click', hideRedoManagementModal);
            markRedoBtn.addEventListener('click', markForRedo);
            cancelRedoBtn.addEventListener('click', hideRedoManagementModal);
            
            // 设置默认重做截止日期为7天后
            const defaultDeadline = new Date();
            defaultDeadline.setDate(defaultDeadline.getDate() + 7);
            redoDeadlineInput.valueAsDate = defaultDeadline;
        }

        // 设置自定义日期事件监听
        function setupCustomDateEventListeners() {
            scheduleTypeSelectors.forEach(type => {
                type.addEventListener('click', () => {
                    const scheduleType = type.getAttribute('data-type');
                    switchScheduleType(scheduleType);
                });
            });
            
            addCustomDateBtn.addEventListener('click', addCustomDate);
            
            // 频率选择事件
            document.querySelectorAll('.frequency-option').forEach(option => {
                option.addEventListener('click', () => {
                    const frequency = option.getAttribute('data-frequency');
                    switchFrequency(frequency);
                });
            });
            
            // 周日期选择事件
            document.querySelectorAll('.weekday').forEach(day => {
                day.addEventListener('click', () => {
                    const dayIndex = parseInt(day.getAttribute('data-day'));
                    toggleWeekday(dayIndex);
                });
            });
        }

        // 设置打卡事件监听
        function setupCheckinEventListeners() {
            checkinTypeSelectors.forEach(type => {
                type.addEventListener('click', () => {
                    const checkinType = type.getAttribute('data-type');
                    switchCheckinType(checkinType);
                });
            });
            
            // 录音打卡事件
            recordBtn.addEventListener('click', startRecording);
            pauseBtn.addEventListener('click', togglePause);
            stopBtn.addEventListener('click', stopRecording);
            playBtn.addEventListener('click', playRecording);
            submitRecordingBtn.addEventListener('click', submitRecording);
            resetRecorderBtn.addEventListener('click', resetRecorder);
            
            // 拍照打卡事件
            startCameraBtn.addEventListener('click', startCamera);
            takePhotoBtn.addEventListener('click', takePhoto);
            retakePhotoBtn.addEventListener('click', retakePhoto);
            stopCameraBtn.addEventListener('click', stopCamera);
            submitPhotoBtn.addEventListener('click', submitPhoto);
            resetPhotoBtn.addEventListener('click', resetPhoto);
        }

        // 切换标签页
        function switchTab(tabId) {
            tabs.forEach(tab => {
                if (tab.getAttribute('data-tab') === tabId) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            tabContents.forEach(content => {
                if (content.id === `${tabId}-tab`) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });

            if (tabId === 'today') {
                renderTodayTasks();
            } else if (tabId === 'tasks') {
                renderAllTasks();
            } else if (tabId === 'calendar') {
                renderCalendar();
            } else if (tabId === 'checkin') {
                renderRecordings();
            } else if (tabId === 'data') {
                renderDataStats();
            }
        }

        // 显示任务表单
        function showTaskForm() {
            taskFormEl.classList.remove('hidden');
            hideEditTaskForm();
            document.getElementById('task-subject').value = '语文';
            document.getElementById('task-name').value = '';
            document.getElementById('task-desc').value = '';
            document.getElementById('task-date').valueAsDate = new Date();
            
            // 设置默认第一天打卡次数
            document.getElementById('first-day-count').value = 1;
            
            switchScheduleType('default');
            appData.customDates = [];
            renderCustomDatesList();
            
            // 初始化频率设置
            switchFrequency('daily');
            renderWeekdaySelector();
            
            taskFormEl.scrollIntoView({ behavior: 'smooth' });
        }

        // 隐藏任务表单
        function hideTaskForm() {
            taskFormEl.classList.add('hidden');
        }

        // 显示编辑任务表单
        function showEditTaskForm(taskId) {
            const task = appData.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            appData.editingTask = task;
            editTaskFormEl.classList.remove('hidden');
            hideTaskForm();
            
            document.getElementById('edit-task-subject').value = task.subject;
            document.getElementById('edit-task-name').value = task.name;
            document.getElementById('edit-task-desc').value = task.description || '';
            editTaskFormEl.scrollIntoView({ behavior: 'smooth' });
        }

        // 隐藏编辑任务表单
        function hideEditTaskForm() {
            editTaskFormEl.classList.add('hidden');
            appData.editingTask = null;
        }

        // 保存新任务
        async function saveNewTask() {
            const subject = document.getElementById('task-subject').value;
            const name = document.getElementById('task-name').value.trim();
            const desc = document.getElementById('task-desc').value.trim();
            let date = document.getElementById('task-date').value;
            const firstDayCount = parseInt(document.getElementById('first-day-count').value) || 1;
            
            if (!name) {
                alert('请输入任务名称');
                return;
            }
            
            if (!date) {
                date = new Date().toISOString().split('T')[0];
            }
            
            const newTask = {
                id: Date.now(),
                subject: subject,
                name: name,
                description: desc,
                createDate: date ? new Date(date).toISOString() : new Date().toISOString(),
                status: 'active',
                checkins: [],
                scheduleType: appData.currentScheduleType,
                firstDayCheckinCount: Math.max(1, Math.min(firstDayCount, 10)),
                pinned: false
            };
            
            // 处理不同类型的打卡计划
            if (appData.currentScheduleType === 'daily') {
                const startDate = dailyStartDateInput.value;
                const endDate = dailyEndDateInput.value;
                const duration = dailyDurationInput.value;
                
                newTask.dailyStartDate = startDate || new Date().toISOString().split('T')[0];
                if (endDate) newTask.dailyEndDate = endDate;
                if (duration) newTask.dailyDuration = parseInt(duration);
                
                // 保存频率设置
                newTask.dailyFrequency = appData.currentFrequency;
                if (appData.currentFrequency === 'weekly') {
                    newTask.selectedWeekdays = [...appData.selectedWeekdays];
                }
                
            } else if (appData.currentScheduleType === 'custom') {
                if (appData.customDates.length === 0) {
                    alert('请至少添加一个自定义打卡日期');
                    return;
                }
                newTask.customDates = [...appData.customDates];
            }
            
            appData.tasks.push(newTask);
            await saveTasks();
            hideTaskForm();
            
            appData.customDates = [];
            renderCustomDatesList();
            
            renderAllTasks();
            renderTodayTasks();
            renderCalendar();
            renderDataStats();
            
            alert('任务创建成功！');
        }

        // 更新任务
        async function updateTask() {
            if (!appData.editingTask) return;
            
            const subject = document.getElementById('edit-task-subject').value;
            const name = document.getElementById('edit-task-name').value.trim();
            const desc = document.getElementById('edit-task-desc').value.trim();
            
            if (!name) {
                alert('请输入任务名称');
                return;
            }
            
            appData.editingTask.subject = subject;
            appData.editingTask.name = name;
            appData.editingTask.description = desc;
            
            await saveTasks();
            hideEditTaskForm();
            renderAllTasks();
            renderTodayTasks();
            renderCalendar();
            renderDataStats();
            
            alert('任务更新成功！');
        }

        // 切换打卡计划类型
        function switchScheduleType(type) {
            appData.currentScheduleType = type;
            
            scheduleTypeSelectors.forEach(t => {
                if (t.getAttribute('data-type') === type) {
                    t.classList.add('active');
                } else {
                    t.classList.remove('active');
                }
            });
            
            // 隐藏所有容器
            defaultScheduleInfo.classList.add('hidden');
            dailyScheduleContainer.classList.add('hidden');
            customScheduleContainer.classList.add('hidden');
            
            // 显示对应的容器
            if (type === 'default') {
                defaultScheduleInfo.classList.remove('hidden');
            } else if (type === 'daily') {
                dailyScheduleContainer.classList.remove('hidden');
            } else if (type === 'custom') {
                customScheduleContainer.classList.remove('hidden');
            }
        }

        // 切换频率
        function switchFrequency(frequency) {
            appData.currentFrequency = frequency;
            
            document.querySelectorAll('.frequency-option').forEach(option => {
                if (option.getAttribute('data-frequency') === frequency) {
                    option.classList.add('active');
                } else {
                    option.classList.remove('active');
                }
            });
            
            // 显示/隐藏周日期选择器
            const weeklySelector = document.getElementById('weekly-days-selector');
            if (frequency === 'weekly') {
                weeklySelector.classList.remove('hidden');
                renderWeekdaySelector();
            } else {
                weeklySelector.classList.add('hidden');
            }
        }

        // 渲染周日期选择器
        function renderWeekdaySelector() {
            document.querySelectorAll('.weekday').forEach(day => {
                const dayIndex = parseInt(day.getAttribute('data-day'));
                if (appData.selectedWeekdays.includes(dayIndex)) {
                    day.classList.add('active');
                } else {
                    day.classList.remove('active');
                }
            });
        }

        // 切换周日期选择
        function toggleWeekday(dayIndex) {
            const index = appData.selectedWeekdays.indexOf(dayIndex);
            if (index === -1) {
                appData.selectedWeekdays.push(dayIndex);
            } else {
                appData.selectedWeekdays.splice(index, 1);
            }
            appData.selectedWeekdays.sort((a, b) => a - b);
            renderWeekdaySelector();
        }

        // 添加自定义日期
        function addCustomDate() {
            const dateValue = customDateInput.value;
            if (!dateValue) {
                alert('请选择日期');
                return;
            }
            
            const selectedDate = new Date(dateValue);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (selectedDate < today) {
                alert('不能选择过去的日期');
                return;
            }
            
            const dateExists = appData.customDates.some(date => 
                new Date(date).getTime() === selectedDate.getTime()
            );
            
            if (dateExists) {
                alert('该日期已存在');
                return;
            }
            
            appData.customDates.push(selectedDate.toISOString());
            renderCustomDatesList();
            customDateInput.value = '';
        }

        // 渲染自定义日期列表
        function renderCustomDatesList() {
            customDatesList.innerHTML = '';
            
            if (appData.customDates.length === 0) {
                customDatesList.innerHTML = '<p style="text-align: center; color: #64748b; padding: 10px;">暂无自定义日期</p>';
                return;
            }
            
            const sortedDates = [...appData.customDates].sort((a, b) => new Date(a) - new Date(b));
            
            sortedDates.forEach((date, index) => {
                const dateObj = new Date(date);
                const dateItem = document.createElement('div');
                dateItem.className = 'custom-date-item';
                dateItem.innerHTML = `
                    <span>${dateObj.toLocaleDateString()}</span>
                    <button class="remove-date-btn" data-index="${index}">×</button>
                `;
                customDatesList.appendChild(dateItem);
            });
            
            document.querySelectorAll('.remove-date-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.getAttribute('data-index'));
                    removeCustomDate(index);
                });
            });
        }

        // 删除自定义日期
        function removeCustomDate(index) {
            appData.customDates.splice(index, 1);
            renderCustomDatesList();
        }

        // 获取任务的打卡计划
        function getTaskCheckinSchedule(task) {
            if (task.scheduleType === 'daily') {
                return getDailyCheckinSchedule(task);
            } else if (task.scheduleType === 'custom' && task.customDates) {
                const startDate = new Date(task.createDate);
                startDate.setHours(0, 0, 0, 0);
                
                return task.customDates.map(customDate => {
                    const date = new Date(customDate);
                    date.setHours(0, 0, 0, 0);
                    return Math.floor((date - startDate) / (1000 * 60 * 60 * 1000 * 24));
                }).sort((a, b) => a - b);
            }
            
            return checkinSchedule;
        }

        // 获取每日打卡计划
        function getDailyCheckinSchedule(task) {
            const startDate = new Date(task.dailyStartDate || task.createDate);
            startDate.setHours(0, 0, 0, 0);
            
            let endDate;
            if (task.dailyEndDate) {
                endDate = new Date(task.dailyEndDate);
                endDate.setHours(0, 0, 0, 0);
            } else if (task.dailyDuration) {
                endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + parseInt(task.dailyDuration));
            } else {
                // 默认持续30天
                endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + 30);
            }
            
            const schedule = [];
            const currentDate = new Date(startDate);
            
            while (currentDate <= endDate) {
                const daysSinceStart = Math.floor((currentDate - startDate) / (1000 * 60 * 60 * 24));
                
                // 根据频率判断是否加入打卡计划
                if (shouldIncludeDate(task, currentDate, daysSinceStart)) {
                    schedule.push(daysSinceStart);
                }
                
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            return schedule;
        }

        // 判断日期是否应该包含在打卡计划中
        function shouldIncludeDate(task, date, daysSinceStart) {
            const frequency = task.dailyFrequency || 'daily';
            
            switch (frequency) {
                case 'daily':
                    return true;
                    
                case '2days':
                    return daysSinceStart % 2 === 0;
                    
                case '3days':
                    return daysSinceStart % 3 === 0;
                    
                case 'weekly':
                    const weekday = date.getDay();
                    const weekdays = task.selectedWeekdays || [1, 2, 3, 4, 5];
                    return weekdays.includes(weekday);
                    
                default:
                    return true;
            }
        }

        // 检查第一天打卡是否完成
        function isFirstDayCheckinComplete(task, checkpointIndex) {
            if (checkpointIndex !== 0) return true;
            
            const firstDayCheckins = task.checkins.filter(c => c.checkpointIndex === 0);
            const requiredCount = task.firstDayCheckinCount || 1;
            
            return firstDayCheckins.length >= requiredCount;
        }

        // 获取已完成的第一天打卡次数
        function getFirstDayCheckinCount(task) {
            const firstDayCheckins = task.checkins.filter(c => c.checkpointIndex === 0);
            return firstDayCheckins.length;
        }

        // 获取每日打卡任务信息
        function getDailyScheduleInfo(task) {
            const startDate = new Date(task.dailyStartDate || task.createDate);
            const endDate = task.dailyEndDate ? new Date(task.dailyEndDate) : 
                           task.dailyDuration ? new Date(startDate.getTime() + task.dailyDuration * 24 * 60 * 60 * 1000) : null;
            
            let info = `从 ${startDate.toLocaleDateString()} 开始`;
            if (endDate) {
                info += ` 到 ${endDate.toLocaleDateString()} 结束`;
            } else if (task.dailyDuration) {
                info += `，持续 ${task.dailyDuration} 天`;
            } else {
                info += '，持续进行';
            }
            
            return info;
        }

        // 获取频率显示信息
        function getFrequencyDisplayInfo(task) {
            if (task.scheduleType !== 'daily') return '';
            
            const frequency = task.dailyFrequency || 'daily';
            const frequencyMap = {
                'daily': '每天',
                '2days': '每2天一次',
                '3days': '每3天一次',
                'weekly': '每周特定日期'
            };
            
            let info = frequencyMap[frequency];
            
            if (frequency === 'weekly' && task.selectedWeekdays) {
                const dayNames = ['日', '一', '二', '三', '四', '五', '六'];
                const selectedDays = task.selectedWeekdays.map(day => `周${dayNames[day]}`).join('、');
                info += ` (${selectedDays})`;
            }
            
            return info;
        }

        // 获取频率标识文本
        function getFrequencyBadgeText(task) {
            const frequency = task.dailyFrequency || 'daily';
            const badgeMap = {
                'daily': '每日',
                '2days': '2天',
                '3days': '每周'
            };
            return badgeMap[frequency];
        }

        // 渲染今日任务
        async function renderTodayTasks() {
            todayTasksEl.innerHTML = '';
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let tasksForToday = [];
            let totalTasks = 0;
            let uncompletedTasks = 0;
            
            for (const task of appData.tasks) {
                if (task.status !== 'active') continue;
                
                const taskSchedule = getTaskCheckinSchedule(task);
                const taskDate = new Date(task.createDate);
                taskDate.setHours(0, 0, 0, 0);
                
                const daysSinceStart = Math.floor((today - taskDate) / (1000 * 60 * 60 * 24));
                
                const checkpointIndex = taskSchedule.findIndex(day => day === daysSinceStart);
                
                if (checkpointIndex !== -1) {
                    const checkin = task.checkins.find(c => c.checkpointIndex === checkpointIndex);
                    const hasCheckedIn = checkpointIndex === 0 ? 
                        isFirstDayCheckinComplete(task, checkpointIndex) : 
                        !!checkin;
                    const needsRedo = checkin && checkin.status === 'needs_redo';
                    
                    totalTasks++;
                    if (!hasCheckedIn || needsRedo) uncompletedTasks++;
                    
                    tasksForToday.push({
                        task,
                        checkpointIndex,
                        daysSinceStart,
                        isOverdue: false,
                        hasCheckedIn,
                        needsRedo,
                        hasPendingRecording: false
                    });
                }
                
                for (let i = 0; i < taskSchedule.length; i++) {
                    const checkpointDay = taskSchedule[i];
                    if (checkpointDay < daysSinceStart && 
                        !task.checkins.some(checkin => checkin.checkpointIndex === i)) {
                        
                        totalTasks++;
                        uncompletedTasks++;
                        
                        tasksForToday.push({
                            task,
                            checkpointIndex: i,
                            daysSinceStart,
                            isOverdue: true,
                            hasCheckedIn: false,
                            needsRedo: false,
                            hasPendingRecording: false
                        });
                    }
                }
            }
            
            todayTasksCountEl.textContent = `${uncompletedTasks}/${totalTasks} 个任务`;
            
            // 按置顶排序，然后按科目和字母排序
            tasksForToday.sort((a, b) => {
                // 置顶任务排在最前面
                if (a.task.pinned && !b.task.pinned) return -1;
                if (!a.task.pinned && b.task.pinned) return 1;
                
                // 然后按科目排序
                const subjectOrder = { '语文': 1, '英语': 2, '数学': 3, '科学': 4, '其他': 5 };
                const subjectA = subjectOrder[a.task.subject] || 6;
                const subjectB = subjectOrder[b.task.subject] || 6;
                
                if (subjectA !== subjectB) {
                    return subjectA - subjectB;
                }
                
                // 相同科目按字母顺序排序
                return a.task.name.localeCompare(b.task.name, 'zh-CN');
            });
            
            if (tasksForToday.length === 0) {
                todayTasksEl.innerHTML = `
                    <div class="empty-state">
                        <i>📅</i>
                        <p>今天没有打卡任务，放松一下吧！</p>
                    </div>
                `;
                return;
            }
            
            tasksForToday.forEach(item => {
                renderTodayTaskItem(item.task, todayTasksEl, item.checkpointIndex, item.daysSinceStart, 
                              item.isOverdue, item.hasCheckedIn, item.needsRedo, item.hasPendingRecording);
            });
        }

        // 渲染今日任务项
        function renderTodayTaskItem(task, container, checkpointIndex, daysSinceStart, isOverdue = false, hasCheckedIn = false, needsRedo = false, hasPendingRecording = false) {
            const taskEl = document.createElement('div');
            
            let taskClass = 'task-item';
            if (isOverdue) {
                taskClass += ' overdue';
            } else if (hasCheckedIn && !needsRedo) {
                taskClass += ' completed';
            } else if (needsRedo) {
                taskClass += ' needs-redo';
            }
            
            // 添加置顶样式
            if (task.pinned) {
                taskClass += ' pinned';
            }
            
            taskEl.className = taskClass;
            
            const taskSchedule = getTaskCheckinSchedule(task);
            const checkpointDay = taskSchedule[checkpointIndex];
            
            let statusText = '';
            
            if (isOverdue) {
                statusText = `逾期${daysSinceStart - checkpointDay}天`;
            } else {
                if (task.scheduleType === 'daily') {
                    statusText = `第${daysSinceStart + 1}天`;
                } else if (task.scheduleType === 'custom') {
                    const startDate = new Date(task.createDate);
                    const checkinDate = new Date(startDate.getTime() + checkpointDay * 24 * 60 * 60 * 1000);
                    statusText = checkinDate.toLocaleDateString();
                } else {
                    statusText = checkpointDay === 0 ? '新任务' : `第${checkpointDay}天`;
                }
            }
            
            const completedCheckins = task.checkins.filter(c => c.status === 'completed').length;
            const totalCheckins = taskSchedule.length;
            const progressPercent = (completedCheckins / totalCheckins) * 100;
            
            const subjectClass = `subject-${getSubjectClass(task.subject)}`;
            
            // 添加频率标识
            const frequencyBadge = task.scheduleType === 'daily' ? 
                `<span class="frequency-badge">${getFrequencyBadgeText(task)}</span>` : '';
            
            // 添加置顶标识
            const pinnedBadge = task.pinned ? 
                `<span class="pinned-badge">置顶</span>` : '';
            
            // 第一天打卡次数显示
            const firstDayCheckinInfo = checkpointIndex === 0 && task.firstDayCheckinCount > 1 ? 
                `<div class="checkin-count-info">第一天需要打卡 ${getFirstDayCheckinCount(task)}/${task.firstDayCheckinCount} 次</div>` : '';
            
            // 重做信息
            const redoInfo = needsRedo ? renderRedoInfo(task, checkpointIndex) : '';
            
            taskEl.innerHTML = `
                <div class="task-header">
                    <div class="task-name ${subjectClass}">${task.subject} - ${task.name}${frequencyBadge}${pinnedBadge}
                        ${needsRedo ? '<span class="redo-badge">需重做</span>' : ''}
                    </div>
                    <div class="task-status ${needsRedo ? 'status-needs-redo' : (hasCheckedIn ? 'status-completed' : (isOverdue ? 'status-overdue' : 'status-today'))}">
                        ${statusText} ${needsRedo ? '需重做' : (hasCheckedIn ? '✓ 今日已打卡' : '未完成')}
                    </div>
                </div>
                ${task.description ? `<p>${task.description.replace(/\n/g, '<br>')}</p>` : ''}
                ${task.scheduleType === 'daily' ? `
                    <div class="daily-schedule-info">
                        <div class="daily-schedule-dates">
                            ${getDailyScheduleInfo(task)}
                        </div>
                        <div class="daily-frequency-info">
                            📅 打卡频率: ${getFrequencyDisplayInfo(task)}
                        </div>
                    </div>
                ` : ''}
                <div class="task-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progressPercent}%"></div>
                    </div>
                    <div class="progress-text">
                        已完成 ${completedCheckins} 次打卡
                        ${task.scheduleType === 'custom' ? '<div>📅 自定义日期计划</div>' : ''}
                        ${firstDayCheckinInfo}
                    </div>
                    ${generateCompactCheckinInfo(task)}
                </div>
                ${redoInfo}
                <div class="task-actions">
                    ${(!hasCheckedIn || needsRedo) ? 
                        `<button class="btn btn-primary" onclick="startCheckin(${task.id}, ${checkpointIndex})">
                            ${needsRedo ? '重做打卡' : '立即打卡'}
                        </button>` : ''}
                    <button class="btn btn-secondary" onclick="showEditTaskForm(${task.id})">编辑</button>
                    <button class="btn btn-secondary" onclick="viewTaskDetails(${task.id})">详情</button>
                    <button class="${task.pinned ? 'btn btn-unpin' : 'btn btn-pin'}" onclick="toggleTaskPin(${task.id})">
                        ${task.pinned ? '取消置顶' : '置顶'}
                    </button>
                    <button class="btn btn-warning" onclick="showRedoManagementModal(${task.id}, ${checkpointIndex})">标记重做</button>
                    <button class="btn btn-danger" onclick="deleteTask(${task.id})">删除</button>
                    ${completedCheckins > 0 ? 
                        `<button class="btn btn-secondary" onclick="playLatestRecording(${task.id})" id="play-latest-${task.id}">回放录音</button>` : ''}
                </div>
            `;
            
            container.appendChild(taskEl);
        }

        // 获取科目对应的CSS类名
        function getSubjectClass(subject) {
            const subjectMap = {
                '语文': 'chinese',
                '数学': 'math',
                '英语': 'english',
                '科学': 'science',
                '其他': 'other'
            };
            return subjectMap[subject] || 'other';
        }

        // 生成紧凑的打卡记录信息
        function generateCompactCheckinInfo(task) {
            if (task.checkins.length === 0) {
                return '';
            }
            
            const taskSchedule = getTaskCheckinSchedule(task);
            const recentCheckins = [...task.checkins]
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 3);
            
            const checkinItems = recentCheckins.map(checkin => {
                const checkpointDay = taskSchedule[checkin.checkpointIndex];
                
                if (task.scheduleType === 'daily') {
                    const date = new Date(checkin.date);
                    const formattedDate = `${date.getMonth()+1}/${date.getDate()}`;
                    const statusIcon = checkin.status === 'needs_redo' ? '🔄' : '✅';
                    return `<span class="compact-checkin-item">第${checkpointDay + 1}天 ${formattedDate} ${statusIcon}</span>`;
                } else if (task.scheduleType === 'custom') {
                    const startDate = new Date(task.createDate);
                    const checkinDate = new Date(startDate.getTime() + checkpointDay * 24 * 60 * 60 * 1000);
                    const formattedDate = `${checkinDate.getMonth()+1}/${checkinDate.getDate()}`;
                    const statusIcon = checkin.status === 'needs_redo' ? '🔄' : '✅';
                    return `<span class="compact-checkin-item">${formattedDate} ${statusIcon}</span>`;
                } else {
                    const date = new Date(checkin.date);
                    const formattedDate = `${date.getMonth()+1}/${date.getDate()}`;
                    const statusIcon = checkin.status === 'needs_redo' ? '🔄' : '✅';
                    return `<span class="compact-checkin-item">第${checkpointDay}天 ${formattedDate} ${statusIcon}</span>`;
                }
            }).join('');
            
            return `<div class="compact-checkin-info">最近打卡: ${checkinItems}</div>`;
        }

        // 切换任务置顶状态
        async function toggleTaskPin(taskId) {
            const task = appData.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            task.pinned = !task.pinned;
            
            await saveTasks();
            
            renderTodayTasks();
            renderAllTasks();
        }

        // 删除任务
        async function deleteTask(taskId) {
            if (confirm('确定要删除这个任务吗？此操作将永久删除任务及其相关数据，不可恢复！')) {
                // 删除任务
                appData.tasks = appData.tasks.filter(t => t.id !== taskId);
                await dataStorage.deleteTask(taskId);
                
                // 删除相关录音
                const taskRecordings = await dataStorage.getRecordingsByTask(taskId);
                for (const recording of taskRecordings) {
                    await dataStorage.deleteRecording(recording.id);
                }
                
                // 删除相关照片
                const taskPhotos = await dataStorage.getPhotosByTask(taskId);
                for (const photo of taskPhotos) {
                    await dataStorage.deletePhoto(photo.id);
                }
                
                // 删除相关反馈
                appData.feedbacks = appData.feedbacks.filter(f => f.taskId !== taskId);
                // 这里需要添加删除反馈的逻辑
                
                // 更新界面
                await saveTasks();
                
                renderAllTasks();
                renderTodayTasks();
                renderCalendar();
                renderDataStats();
                renderRecordings();
                
                alert('任务已删除');
            }
        }

        // 渲染所有任务
        async function renderAllTasks() {
            allTasksEl.innerHTML = '';
            
            if (appData.tasks.length === 0) {
                allTasksEl.innerHTML = `
                    <div class="empty-state">
                        <i>📝</i>
                        <p>还没有任何任务，点击"新建任务"开始吧！</p>
                    </div>
                `;
                return;
            }
            
            // 分离已完成和未完成的任务
            const pinnedTasks = [];
            const activeTasks = [];
            const completedTasks = [];
            
            appData.tasks.forEach(task => {
                const taskSchedule = getTaskCheckinSchedule(task);
                const completedCheckins = task.checkins.filter(c => c.status === 'completed').length;
                
                // 首先检查是否为置顶任务
                if (task.pinned) {
                    pinnedTasks.push(task);
                } else if (completedCheckins === taskSchedule.length) {
                    completedTasks.push(task);
                } else {
                    activeTasks.push(task);
                }
            });
            
            // 对置顶任务按创建时间倒序排列
            pinnedTasks.sort((a, b) => new Date(b.createDate) - new Date(a.createDate));
            
            // 对未完成任务按科目和字母排序
            activeTasks.sort((a, b) => {
                const subjectOrder = { '语文': 1, '英语': 2, '数学': 3, '科学': 4, '其他': 5 };
                const subjectA = subjectOrder[a.subject] || 6;
                const subjectB = subjectOrder[b.subject] || 6;
                
                if (subjectA !== subjectB) {
                    return subjectA - subjectB;
                }
                
                // 相同科目按字母顺序排序
                return a.name.localeCompare(b.name, 'zh-CN');
            });
            
            // 对已完成任务按完成时间倒序排列
            completedTasks.sort((a, b) => {
                const aLastCheckin = a.checkins.length > 0 ? 
                    new Date(a.checkins[a.checkins.length - 1].date) : new Date(0);
                const bLastCheckin = b.checkins.length > 0 ? 
                    new Date(b.checkins[b.checkins.length - 1].date) : new Date(0);
                return bLastCheckin - aLastCheckin;
            });
            
            // 合并任务列表：置顶任务在前，未完成的任务在中间，已完成的任务在后
            const sortedTasks = [...pinnedTasks, ...activeTasks, ...completedTasks];
            
            sortedTasks.forEach(task => {
                const taskEl = document.createElement('div');
                taskEl.className = 'task-item';
                
                // 添加置顶样式
                if (task.pinned) {
                    taskEl.classList.add('pinned');
                }
                
                const taskSchedule = getTaskCheckinSchedule(task);
                const completedCheckins = task.checkins.filter(c => c.status === 'completed').length;
                const totalCheckins = taskSchedule.length;
                const progressPercent = (completedCheckins / totalCheckins) * 100;
                
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const taskDate = new Date(task.createDate);
                taskDate.setHours(0, 0, 0, 0);
                
                const daysSinceStart = Math.floor((today - taskDate) / (1000 * 60 * 60 * 24));
                const checkpointIndex = taskSchedule.findIndex(day => day === daysSinceStart);
                const shouldCheckinToday = checkpointIndex !== -1;
                const hasCheckedInToday = shouldCheckinToday ? 
                    (checkpointIndex === 0 ? 
                        isFirstDayCheckinComplete(task, checkpointIndex) : 
                        task.checkins.some(checkin => checkin.checkpointIndex === checkpointIndex && checkin.status === 'completed')) : 
                    false;
                const needsRedoToday = shouldCheckinToday ? 
                    task.checkins.some(checkin => checkin.checkpointIndex === checkpointIndex && checkin.status === 'needs_redo') : false;
                
                let hasOverdue = false;
                let hasRedo = false;
                for (let i = 0; i < taskSchedule.length; i++) {
                    const checkpointDay = taskSchedule[i];
                    const checkin = task.checkins.find(c => c.checkpointIndex === i);
                    
                    if (checkpointDay < daysSinceStart) {
                        if (!checkin) {
                            hasOverdue = true;
                        } else if (checkin.status === 'needs_redo') {
                            hasRedo = true;
                        }
                    }
                }
                
                const canCheckinToday = shouldCheckinToday && (!hasCheckedInToday || needsRedoToday);
                const hasOverdueCheckin = hasOverdue || hasRedo;
                const checkinBtnEnabled = canCheckinToday || hasOverdueCheckin;
                
                let statusClass = 'status-future';
                let statusText = '';
                
                if (hasOverdue) {
                    statusClass = 'status-overdue';
                    statusText = '有逾期';
                } else if (hasRedo) {
                    statusClass = 'status-needs-redo';
                    statusText = '需重做';
                } else if (shouldCheckinToday) {
                    statusClass = hasCheckedInToday ? 'status-completed' : 'status-pending';
                    statusText = hasCheckedInToday ? '今日已打卡' : '今日未打卡';
                }
                
                // 如果是已完成任务，显示已完成状态
                if (completedCheckins === totalCheckins) {
                    statusClass = 'status-completed';
                    statusText = '已完成';
                }
                
                const compactCheckinInfo = generateCompactCheckinInfo(task);
                
                const subjectClass = `subject-${getSubjectClass(task.subject)}`;
                
                const hasPlayableRecording = completedCheckins > 0;
                
                // 添加频率标识
                const frequencyBadge = task.scheduleType === 'daily' ? 
                    `<span class="frequency-badge">${getFrequencyBadgeText(task)}</span>` : '';
                
                // 添加置顶标识
                const pinnedBadge = task.pinned ? 
                    `<span class="pinned-badge">置顶</span>` : '';
                
                // 第一天打卡次数显示
                const firstDayCheckinInfo = checkpointIndex === 0 && task.firstDayCheckinCount > 1 ? 
                    `<div class="checkin-count-info">第一天需要打卡 ${getFirstDayCheckinCount(task)}/${task.firstDayCheckinCount} 次</div>` : '';
                
                // 重做信息
                const redoInfo = needsRedoToday ? renderRedoInfo(task, checkpointIndex) : '';
                
                taskEl.innerHTML = `
                    <div class="task-header">
                        <div class="task-name ${subjectClass}">${task.subject} - ${task.name}${frequencyBadge}${pinnedBadge}
                            ${hasRedo ? '<span class="redo-badge">需重做</span>' : ''}
                        </div>
                        <div class="task-status ${statusClass}">
                            ${completedCheckins}/${totalCheckins}
                            ${statusText}
                        </div>
                    </div>
                    ${task.description ? `<p>${task.description.replace(/\n/g, '<br>')}</p>` : ''}
                    ${task.scheduleType === 'daily' ? `
                        <div class="daily-schedule-info">
                            <div class="daily-schedule-dates">
                                ${getDailyScheduleInfo(task)}
                            </div>
                            <div class="daily-frequency-info">
                                📅 打卡频率: ${getFrequencyDisplayInfo(task)}
                            </div>
                        </div>
                    ` : ''}
                    <div class="task-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progressPercent}%"></div>
                        </div>
                        <div class="progress-text">
                            已完成 ${completedCheckins} 次打卡，还需 ${totalCheckins - completedCheckins} 次
                            ${task.scheduleType === 'custom' ? '<div>📅 自定义日期计划</div>' : ''}
                            ${firstDayCheckinInfo}
                        </div>
                        ${compactCheckinInfo}
                    </div>
                    ${redoInfo}
                    <div class="task-actions">
                        <button class="btn ${checkinBtnEnabled ? 'btn-primary' : 'btn-disabled'}" onclick="handleCheckinClick(${task.id}, ${!checkinBtnEnabled})">
                            ${needsRedoToday ? '重做打卡' : '打卡'}
                        </button>
                        <button class="btn btn-secondary" onclick="showEditTaskForm(${task.id})">编辑</button>
                        <button class="btn btn-secondary" onclick="viewTaskDetails(${task.id})">详情</button>
                        <button class="${task.pinned ? 'btn btn-unpin' : 'btn btn-pin'}" onclick="toggleTaskPin(${task.id})">
                            ${task.pinned ? '取消置顶' : '置顶'}
                        </button>
                        <button class="btn btn-warning" onclick="showRedoManagementModal(${task.id}, ${checkpointIndex})">标记重做</button>
                        <button class="btn btn-danger" onclick="deleteTask(${task.id})">删除</button>
                        ${hasPlayableRecording ? 
                            `<button class="btn btn-secondary" onclick="playLatestRecording(${task.id})" id="play-latest-${task.id}">回放录音</button>` : ''}
                    </div>
                `;
                
                allTasksEl.appendChild(taskEl);
            });
        }

        // 处理打卡按钮点击
        function handleCheckinClick(taskId, isDisabled) {
            if (isDisabled) {
                alert('今日已经打卡成功！');
                return;
            }
            startCheckin(taskId);
        }

        // 播放最新录音
        async function playLatestRecording(taskId) {
            try {
                const recordings = await dataStorage.getRecordingsByTask(taskId);
                if (recordings.length === 0) {
                    alert('该任务没有录音记录');
                    return;
                }
                
                // 按日期排序，获取最新录音
                const latestRecording = recordings.sort((a, b) => 
                    new Date(b.date) - new Date(a.date)
                )[0];
                
                await playSavedRecording(latestRecording.id);
                
            } catch (error) {
                console.error('播放最新录音失败:', error);
                alert('加载录音失败');
            }
        }

        // 播放保存的录音
        async function playSavedRecording(recordingId) {
            try {
                const recording = await dataStorage.getRecording(recordingId);
                if (!recording) {
                    alert('未找到录音记录');
                    return;
                }
                
                if (!recording.audioUrl && recording.audioData) {
                    createAudioUrlFromData(recording);
                }
                
                if (recording.audioUrl) {
                    const playBtn = document.getElementById(`play-saved-${recordingId}`);
                    if (playBtn) {
                        playBtn.textContent = '录音回放中';
                        playBtn.disabled = true;
                    }
                    
                    switchTab('checkin');
                    switchCheckinType('record');
                    
                    audioPlayer.src = recording.audioUrl;
                    audioPlayer.classList.remove('hidden');
                    
                    audioPlayer.play().then(() => {
                        console.log('录音开始播放');
                    }).catch(error => {
                        console.error('播放失败:', error);
                        alert('播放录音失败: ' + error.message);
                        if (playBtn) {
                            playBtn.textContent = '播放';
                            playBtn.disabled = false;
                        }
                    });
                    
                    audioPlayer.onended = () => {
                        if (playBtn) {
                            playBtn.textContent = '播放';
                            playBtn.disabled = false;
                        }
                    };
                    
                } else {
                    alert('录音数据不可用，可能已损坏');
                }
            } catch (error) {
                console.error('播放录音失败:', error);
                alert('加载录音失败');
            }
        }

        // 从Base64数据创建可播放的URL
        function createAudioUrlFromData(recording) {
            if (recording.audioData && !recording.audioUrl) {
                try {
                    const parts = recording.audioData.split(',');
                    if (parts.length < 2) {
                        console.error('Base64数据格式不正确');
                        return;
                    }
                    
                    const mimeType = parts[0].match(/:(.*?);/)[1];
                    const base64Data = parts[1];
                    
                    const byteCharacters = atob(base64Data);
                    const byteArrays = [];
                    
                    for (let offset = 0; offset < byteCharacters.length; offset += 512) {
                        const slice = byteCharacters.slice(offset, offset + 512);
                        
                        const byteNumbers = new Array(slice.length);
                        for (let i = 0; i < slice.length; i++) {
                            byteNumbers[i] = slice.charCodeAt(i);
                        }
                        
                        const byteArray = new Uint8Array(byteNumbers);
                        byteArrays.push(byteArray);
                    }
                    
                    const blob = new Blob(byteArrays, { type: mimeType });
                    recording.audioUrl = URL.createObjectURL(blob);
                } catch (error) {
                    console.error('创建音频URL失败:', error);
                }
            }
        }

        // 加载打卡数据时恢复所有录音的URL
        function restoreRecordingUrls() {
            appData.recordings.forEach(recording => {
                createAudioUrlFromData(recording);
            });
        }

        // 开始打卡
        function startCheckin(taskId, checkpointIndex = null) {
            const task = appData.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            appData.currentTask = task;
            appData.isRedo = false;
            
            if (checkpointIndex === null) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const taskDate = new Date(task.createDate);
                taskDate.setHours(0, 0, 0, 0);
                
                const daysSinceStart = Math.floor((today - taskDate) / (1000 * 60 * 60 * 24));
                const taskSchedule = getTaskCheckinSchedule(task);
                checkpointIndex = taskSchedule.findIndex(day => day === daysSinceStart);
                
                if (checkpointIndex === -1) {
                    const overdueCheckpoints = [];
                    for (let i = 0; i < taskSchedule.length; i++) {
                        const checkin = task.checkins.find(c => c.checkpointIndex === i);
                        if (taskSchedule[i] < daysSinceStart) {
                            if (!checkin || checkin.status === 'needs_redo') {
                                overdueCheckpoints.push({
                                    index: i,
                                    day: taskSchedule[i],
                                    needsRedo: checkin && checkin.status === 'needs_redo'
                                });
                            }
                        }
                    }
                    
                    overdueCheckpoints.sort((a, b) => a.day - b.day);
                    
                    if (overdueCheckpoints.length > 0) {
                        checkpointIndex = overdueCheckpoints[0].index;
                        appData.isRedo = overdueCheckpoints[0].needsRedo;
                    }
                } else {
                    // 检查今日打卡点是否需要重做
                    const todayCheckin = task.checkins.find(c => c.checkpointIndex === checkpointIndex);
                    appData.isRedo = todayCheckin && todayCheckin.status === 'needs_redo';
                }
            } else {
                // 检查指定打卡点是否需要重做
                const checkin = task.checkins.find(c => c.checkpointIndex === checkpointIndex);
                appData.isRedo = checkin && checkin.status === 'needs_redo';
            }
            
            appData.currentCheckpointIndex = checkpointIndex;
            
            switchTab('checkin');
            
            updateRecorderTaskInfo();
            updatePhotoTaskInfo();
            
            resetRecorder();
            resetPhoto();
        }

        // 更新录音界面的任务信息
        function updateRecorderTaskInfo() {
            recorderTaskNameEl.textContent = `${appData.currentTask.subject} - ${appData.currentTask.name}`;
            const taskSchedule = getTaskCheckinSchedule(appData.currentTask);
            const checkpointDay = taskSchedule[appData.currentCheckpointIndex];
            
            if (appData.currentTask.scheduleType === 'daily') {
                recorderCheckpointEl.textContent = `第${checkpointDay + 1}天打卡`;
            } else if (appData.currentTask.scheduleType === 'custom') {
                const startDate = new Date(appData.currentTask.createDate);
                const checkinDate = new Date(startDate.getTime() + checkpointDay * 24 * 60 * 60 * 1000);
                recorderCheckpointEl.textContent = `${checkinDate.toLocaleDateString()} 打卡`;
            } else {
                recorderCheckpointEl.textContent = `第${checkpointDay}天打卡`;
            }
            
            // 如果是重做，显示重做标识
            if (appData.isRedo) {
                recorderCheckpointEl.textContent += ' (重做)';
            }
            
            if (appData.currentTask.description) {
                recorderTaskDescContentEl.innerHTML = appData.currentTask.description.replace(/\n/g, '<br>');
                recorderTaskDescriptionEl.classList.remove('hidden');
            } else {
                recorderTaskDescriptionEl.classList.add('hidden');
            }
        }

        // 更新拍照界面的任务信息
        function updatePhotoTaskInfo() {
            photoTaskNameEl.textContent = `${appData.currentTask.subject} - ${appData.currentTask.name}`;
            const taskSchedule = getTaskCheckinSchedule(appData.currentTask);
            const checkpointDay = taskSchedule[appData.currentCheckpointIndex];
            
            if (appData.currentTask.scheduleType === 'daily') {
                photoCheckpointEl.textContent = `第${checkpointDay + 1}天打卡`;
            } else if (appData.currentTask.scheduleType === 'custom') {
                const startDate = new Date(appData.currentTask.createDate);
                const checkinDate = new Date(startDate.getTime() + checkpointDay * 24 * 60 * 60 * 1000);
                photoCheckpointEl.textContent = `${checkinDate.toLocaleDateString()} 打卡`;
            } else {
                photoCheckpointEl.textContent = `第${checkpointDay}天打卡`;
            }
            
            // 如果是重做，显示重做标识
            if (appData.isRedo) {
                photoCheckpointEl.textContent += ' (重做)';
            }
            
            if (appData.currentTask.description) {
                photoTaskDescContentEl.innerHTML = appData.currentTask.description.replace(/\n/g, '<br>');
                photoTaskDescriptionEl.classList.remove('hidden');
            } else {
                photoTaskDescriptionEl.classList.add('hidden');
            }
        }

        // 切换打卡类型
        function switchCheckinType(type) {
            appData.currentCheckinType = type;
            
            checkinTypeSelectors.forEach(t => {
                if (t.getAttribute('data-type') === type) {
                    t.classList.add('active');
                } else {
                    t.classList.remove('active');
                }
            });
            
            // 隐藏所有容器
            recordContainer.classList.add('hidden');
            photoContainer.classList.add('hidden');
            
            // 显示对应的容器
            if (type === 'record') {
                recordContainer.classList.remove('hidden');
                if (appData.currentTask) {
                    updateRecorderTaskInfo();
                }
            } else if (type === 'photo') {
                photoContainer.classList.remove('hidden');
                if (appData.currentTask) {
                    updatePhotoTaskInfo();
                }
            }
        }

        // 开始录音
        async function startRecording() {
            if (!appData.currentTask) {
                alert('请先选择一个任务！');
                return;
            }
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                appData.mediaRecorder = new MediaRecorder(stream);
                appData.audioChunks = [];
                
                appData.mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        appData.audioChunks.push(event.data);
                    }
                };
                
                appData.mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(appData.audioChunks, { type: 'audio/wav' });
                    
                    const reader = new FileReader();
                    reader.onload = async function() {
                        const base64Audio = reader.result;
                        
                        const recording = {
                            id: Date.now(),
                            taskId: appData.currentTask.id,
                            checkpointIndex: appData.currentCheckpointIndex,
                            date: new Date().toISOString(),
                            duration: appData.recordingTime,
                            audioData: base64Audio,
                            mimeType: 'audio/wav',
                            type: 'audio'
                        };
                        
                        createAudioUrlFromData(recording);
                        
                        // 保存到IndexedDB
                        await dataStorage.saveRecording(recording);
                        
                        appData.currentRecording = recording;
                        
                        stream.getTracks().forEach(track => track.stop());
                        
                        recordBtn.classList.remove('recording', 'hidden');
                        pauseBtn.classList.add('hidden');
                        stopBtn.classList.add('hidden');
                        playBtn.classList.remove('hidden');
                        submitRecordingBtn.disabled = false;
                        
                        audioPlayer.src = recording.audioUrl;
                        audioPlayer.classList.remove('hidden');
                        
                        console.log('录音保存完成，ID:', recording.id);
                    };
                    reader.readAsDataURL(audioBlob);
                };
                
                appData.isRecording = true;
                appData.isPaused = false;
                appData.recordingTime = 0;
                
                recordBtn.classList.add('recording');
                pauseBtn.classList.remove('hidden');
                stopBtn.classList.remove('hidden');
                recordBtn.classList.add('hidden');
                
                updatePlaybackStatus('录音中...', 'status-recording');
                
                appData.mediaRecorder.start();
                
                appData.timerInterval = setInterval(() => {
                    appData.recordingTime += 10;
                    updateTimer();
                    updateWaveform();
                }, 10);
                
            } catch (error) {
                console.error('录音启动失败:', error);
                alert('无法访问麦克风，请检查权限设置');
            }
        }

        // 暂停录音
        function togglePause() {
            if (!appData.mediaRecorder) return;
            
            if (appData.isPaused) {
                appData.mediaRecorder.resume();
                appData.isPaused = false;
                pauseBtn.innerHTML = '❚❚';
                updatePlaybackStatus('录音中...', 'status-recording');
                
                appData.timerInterval = setInterval(() => {
                    appData.recordingTime += 10;
                    updateTimer();
                    updateWaveform();
                }, 10);
            } else {
                appData.mediaRecorder.pause();
                appData.isPaused = true;
                clearInterval(appData.timerInterval);
                pauseBtn.innerHTML = '▶';
                updatePlaybackStatus('录音已暂停', 'status-playing');
            }
        }

        // 更新播放状态显示
        function updatePlaybackStatus(message, statusClass) {
            recordingStatusEl.textContent = message;
            recordingStatusEl.className = 'recording-status ' + statusClass;
            recordingStatusEl.classList.remove('hidden');
        }

        // 停止录音
        function stopRecording() {
            if (!appData.mediaRecorder || appData.mediaRecorder.state === 'inactive') return;
            
            appData.mediaRecorder.stop();
            appData.isRecording = false;
            appData.isPaused = false;
            
            clearInterval(appData.timerInterval);
            
            recordBtn.classList.remove('recording', 'hidden');
            pauseBtn.classList.add('hidden');
            stopBtn.classList.add('hidden');
            playBtn.classList.remove('hidden');
            submitRecordingBtn.disabled = false;
            
            recordingStatusEl.classList.add('hidden');
        }

        // 播放录音
        function playRecording() {
            if (!appData.currentRecording) {
                console.log('没有当前录音可播放');
                return;
            }
            
            if (!appData.currentRecording.audioUrl && appData.currentRecording.audioData) {
                createAudioUrlFromData(appData.currentRecording);
            }
            
            if (appData.currentRecording.audioUrl) {
                audioPlayer.src = appData.currentRecording.audioUrl;
                audioPlayer.classList.remove('hidden');
                audioPlayer.play().catch(error => {
                    console.error('播放失败:', error);
                    alert('播放录音失败');
                });
            } else {
                alert('录音数据不可用，可能已损坏');
            }
        }

        // 更新计时器
        function updateTimer() {
            timerEl.textContent = formatTime(appData.recordingTime);
        }

        // 格式化时间
        function formatTime(milliseconds) {
            const totalSeconds = Math.floor(milliseconds / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            const ms = Math.floor((milliseconds % 1000) / 10);
            
            if (hours > 0) {
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${ms.toString().padStart(2, '0')}`;
        }

        // 更新波形图
        function updateWaveform() {
            if (Math.random() < 0.3) {
                const bar = document.createElement('div');
                bar.className = 'waveform-bar';
                bar.style.height = `${10 + Math.random() * 80}px`;
                bar.style.left = `${Math.random() * 95}%`;
                waveformEl.appendChild(bar);
                
                if (waveformEl.children.length > 50) {
                    waveformEl.removeChild(waveformEl.firstChild);
                }
            }
        }

        // 清空波形图
        function clearWaveform() {
            waveformEl.innerHTML = '';
        }

        // 重置录音器
        function resetRecorder() {
            appData.isRecording = false;
            appData.isPaused = false;
            appData.recordingTime = 0;
            
            clearInterval(appData.timerInterval);
            
            recordBtn.classList.remove('recording', 'hidden');
            pauseBtn.classList.add('hidden');
            stopBtn.classList.add('hidden');
            playBtn.classList.add('hidden');
            submitRecordingBtn.disabled = true;
            
            audioPlayer.classList.add('hidden');
            audioPlayer.src = '';
            recordingStatusEl.classList.add('hidden');
            
            updateTimer();
            clearWaveform();
        }

        // 提交录音
        async function submitRecording() {
            if (!appData.currentRecording) {
                alert('请先完成录音！');
                return;
            }
            
            const task = appData.tasks.find(t => t.id === appData.currentRecording.taskId);
            if (!task) return;
            
            // 如果是重做打卡
            if (appData.isRedo) {
                const success = await redoCheckin(task.id, appData.currentCheckpointIndex, appData.currentRecording);
                if (success) {
                    resetRecorder();
                    appData.isRedo = false;
                    renderRecordings();
                    renderTodayTasks();
                    renderAllTasks();
                    renderCalendar();
                    renderDataStats();
                }
                return;
            }

            const taskSchedule = getTaskCheckinSchedule(task);
            const alreadyCheckedIn = task.checkins.some(
                checkin => checkin.checkpointIndex === appData.currentRecording.checkpointIndex && checkin.status === 'completed'
            );
            
            // 如果是第一天打卡，检查是否达到要求次数
            if (appData.currentCheckpointIndex === 0) {
                const firstDayCheckins = task.checkins.filter(c => c.checkpointIndex === 0);
                const requiredCount = task.firstDayCheckinCount || 1;
                
                if (firstDayCheckins.length >= requiredCount) {
                    alert(`第一天已经完成${requiredCount}次打卡，不能再继续打卡！`);
                    return;
                }
            } else {
                // 其他天的打卡，如果已经完成过就不能再打卡
                if (alreadyCheckedIn) {
                    alert('这个打卡点已经完成过了！');
                    return;
                }
            }
            
            task.checkins.push({
                checkpointIndex: appData.currentRecording.checkpointIndex,
                date: appData.currentRecording.date,
                recordingId: appData.currentRecording.id,
                type: 'audio',
                status: 'completed'
            });
            
            // 检查是否完成所有打卡
            const completedCheckins = task.checkins.filter(c => c.status === 'completed').length;
            const totalCheckins = taskSchedule.length;
            
            if (completedCheckins === totalCheckins) {
                task.status = 'completed';
                alert(`恭喜！任务"${task.name}"已完成！`);
            } else {
                // 如果是第一天打卡，显示当前打卡次数
                if (appData.currentCheckpointIndex === 0) {
                    const currentCount = getFirstDayCheckinCount(task);
                    const requiredCount = task.firstDayCheckinCount || 1;
                    alert(`打卡成功！第一天打卡 ${currentCount}/${requiredCount} 次`);
                } else {
                    alert('打卡成功！');
                }
            }
            
            await saveTasks();
            
            resetRecorder();
            renderRecordings();
            renderTodayTasks();
            renderAllTasks();
            renderCalendar();
            renderDataStats();
        }

        // 启动摄像头
        async function startCamera() {
            if (!appData.currentTask) {
                alert('请先选择一个任务！');
                return;
            }
            
            try {
                // 尝试获取后置摄像头
                const constraints = {
                    video: {
                        facingMode: { ideal: 'environment' },
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                appData.cameraStream = stream;
                appData.isCameraActive = true;
                
                // 显示摄像头预览
                cameraPreview.srcObject = stream;
                cameraPreview.classList.remove('hidden');
                photoPreview.classList.add('hidden');
                
                // 更新按钮状态
                startCameraBtn.disabled = true;
                takePhotoBtn.disabled = false;
                stopCameraBtn.disabled = false;
                retakePhotoBtn.disabled = true;
                submitPhotoBtn.disabled = true;
                
                // 更新状态显示
                updateCameraStatus('摄像头已启动', 'status-camera-active');
                
            } catch (error) {
                console.error('启动摄像头失败:', error);
                
                // 如果后置摄像头失败，尝试使用前置摄像头
                try {
                    const constraints = {
                        video: {
                            facingMode: 'user',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    };
                    
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    appData.cameraStream = stream;
                    appData.isCameraActive = true;
                    
                    // 显示摄像头预览
                    cameraPreview.srcObject = stream;
                    cameraPreview.classList.remove('hidden');
                    photoPreview.classList.add('hidden');
                    
                    // 更新按钮状态
                    startCameraBtn.disabled = true;
                    takePhotoBtn.disabled = false;
                    stopCameraBtn.disabled = false;
                    retakePhotoBtn.disabled = true;
                    submitPhotoBtn.disabled = true;
                    
                    // 更新状态显示
                    updateCameraStatus('摄像头已启动（使用前置摄像头）', 'status-camera-active');
                    
                } catch (fallbackError) {
                    console.error('前置摄像头也启动失败:', fallbackError);
                    updateCameraStatus('无法访问摄像头，请检查权限设置', 'status-camera-error');
                    alert('无法访问摄像头，请检查权限设置');
                }
            }
        }

        // 拍照
        async function takePhoto() {
            if (!appData.isCameraActive || !appData.cameraStream) {
                alert('请先启动摄像头！');
                return;
            }
            
            // 创建canvas用于拍照
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            // 设置canvas尺寸与视频相同
            canvas.width = cameraPreview.videoWidth;
            canvas.height = cameraPreview.videoHeight;
            
            // 拍照
            context.drawImage(cameraPreview, 0, 0, canvas.width, canvas.height);
            
            // 将照片转换为Base64
            const imageData = canvas.toDataURL('image/jpeg', 0.7);
            
            // 显示照片预览
            photoPreview.src = imageData;
            photoPreview.classList.remove('hidden');
            cameraPreview.classList.add('hidden');
            
            // 保存照片数据
            appData.currentPhoto = {
                id: Date.now(),
                taskId: appData.currentTask.id,
                checkpointIndex: appData.currentCheckpointIndex,
                date: new Date().toISOString(),
                imageData: imageData,
                mimeType: 'image/jpeg',
                type: 'photo'
            };
            
            // 更新按钮状态
            takePhotoBtn.disabled = true;
            retakePhotoBtn.disabled = false;
            submitPhotoBtn.disabled = false;
            
            // 停止摄像头
            stopCamera();
            
            alert('拍照成功！');
        }

        // 重拍照片
        function retakePhoto() {
            photoPreview.classList.add('hidden');
            photoPreview.src = '';
            appData.currentPhoto = null;
            submitPhotoBtn.disabled = true;
            retakePhotoBtn.disabled = true;
            
            // 重新启动摄像头
            startCamera();
        }

        // 停止摄像头
        function stopCamera() {
            if (appData.cameraStream) {
                appData.cameraStream.getTracks().forEach(track => track.stop());
                appData.cameraStream = null;
                appData.isCameraActive = false;
                
                cameraPreview.classList.add('hidden');
                cameraPreview.srcObject = null;
                
                // 更新按钮状态
                startCameraBtn.disabled = false;
                takePhotoBtn.disabled = true;
                stopCameraBtn.disabled = true;
                
                // 清除状态显示
                cameraStatusEl.classList.add('hidden');
            }
        }

        // 更新摄像头状态
        function updateCameraStatus(message, statusClass) {
            cameraStatusEl.textContent = message;
            cameraStatusEl.className = 'camera-status ' + statusClass;
            cameraStatusEl.classList.remove('hidden');
        }

        // 提交照片
        async function submitPhoto() {
            if (!appData.currentPhoto) {
                alert('请先拍照！');
                return;
            }
            
            const task = appData.tasks.find(t => t.id === appData.currentPhoto.taskId);
            if (!task) return;
            
            // 如果是重做打卡
            if (appData.isRedo) {
                const success = await redoCheckin(task.id, appData.currentCheckpointIndex, appData.currentPhoto);
                if (success) {
                    resetPhoto();
                    appData.isRedo = false;
                    renderRecordings();
                    renderTodayTasks();
                    renderAllTasks();
                    renderCalendar();
                    renderDataStats();
                }
                return;
            }

            const taskSchedule = getTaskCheckinSchedule(task);
            const alreadyCheckedIn = task.checkins.some(
                checkin => checkin.checkpointIndex === appData.currentPhoto.checkpointIndex && checkin.status === 'completed'
            );
            
            // 如果是第一天打卡，检查是否达到要求次数
            if (appData.currentCheckpointIndex === 0) {
                const firstDayCheckins = task.checkins.filter(c => c.checkpointIndex === 0);
                const requiredCount = task.firstDayCheckinCount || 1;
                
                if (firstDayCheckins.length >= requiredCount) {
                    alert(`第一天已经完成${requiredCount}次打卡，不能再继续打卡！`);
                    return;
                }
            } else {
                // 其他天的打卡，如果已经完成过就不能再打卡
                if (alreadyCheckedIn) {
                    alert('这个打卡点已经完成过了！');
                    return;
                }
            }
            
            // 保存到IndexedDB
            await dataStorage.savePhoto(appData.currentPhoto);
            
            task.checkins.push({
                checkpointIndex: appData.currentPhoto.checkpointIndex,
                date: appData.currentPhoto.date,
                photoId: appData.currentPhoto.id,
                type: 'photo',
                status: 'completed'
            });
            
            // 检查是否完成所有打卡
            const completedCheckins = task.checkins.filter(c => c.status === 'completed').length;
            const totalCheckins = taskSchedule.length;
            
            if (completedCheckins === totalCheckins) {
                task.status = 'completed';
                alert(`恭喜！任务"${task.name}"已完成！`);
            } else {
                // 如果是第一天打卡，显示当前打卡次数
                if (appData.currentCheckpointIndex === 0) {
                    const currentCount = getFirstDayCheckinCount(task);
                    const requiredCount = task.firstDayCheckinCount || 1;
                    alert(`打卡成功！第一天打卡 ${currentCount}/${requiredCount} 次`);
                } else {
                    alert('打卡成功！');
                }
            }
            
            await saveTasks();
            
            resetPhoto();
            renderRecordings();
            renderTodayTasks();
            renderAllTasks();
            renderCalendar();
            renderDataStats();
        }

        // 重置拍照界面
        function resetPhoto() {
            photoPreview.classList.add('hidden');
            photoPreview.src = '';
            submitPhotoBtn.disabled = true;
            retakePhotoBtn.disabled = true;
            appData.currentPhoto = null;
            
            // 确保摄像头已停止
            stopCamera();
        }

        // 查看任务详情
        function viewTaskDetails(taskId) {
            const task = appData.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            appData.currentTask = task;
            
            const taskSchedule = getTaskCheckinSchedule(task);
            const checkinDetails = taskSchedule.map((day, index) => {
                const checkin = task.checkins.find(c => c.checkpointIndex === index);
                
                let status = checkin ? (checkin.status === 'needs_redo' ? '需重做' : '完成') : '未完成';
                let statusIcon = checkin ? (checkin.status === 'needs_redo' ? '🔄' : '✅') : '❌';
                let statusClass = checkin ? (checkin.status === 'needs_redo' ? 'status-needs-redo-icon' : 'status-completed-icon') : 'status-missed-icon';
                
                let dayDisplay;
                if (task.scheduleType === 'daily') {
                    dayDisplay = `第${day + 1}天`;
                    const startDate = new Date(task.dailyStartDate || task.createDate);
                    const checkinDate = new Date(startDate.getTime() + day * 24 * 60 * 60 * 1000);
                    dayDisplay += ` (${checkinDate.toLocaleDateString()})`;
                } else if (task.scheduleType === 'custom') {
                    const startDate = new Date(task.createDate);
                    const checkinDate = new Date(startDate.getTime() + day * 24 * 60 * 60 * 1000);
                    dayDisplay = checkinDate.toLocaleDateString();
                } else {
                    dayDisplay = `第${day.toString().padStart(3, ' ')}天`;
                    const startDate = new Date(task.createDate);
                    const checkinDate = new Date(startDate.getTime() + day * 24 * 60 * 60 * 1000);
                    dayDisplay += ` (${checkinDate.toLocaleDateString()})`;
                }
                
                return `
                    <div class="checkin-item">
                        <div class="checkin-day">${dayDisplay}:</div>
                        <div class="checkin-status">
                            <span class="status-icon ${statusClass}">${statusIcon}</span>
                            <span>${status}</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            taskDetailsTitle.textContent = `${task.subject} - ${task.name}`;
            taskDetailsContent.innerHTML = `
                <div class="form-group">
                    <label>任务描述</label>
                    <p>${task.description ? task.description.replace(/\n/g, '<br>') : '无描述'}</p>
                </div>
                <div class="form-group">
                    <label>创建日期</label>
                    <p>${new Date(task.createDate).toLocaleDateString()}</p>
                </div>
                <div class="form-group">
                    <label>打卡计划类型</label>
                    <p>${task.scheduleType === 'daily' ? '每日打卡' : (task.scheduleType === 'custom' ? '自定义日期' : '默认计划')}</p>
                </div>
                <div class="form-group">
                    <label>第一天打卡次数</label>
                    <p>${task.firstDayCheckinCount || 1} 次</p>
                </div>
                ${task.scheduleType === 'daily' ? `
                    <div class="form-group">
                        <label>打卡频率</label>
                        <p>${getFrequencyDisplayInfo(task)}</p>
                    </div>
                    <div class="form-group">
                        <label>时间范围</label>
                        <p>${getDailyScheduleInfo(task)}</p>
                    </div>
                ` : ''}
                <div class="checkin-progress">
                    <h4>打卡进度</h4>
                    ${checkinDetails}
                </div>
            `;
            
            taskDetailsModal.classList.remove('hidden');
        }

        // 隐藏任务详情
        function hideTaskDetails() {
            taskDetailsModal.classList.add('hidden');
            appData.currentTask = null;
        }

        // 数据管理功能
        async function showDataManagementModal() {
            dataManagementModal.classList.remove('hidden');
            await updateDataStats();
        }

        function hideDataManagementModal() {
            dataManagementModal.classList.add('hidden');
        }

        async function updateDataStats() {
            const totalTasks = appData.tasks.length;
            const completedTasks = appData.tasks.filter(task => {
                const taskSchedule = getTaskCheckinSchedule(task);
                return task.checkins.filter(c => c.status === 'completed').length === taskSchedule.length;
            }).length;
            
            // 只统计今天的打卡记录数量
            const todayRecordings = appData.recordings.length;
            const todayPhotos = appData.photos.length;
            
            const storageStats = await dataStorage.getStorageStats();

            document.getElementById('stat-total-tasks').textContent = totalTasks;
            document.getElementById('stat-completed-tasks').textContent = completedTasks;
            document.getElementById('stat-total-recordings').textContent = todayRecordings;
            document.getElementById('stat-total-photos').textContent = todayPhotos;
            document.getElementById('stat-data-size').textContent = storageStats.totalSizeMB + ' MB';
            
            // 更新容量显示
            updateCapacityDisplay(storageStats);
        }

        // 更新容量显示
        function updateCapacityDisplay(storageStats) {
            const usagePercent = storageStats.usagePercent;
            
            // 主页面显示
            capacityFillEl.style.width = `${usagePercent}%`;
            capacityTextEl.textContent = `当前使用: ${storageStats.totalSizeMB} MB / ${storageStats.maxCapacityMB} MB`;
            
            // 模态框显示
            modalCapacityFillEl.style.width = `${usagePercent}%`;
            modalCapacityTextEl.textContent = `当前使用: ${storageStats.totalSizeMB} MB / ${storageStats.maxCapacityMB} MB`;
            
            let statusText = '安全';
            let statusClass = 'capacity-safe';
            
            if (usagePercent > 80) {
                statusText = '危险';
                statusClass = 'capacity-danger';
            } else if (usagePercent > 60) {
                statusText = '警告';
                statusClass = 'capacity-warning';
            } else if (usagePercent > 40) {
                statusText = '正常';
                statusClass = 'capacity-safe';
            } else {
                statusText = '充足';
                statusClass = 'capacity-safe';
            }
            
            capacityStatusEl.textContent = statusText;
            capacityStatusEl.className = statusClass;
            
            modalCapacityStatusEl.textContent = statusText;
            modalCapacityStatusEl.className = statusClass;
        }

        async function renderDataStats() {
            const totalTasks = appData.tasks.length;
            
            const completedTasks = appData.tasks.filter(task => {
                const taskSchedule = getTaskCheckinSchedule(task);
                return task.checkins.filter(c => c.status === 'completed').length === taskSchedule.length;
            }).length;
            
            // 只统计今天的打卡记录数量
            const todayRecordings = appData.recordings.length;
            const todayPhotos = appData.photos.length;
            
            const storageStats = await dataStorage.getStorageStats();

            document.getElementById('stats-total-tasks').textContent = totalTasks;
            document.getElementById('stats-completed-tasks').textContent = completedTasks;
            document.getElementById('stats-total-recordings').textContent = todayRecordings;
            document.getElementById('stats-total-photos').textContent = todayPhotos;
            document.getElementById('stats-data-size').textContent = storageStats.totalSizeMB + ' MB';
            
            // 更新容量显示
            updateCapacityDisplay(storageStats);
            
            // 显示存储警告
            showStorageWarning(storageStats);
        }

        // 显示存储警告
        function showStorageWarning(storageStats) {
            const totalSizeMB = parseFloat(storageStats.totalSizeMB);
            
            storageWarningEl.classList.remove('hidden', 'low', 'medium', 'high');
            
            if (totalSizeMB > 50) {
                storageWarningEl.classList.add('high');
                storageSizeDisplayEl.classList.add('high');
                storageMessageEl.textContent = `⚠️ 数据存储量较大（${storageStats.totalSizeMB} MB），建议定期导出备份数据！`;
                storageWarningEl.classList.remove('hidden');
            } else if (totalSizeMB > 20) {
                storageWarningEl.classList.add('medium');
                storageSizeDisplayEl.classList.add('medium');
                storageMessageEl.textContent = `数据存储量适中（${storageStats.totalSizeMB} MB），IndexedDB最多可存储约${storageStats.estimatedMaxCapacity}MB`;
                storageWarningEl.classList.remove('hidden');
            } else {
                storageWarningEl.classList.add('low');
                storageSizeDisplayEl.classList.add('low');
                storageMessageEl.textContent = `数据存储量正常（${storageStats.totalSizeMB} MB），IndexedDB最多可存储约${storageStats.estimatedMaxCapacity}MB`;
                storageWarningEl.classList.remove('hidden');
            }
        }

        // 导出数据
        async function exportData() {
            try {
                const tasks = await dataStorage.getAllTasks();
                const recordings = await dataStorage.getAllRecordings();
                const photos = await dataStorage.getAllPhotos();
                const feedbacks = await dataStorage.getAllFromStore('feedbacks');
                
                const exportData = {
                    version: '2.0',
                    exportDate: new Date().toISOString(),
                    source: 'IndexedDB',
                    tasks: tasks,
                    recordings: recordings,
                    photos: photos,
                    feedbacks: feedbacks
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `复习打卡计划备份_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                alert(`数据导出成功！共导出：${tasks.length}个任务，${recordings.length}个录音，${photos.length}张照片`);
                
            } catch (error) {
                console.error('导出数据失败:', error);
                alert('导出数据失败：' + error.message);
            }
        }

        // 导出为Excel功能
        async function exportToExcel() {
            try {
                const tasks = await dataStorage.getAllTasks();
                
                if (tasks.length === 0) {
                    alert('没有任务数据可以导出');
                    return;
                }
                
                // 创建Excel内容
                let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
                
                // 表头
                const headers = [
                    "ID",
                    "科目",
                    "任务名称", 
                    "任务描述",
                    "创建日期",
                    "状态",
                    "计划类型",
                    "第一天打卡次数",
                    "置顶",
                    "已完成打卡",
                    "总打卡次数",
                    "完成进度",
                    "最近打卡时间"
                ];
                
                csvContent += headers.join(",") + "\n";
                
                // 数据行
                tasks.forEach(task => {
                    const taskSchedule = getTaskCheckinSchedule(task);
                    const completedCheckins = task.checkins.filter(c => c.status === 'completed').length;
                    const totalCheckins = taskSchedule.length;
                    const progressPercent = totalCheckins > 0 ? ((completedCheckins / totalCheckins) * 100).toFixed(2) + '%' : '0%';
                    
                    // 获取最近打卡时间
                    let lastCheckinDate = '';
                    if (task.checkins.length > 0) {
                        const sortedCheckins = [...task.checkins].sort((a, b) => 
                            new Date(b.date) - new Date(a.date)
                        );
                        lastCheckinDate = new Date(sortedCheckins[0].date).toLocaleString();
                    }
                    
                    const row = [
                        task.id,
                        task.subject,
                        task.name,
                        task.description ? `"${task.description.replace(/"/g, '""')}"` : '',
                        new Date(task.createDate).toLocaleDateString(),
                        task.status,
                        task.scheduleType,
                        task.firstDayCheckinCount || 1,
                        task.pinned ? '是' : '否',
                        completedCheckins,
                        totalCheckins,
                        progressPercent,
                        lastCheckinDate
                    ];
                    
                    csvContent += row.join(",") + "\n";
                });
                
                // 创建下载链接
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `任务数据_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert('Excel数据导出成功！');
            } catch (error) {
                console.error('导出Excel失败:', error);
                alert('导出Excel失败: ' + error.message);
            }
        }

        function handleImportFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.json')) {
                alert('请选择JSON格式的文件！');
                importDataFile.value = '';
                return;
            }
            
            importDataBtn.disabled = false;
        }

        async function importData() {
            const file = importDataFile.files[0];
            if (!file) return;
            
            if (!confirm('导入数据将覆盖当前所有数据，确定要继续吗？')) {
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (!importedData.tasks) {
                        throw new Error('文件格式不正确，缺少任务数据');
                    }
                    
                    // 清空现有数据
                    await dataStorage.clearAllData();
                    
                    // 导入新数据
                    if (importedData.tasks) {
                        await dataStorage.saveAllTasks(importedData.tasks);
                    }
                    
                    if (importedData.recordings) {
                        for (const recording of importedData.recordings) {
                            await dataStorage.saveRecording(recording);
                        }
                    }
                    
                    if (importedData.photos) {
                        for (const photo of importedData.photos) {
                            await dataStorage.savePhoto(photo);
                        }
                    }
                    
                    if (importedData.feedbacks) {
                        for (const feedback of importedData.feedbacks) {
                            await dataStorage.saveToStore('feedbacks', feedback);
                        }
                    }
                    
                    // 重新加载数据
                    await loadLocalData();
                    restoreRecordingUrls();
                    
                    renderTodayTasks();
                    renderAllTasks();
                    renderCalendar();
                    renderRecordings();
                    renderDataStats();
                    
                    hideDataManagementModal();
                    importDataFile.value = '';
                    importDataBtn.disabled = true;
                    
                    alert('数据导入成功！');
                    
                } catch (error) {
                    console.error('数据导入失败:', error);
                    alert('数据导入失败：' + error.message);
                }
            };
            reader.onerror = function() {
                alert('文件读取失败，请重试');
            };
            reader.readAsText(file);
        }

        async function clearAllData() {
            if (!confirm('确定要清除所有数据吗？此操作不可撤销！')) {
                return;
            }
            
            if (!confirm('再次确认：这将删除所有任务、打卡记录和点评，确定要继续吗？')) {
                return;
            }
            
            await dataStorage.clearAllData();
            
            appData.tasks = [];
            appData.recordings = [];
            appData.photos = [];
            appData.feedbacks = [];
            
            appData.currentTask = null;
            appData.currentRecording = null;
            appData.currentPhoto = null;
            appData.selectedCalendarDate = null;
            appData.editingTask = null;
            appData.currentCheckpointIndex = null;
            appData.isRedo = false;
            
            renderTodayTasks();
            renderAllTasks();
            renderCalendar();
            renderRecordings();
            renderDataStats();
            
            alert('所有数据已清除！');
        }

        // 渲染打卡记录
        async function renderRecordings() {
            recordingsListEl.innerHTML = '';
            
            try {
                // 获取今日打卡记录
                const todayRecordings = await dataStorage.getTodayRecordings();
                const todayPhotos = await dataStorage.getTodayPhotos();
                
                const allCheckins = [...todayRecordings, ...todayPhotos];
                
                if (allCheckins.length === 0) {
                    recordingsListEl.innerHTML = `
                        <div class="empty-state">
                            <i>🎤</i>
                            <p>今天还没有任何打卡记录</p>
                        </div>
                    `;
                    return;
                }
                
                // 按时间倒序排列
                allCheckins.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                for (const checkin of allCheckins) {
                    const checkinEl = document.createElement('div');
                    checkinEl.className = 'recording-item';
                    
                    const task = appData.tasks.find(t => t.id === checkin.taskId);
                    const taskName = task ? `${task.subject} - ${task.name}` : '未知任务';
                    const taskSchedule = getTaskCheckinSchedule(task);
                    const checkpointDay = taskSchedule[checkin.checkpointIndex];
                    
                    let dayDisplay;
                    if (task.scheduleType === 'daily') {
                        dayDisplay = `第${checkpointDay + 1}天`;
                    } else if (task.scheduleType === 'custom') {
                        const startDate = new Date(task.createDate);
                        const checkinDate = new Date(startDate.getTime() + checkpointDay * 24 * 60 * 60 * 1000);
                        dayDisplay = checkinDate.toLocaleDateString();
                    } else {
                        dayDisplay = `第${checkpointDay}天`;
                    }
                    
                    const date = new Date(checkin.date).toLocaleString();
                    
                    const checkinType = checkin.type === 'audio' ? '录音' : '照片';
                    
                    checkinEl.innerHTML = `
                        <div class="recording-info">
                            <div class="recording-name">${taskName} - ${dayDisplay} (${checkinType})</div>
                            <div class="recording-duration">
                                ${date} | ${checkin.type === 'audio' ? `时长: ${formatTime(checkin.duration)}` : '照片打卡'}
                            </div>
                        </div>
                        <div class="task-actions">
                            ${checkin.type === 'audio' ? 
                                `<button class="btn btn-secondary" onclick="playSavedRecording(${checkin.id})" id="play-saved-${checkin.id}">播放</button>` : 
                                `<button class="btn btn-secondary" onclick="viewPhoto(${checkin.id})" id="view-photo-${checkin.id}">查看</button>`
                            }
                        </div>
                    `;
                    
                    recordingsListEl.appendChild(checkinEl);
                }
                
            } catch (error) {
                console.error('渲染打卡记录失败:', error);
                recordingsListEl.innerHTML = `
                    <div class="empty-state">
                        <i>🎤</i>
                        <p>今天还没有任何打卡记录，开始你的第一次打卡吧！</p>
                    </div>
                `;
            }
        }

        // 查看照片
        async function viewPhoto(photoId) {
            try {
                const photo = await dataStorage.getPhoto(photoId);
                if (!photo) {
                    alert('未找到照片记录');
                    return;
                }
                
                // 在新窗口中查看照片
                const photoWindow = window.open('', '_blank');
                photoWindow.document.write(`
                    <html>
                    <head>
                        <title>打卡照片</title>
                        <style>
                            body { 
                                margin: 0; 
                                padding: 20px; 
                                display: flex; 
                                justify-content: center; 
                                align-items: center; 
                                min-height: 100vh; 
                                background: #f5f5f5; 
                            }
                            img { 
                                max-width: 100%; 
                                max-height: 90vh; 
                                box-shadow: 0 4px 8px rgba(0,0,0,0.2); 
                            }
                        </style>
                    </head>
                    <body>
                        <img src="${photo.imageData}" alt="打卡照片">
                    </body>
                    </html>
                `);
                
            } catch (error) {
                console.error('查看照片失败:', error);
                alert('加载照片失败');
            }
        }

        // 渲染日历
        function renderCalendar() {
            calendarEl.innerHTML = '';
            
            const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
            weekdays.forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-weekday';
                dayEl.textContent = day;
                calendarEl.appendChild(dayEl);
            });
            
            const year = appData.currentCalendarDate.getFullYear();
            const month = appData.currentCalendarDate.getMonth();
            calendarTitleEl.textContent = `${year}年${month + 1}月`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            const firstDayIndex = firstDay.getDay();
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            
            for (let i = firstDayIndex - 1; i >= 0; i--) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day other-month';
                dayEl.innerHTML = `<div class="day-number">${prevMonthLastDay - i}</div>`;
                calendarEl.appendChild(dayEl);
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                
                const date = new Date(year, month, day);
                if (date.getTime() === today.getTime()) {
                    dayEl.classList.add('today');
                }
                
                if (appData.selectedCalendarDate && 
                    appData.selectedCalendarDate.getDate() === day &&
                    appData.selectedCalendarDate.getMonth() === month &&
                    appData.selectedCalendarDate.getFullYear() === year) {
                    dayEl.classList.add('selected');
                }
                
                // 获取该日期的任务数量
                const tasksOnDate = getTasksOnDate(date);
                const totalTasks = tasksOnDate.overdue + tasksOnDate.today + tasksOnDate.future + tasksOnDate.completed + tasksOnDate.needsRedo;
                
                let indicators = '';
                if (tasksOnDate.overdue > 0) {
                    indicators += '<div class="task-indicator indicator-overdue"></div>';
                }
                if (tasksOnDate.today > 0) {
                    indicators += '<div class="task-indicator indicator-today"></div>';
                }
                if (tasksOnDate.future > 0) {
                    indicators += '<div class="task-indicator indicator-future"></div>';
                }
                if (tasksOnDate.completed > 0) {
                    indicators += '<div class="task-indicator indicator-completed"></div>';
                }
                if (tasksOnDate.needsRedo > 0) {
                    indicators += '<div class="task-indicator indicator-needs-redo"></div>';
                }
                
                // 添加任务数量指示器
                let taskCountIndicator = '';
                if (totalTasks > 0) {
                    taskCountIndicator = `<div class="task-count-indicator">${totalTasks}</div>`;
                }
                
                dayEl.innerHTML = `
                    <div class="day-number">${day}</div>
                    ${indicators}
                    ${taskCountIndicator}
                `;
                
                dayEl.addEventListener('click', () => showDateTasks(date));
                calendarEl.appendChild(dayEl);
            }
            
            const totalCells = 42;
            const filledCells = firstDayIndex + lastDay.getDate();
            const remainingCells = totalCells - filledCells;
            
            for (let day = 1; day <= remainingCells; day++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day other-month';
                dayEl.innerHTML = `<div class="day-number">${day}</div>`;
                calendarEl.appendChild(dayEl);
            }
        }

        // 日历导航
        function navigateCalendar(direction) {
            const currentDate = appData.currentCalendarDate;
            const newDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + direction, 1);
            appData.currentCalendarDate = newDate;
            renderCalendar();
        }

        // 回到今天
        function goToToday() {
            appData.currentCalendarDate = new Date();
            appData.selectedCalendarDate = new Date();
            renderCalendar();
            showDateTasks(new Date());
        }

        // 获取指定日期的任务
        function getTasksOnDate(date) {
            const result = {
                overdue: 0,
                today: 0,
                future: 0,
                completed: 0,
                needsRedo: 0
            };
            
            appData.tasks.forEach(task => {
                if (task.status !== 'active') return;
                
                const taskDate = new Date(task.createDate);
                taskDate.setHours(0, 0, 0, 0);
                
                const targetDate = new Date(date);
                targetDate.setHours(0, 0, 0, 0);
                
                const daysSinceStart = Math.floor((targetDate - taskDate) / (1000 * 60 * 60 * 24));
                const taskSchedule = getTaskCheckinSchedule(task);
                
                const isCheckpointDay = taskSchedule.includes(daysSinceStart);
                if (isCheckpointDay) {
                    const checkpointIndex = taskSchedule.indexOf(daysSinceStart);
                    const checkin = task.checkins.find(c => c.checkpointIndex === checkpointIndex);
                    
                    if (checkin) {
                        if (checkin.status === 'completed') {
                            result.completed++;
                        } else if (checkin.status === 'needs_redo') {
                            result.needsRedo++;
                        }
                    } else {
                        if (daysSinceStart < 0) {
                            result.future++;
                        } else if (daysSinceStart === 0) {
                            result.today++;
                        } else {
                            result.overdue++;
                        }
                    }
                }
            });
            
            return result;
        }

        // 显示指定日期的任务
        function showDateTasks(date) {
            appData.selectedCalendarDate = date;
            renderCalendar();
            
            selectedDateTasksEl.innerHTML = '';
            
            const dateStr = date.toLocaleDateString();
            selectedDateTasksEl.innerHTML = `<h3>${dateStr} 的任务</h3>`;
            
            let hasTasks = false;
            
            const tasksForDate = [];
            
            appData.tasks.forEach(task => {
                if (task.status !== 'active') return;
                
                const taskDate = new Date(task.createDate);
                taskDate.setHours(0, 0, 0, 0);
                
                const targetDate = new Date(date);
                targetDate.setHours(0, 0, 0, 0);
                
                const daysSinceStart = Math.floor((targetDate - taskDate) / (1000 * 60 * 60 * 24));
                const taskSchedule = getTaskCheckinSchedule(task);
                
                const checkpointIndex = taskSchedule.findIndex(day => day === daysSinceStart);
                
                if (checkpointIndex !== -1) {
                    hasTasks = true;
                    const checkpointDay = taskSchedule[checkpointIndex];
                    const isOverdue = daysSinceStart > checkpointDay;
                    const checkin = task.checkins.find(c => c.checkpointIndex === checkpointIndex);
                    const hasCheckedIn = checkin && checkin.status === 'completed';
                    const needsRedo = checkin && checkin.status === 'needs_redo';
                    
                    tasksForDate.push({
                        task,
                        checkpointIndex,
                        daysSinceStart,
                        isOverdue,
                        hasCheckedIn,
                        needsRedo
                    });
                }
            });
            
            // 按置顶、科目和字母排序
            tasksForDate.sort((a, b) => {
                if (a.task.pinned && !b.task.pinned) return -1;
                if (!a.task.pinned && b.task.pinned) return 1;
                
                const subjectOrder = { '语文': 1, '英语': 2, '数学': 3, '科学': 4, '其他': 5 };
                const subjectA = subjectOrder[a.task.subject] || 6;
                const subjectB = subjectOrder[b.task.subject] || 6;
                
                if (subjectA !== subjectB) {
                    return subjectA - subjectB;
                }
                
                return a.task.name.localeCompare(b.task.name, 'zh-CN');
            });
            
            tasksForDate.forEach(item => {
                const task = item.task;
                const checkpointIndex = item.checkpointIndex;
                const daysSinceStart = item.daysSinceStart;
                const isOverdue = item.isOverdue;
                const hasCheckedIn = item.hasCheckedIn;
                const needsRedo = item.needsRedo;
                
                const taskEl = document.createElement('div');
                
                let taskClass = 'task-item';
                if (isOverdue) {
                    taskClass += ' overdue';
                } else if (hasCheckedIn) {
                    taskClass += ' completed';
                } else if (needsRedo) {
                    taskClass += ' needs-redo';
                }
                
                taskEl.className = taskClass;
                
                let dayDisplay;
                if (task.scheduleType === 'daily') {
                    dayDisplay = `第${daysSinceStart + 1}天`;
                } else if (task.scheduleType === 'custom') {
                    const startDate = new Date(task.createDate);
                    const checkinDate = new Date(startDate.getTime() + checkpointIndex * 24 * 60 * 60 * 1000);
                    dayDisplay = checkinDate.toLocaleDateString();
                } else {
                    const checkpointDay = getTaskCheckinSchedule(task)[checkpointIndex];
                    dayDisplay = `第${checkpointDay}天`;
                }
                
                taskEl.innerHTML = `
                    <div class="task-header">
                        <div class="task-name">${task.subject} - ${task.name}</div>
                        <div class="task-status ${needsRedo ? 'status-needs-redo' : (hasCheckedIn ? 'status-completed' : (isOverdue ? 'status-overdue' : 'status-today'))}">
                            ${isOverdue ? `逾期${daysSinceStart - getTaskCheckinSchedule(task)[checkpointIndex]}天` : dayDisplay} ${needsRedo ? '需重做' : (hasCheckedIn ? '✓' : '')}
                        </div>
                    </div>
                    <p>${task.description ? task.description.replace(/\n/g, '<br>') : ''}</p>
                    <div class="task-actions">
                        ${(!hasCheckedIn || needsRedo) ? 
                            `<button class="btn btn-primary" onclick="startCheckin(${task.id}, ${checkpointIndex})">
                                ${needsRedo ? '重做打卡' : '打卡'}
                            </button>` : ''}
                    </div>
                `;
                
                selectedDateTasksEl.appendChild(taskEl);
            });
            
            if (!hasTasks) {
                selectedDateTasksEl.innerHTML += `
                    <div class="empty-state">
                        <i>📅</i>
                        <p>这一天没有打卡任务</p>
                    </div>
                `;
            }
        }

        // 重做管理功能
        function showRedoManagementModal(taskId, checkpointIndex) {
            const task = appData.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            appData.redoTask = task;
            appData.redoCheckpointIndex = checkpointIndex;
            
            renderRedoTasksList();
            
            redoManagementModal.classList.remove('hidden');
        }

        function hideRedoManagementModal() {
            redoManagementModal.classList.add('hidden');
            appData.redoTask = null;
            appData.redoCheckpointIndex = null;
            redoReasonInput.value = '';
            
            const defaultDeadline = new Date();
            defaultDeadline.setDate(defaultDeadline.getDate() + 7);
            redoDeadlineInput.valueAsDate = defaultDeadline;
        }

        function renderRedoTasksList() {
            redoTasksList.innerHTML = '';
            
            const redoTasks = getRedoTasks();
            
            if (redoTasks.length === 0) {
                redoTasksList.innerHTML = '<p style="text-align: center; color: #64748b; padding: 10px;">暂无需要重做的任务</p>';
                return;
            }
            
            redoTasks.forEach(redoTask => {
                const task = redoTask.task;
                const checkin = redoTask.checkin;
                
                const redoItem = document.createElement('div');
                redoItem.className = 'redo-item';
                
                const deadline = new Date(checkin.redoDeadline);
                const now = new Date();
                const daysLeft = Math.ceil((deadline - now) / (1000 * 60 * 60 * 24));
                
                redoItem.innerHTML = `
                    <div class="redo-info">
                        <strong>${task.subject} - ${task.name}</strong>
                        <div class="redo-reason">原因: ${checkin.redoReason || '未指定原因'}</div>
                        <div class="redo-deadline">剩余时间: ${daysLeft}天</div>
                    </div>
                    <button class="btn btn-warning" onclick="startRedoCheckin(${task.id}, ${redoTask.checkpointIndex})">
                        重做
                    </button>
                `;
                
                redoTasksList.appendChild(redoItem);
            });
        }

        // 获取需要重做的任务
        function getRedoTasks() {
            const redoTasks = [];
            
            appData.tasks.forEach(task => {
                if (task.status !== 'active') return;
                
                task.checkins.forEach(checkin => {
                    if (checkin.status === 'needs_redo') {
                        redoTasks.push({
                            task,
                            checkin,
                            checkpointIndex: checkin.checkpointIndex
                        });
                    }
                });
            });
            
            return redoTasks;
        }

        // 标记需要重做
        async function markForRedo() {
            if (!appData.redoTask || appData.redoCheckpointIndex === null) return;
            
            const reason = redoReasonInput.value.trim();
            const deadline = redoDeadlineInput.value;
            
            if (!reason) {
                alert('请输入重做原因');
                return;
            }
            
            if (!deadline) {
                alert('请设置重做截止日期');
                return;
            }
            
            const success = await markCheckinForRedo(
                appData.redoTask.id, 
                appData.redoCheckpointIndex, 
                reason,
                deadline
            );
            
            if (success) {
                alert('已标记为需要重做');
                hideRedoManagementModal();
                renderTodayTasks();
                renderAllTasks();
            } else {
                alert('标记重做失败');
            }
        }

        // 标记打卡需要重做
        async function markCheckinForRedo(taskId, checkpointIndex, reason, deadline) {
            const task = appData.tasks.find(t => t.id === taskId);
            if (!task) return false;

            let checkin = task.checkins.find(c => c.checkpointIndex === checkpointIndex);
            
            if (!checkin) {
                checkin = {
                    checkpointIndex: checkpointIndex,
                    date: new Date().toISOString(),
                    status: 'needs_redo',
                    type: 'pending'
                };
                task.checkins.push(checkin);
            } else {
                checkin.status = 'needs_redo';
            }
            
            checkin.redoReason = reason;
            checkin.redoDeadline = deadline;
            checkin.redoCount = (checkin.redoCount || 0) + 1;
            
            await saveTasks();
            
            renderTodayTasks();
            renderAllTasks();
            
            return true;
        }

        // 开始重做打卡
        function startRedoCheckin(taskId, checkpointIndex) {
            const task = appData.tasks.find(t => t.id === taskId);
            if (!task) return;

            const checkin = task.checkins.find(c => c.checkpointIndex === checkpointIndex);
            if (!checkin || checkin.status !== 'needs_redo') return;

            if (new Date() > new Date(checkin.redoDeadline)) {
                alert('已超过重做截止日期');
                return;
            }

            appData.currentTask = task;
            appData.currentCheckpointIndex = checkpointIndex;
            appData.isRedo = true;

            switchTab('checkin');
            updateRecorderTaskInfo();
            updatePhotoTaskInfo();
            
            alert(`这是重做打卡，原因为：${checkin.redoReason || '未指定原因'}`);
            
            hideRedoManagementModal();
        }

        // 执行重做打卡
        async function redoCheckin(taskId, checkpointIndex, newRecording) {
            const task = appData.tasks.find(t => t.id === taskId);
            if (!task) return false;

            const originalCheckin = task.checkins.find(c => c.checkpointIndex === checkpointIndex);
            if (!originalCheckin || originalCheckin.status !== 'needs_redo') return false;

            const maxRedoCount = 3;
            if (originalCheckin.redoCount >= maxRedoCount) {
                alert(`已达到最大重做次数（${maxRedoCount}次）`);
                return false;
            }

            if (new Date() > new Date(originalCheckin.redoDeadline)) {
                alert('已超过重做截止日期');
                return false;
            }

            const newCheckin = {
                checkpointIndex: checkpointIndex,
                date: new Date().toISOString(),
                recordingId: newRecording.id,
                type: newRecording.type,
                status: 'completed',
                isRedo: true,
                originalCheckinId: originalCheckin.recordingId || originalCheckin.photoId,
                redoCount: originalCheckin.redoCount
            };

            const checkinIndex = task.checkins.findIndex(c => c.checkpointIndex === checkpointIndex);
            task.checkins[checkinIndex] = newCheckin;

            await saveTasks();
            
            renderTodayTasks();
            renderAllTasks();
            renderRecordings();
            
            alert('重做打卡成功！');
            return true;
        }

        // 在任务项中显示重做信息
        function renderRedoInfo(task, checkpointIndex) {
            const checkin = task.checkins.find(c => c.checkpointIndex === checkpointIndex);
            if (!checkin || checkin.status !== 'needs_redo') return '';

            const deadline = new Date(checkin.redoDeadline);
            const now = new Date();
            const daysLeft = Math.ceil((deadline - now) / (1000 * 60 * 60 * 24));
            const isOverdue = daysLeft < 0;
            
            return `
                <div class="redo-notice">
                    <h4>⚠️ 需要重做</h4>
                    <p><strong>原因:</strong> ${checkin.redoReason || '未指定原因'}</p>
                    <p class="${isOverdue ? 'redo-deadline' : ''}"><strong>剩余时间:</strong> ${isOverdue ? '已超期' : daysLeft + '天'}</p>
                    <p><strong>重做次数:</strong> ${checkin.redoCount || 0}/3</p>
                    <button class="btn btn-warning" onclick="startRedoCheckin(${task.id}, ${checkpointIndex})">
                        立即重做
                    </button>
                </div>
            `;
        }

        // 新增：录音管理功能
        async function showRecordingsManageModal() {
            recordingsManageModal.classList.remove('hidden');
            await loadAllRecordingsAndPhotos();
            await updateManageCapacity();
        }

        function hideRecordingsManageModal() {
            recordingsManageModal.classList.add('hidden');
            appData.selectedRecordings.clear();
            appData.selectedPhotos.clear();
            selectAllRecordingsBtn.checked = false;
            selectAllPhotosBtn.checked = false;
            hideDeleteConfirm();
        }

        async function loadAllRecordingsAndPhotos() {
            try {
                // 加载所有录音和照片
                const allRecordings = await dataStorage.getAllRecordings();
                const allPhotos = await dataStorage.getAllPhotos();
                
                // 渲染录音表格
                renderRecordingsTable(allRecordings);
                
                // 渲染照片表格
                renderPhotosTable(allPhotos);
                
            } catch (error) {
                console.error('加载录音和照片失败:', error);
            }
        }

        function renderRecordingsTable(recordings) {
            recordingsTableBody.innerHTML = '';
            
            if (recordings.length === 0) {
                noRecordingsMessage.classList.remove('hidden');
                return;
            }
            
            noRecordingsMessage.classList.add('hidden');
            
            // 按日期倒序排列
            recordings.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            recordings.forEach(recording => {
                const task = appData.tasks.find(t => t.id === recording.taskId);
                const taskName = task ? `${task.subject} - ${task.name}` : '未知任务';
                const date = new Date(recording.date).toLocaleDateString();
                
                // 计算录音大小
                let size = '未知';
                if (recording.audioData) {
                    const base64Length = recording.audioData.length - (recording.audioData.indexOf(',') + 1);
                    const byteSize = Math.floor(base64Length * 3 / 4);
                    size = formatFileSize(byteSize);
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="recording-checkbox" data-id="${recording.id}" 
                               onchange="toggleRecordingSelection(${recording.id}, this.checked)">
                    </td>
                    <td>${date}</td>
                    <td>${taskName}</td>
                    <td>录音</td>
                    <td class="recording-size">${size}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="playSavedRecording(${recording.id})" style="padding: 4px 8px; font-size: 12px;">播放</button>
                    </td>
                `;
                recordingsTableBody.appendChild(row);
            });
        }

        function renderPhotosTable(photos) {
            photosTableBody.innerHTML = '';
            
            if (photos.length === 0) {
                noPhotosMessage.classList.remove('hidden');
                return;
            }
            
            noPhotosMessage.classList.add('hidden');
            
            // 按日期倒序排列
            photos.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            photos.forEach(photo => {
                const task = appData.tasks.find(t => t.id === photo.taskId);
                const taskName = task ? `${task.subject} - ${task.name}` : '未知任务';
                const date = new Date(photo.date).toLocaleDateString();
                
                // 计算照片大小
                let size = '未知';
                if (photo.imageData) {
                    const base64Length = photo.imageData.length - (photo.imageData.indexOf(',') + 1);
                    const byteSize = Math.floor(base64Length * 3 / 4);
                    size = formatFileSize(byteSize);
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="photo-checkbox" data-id="${photo.id}" 
                               onchange="togglePhotoSelection(${photo.id}, this.checked)">
                    </td>
                    <td>${date}</td>
                    <td>${taskName}</td>
                    <td>照片</td>
                    <td class="recording-size">${size}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="viewPhoto(${photo.id})" style="padding: 4px 8px; font-size: 12px;">查看</button>
                    </td>
                `;
                photosTableBody.appendChild(row);
            });
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        // 切换录音选择状态
        function toggleRecordingSelection(recordingId, isChecked) {
            if (isChecked) {
                appData.selectedRecordings.add(recordingId);
            } else {
                appData.selectedRecordings.delete(recordingId);
            }
            updateDeleteButtonState();
        }

        // 切换照片选择状态
        function togglePhotoSelection(photoId, isChecked) {
            if (isChecked) {
                appData.selectedPhotos.add(photoId);
            } else {
                appData.selectedPhotos.delete(photoId);
            }
            updateDeleteButtonState();
        }

        // 更新删除按钮状态
        function updateDeleteButtonState() {
            const totalSelected = appData.selectedRecordings.size + appData.selectedPhotos.size;
            deleteSelectedBtn.disabled = totalSelected === 0;
        }

        // 显示删除确认
        async function showDeleteConfirm() {
            const totalSelected = appData.selectedRecordings.size + appData.selectedPhotos.size;
            if (totalSelected === 0) return;
            
            // 计算选中文件的总大小
            let totalSize = 0;
            
            // 计算录音大小
            for (const recordingId of appData.selectedRecordings) {
                try {
                    const recording = await dataStorage.getRecording(recordingId);
                    if (recording && recording.audioData) {
                        const base64Length = recording.audioData.length - (recording.audioData.indexOf(',') + 1);
                        totalSize += Math.floor(base64Length * 3 / 4);
                    }
                } catch (error) {
                    console.error('获取录音信息失败:', error);
                }
            }
            
            // 计算照片大小
            for (const photoId of appData.selectedPhotos) {
                try {
                    const photo = await dataStorage.getPhoto(photoId);
                    if (photo && photo.imageData) {
                        const base64Length = photo.imageData.length - (photo.imageData.indexOf(',') + 1);
                        totalSize += Math.floor(base64Length * 3 / 4);
                    }
                } catch (error) {
                    console.error('获取照片信息失败:', error);
                }
            }
            
            const totalSizeMB = (totalSize / (1024 * 1024)).toFixed(2);
            
            selectedCountEl.textContent = totalSelected;
            selectedSizeEl.textContent = totalSizeMB + ' MB';
            
            deleteConfirmSection.style.display = 'block';
        }

        // 隐藏删除确认
        function hideDeleteConfirm() {
            deleteConfirmSection.style.display = 'none';
        }

        // 删除选中的项目
        async function deleteSelectedItems() {
            const recordingIds = Array.from(appData.selectedRecordings);
            const photoIds = Array.from(appData.selectedPhotos);
            
            if (recordingIds.length > 0) {
                try {
                    await dataStorage.deleteMultipleRecordings(recordingIds);
                    console.log(`删除了 ${recordingIds.length} 个录音`);
                } catch (error) {
                    console.error('删除录音失败:', error);
                    alert('删除部分录音失败');
                }
            }
            
            if (photoIds.length > 0) {
                try {
                    await dataStorage.deleteMultiplePhotos(photoIds);
                    console.log(`删除了 ${photoIds.length} 张照片`);
                } catch (error) {
                    console.error('删除照片失败:', error);
                    alert('删除部分照片失败');
                }
            }
            
            // 清除选中状态
            appData.selectedRecordings.clear();
            appData.selectedPhotos.clear();
            selectAllRecordingsBtn.checked = false;
            selectAllPhotosBtn.checked = false;
            
            // 重新加载数据
            await loadAllRecordingsAndPhotos();
            await updateManageCapacity();
            renderDataStats();
            renderRecordings();
            
            hideDeleteConfirm();
            
            alert(`成功删除了 ${recordingIds.length + photoIds.length} 个文件，已释放存储空间！`);
        }

        // 删除30天前的文件
        async function deleteOldRecordings() {
            if (!confirm('确定要删除30天前的所有录音和照片吗？此操作不可撤销！')) {
                return;
            }
            
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            try {
                // 获取所有录音和照片
                const allRecordings = await dataStorage.getAllRecordings();
                const allPhotos = await dataStorage.getAllPhotos();
                
                // 筛选30天前的文件
                const oldRecordings = allRecordings.filter(recording => {
                    const recordDate = new Date(recording.date);
                    return recordDate < thirtyDaysAgo;
                });
                
                const oldPhotos = allPhotos.filter(photo => {
                    const photoDate = new Date(photo.date);
                    return photoDate < thirtyDaysAgo;
                });
                
                if (oldRecordings.length === 0 && oldPhotos.length === 0) {
                    alert('没有找到30天前的文件');
                    return;
                }
                
                // 删除录音
                for (const recording of oldRecordings) {
                    await dataStorage.deleteRecording(recording.id);
                }
                
                // 删除照片
                for (const photo of oldPhotos) {
                    await dataStorage.deletePhoto(photo.id);
                }
                
                // 重新加载数据
                await loadAllRecordingsAndPhotos();
                await updateManageCapacity();
                renderDataStats();
                renderRecordings();
                
                alert(`成功删除了 ${oldRecordings.length} 个录音和 ${oldPhotos.length} 张照片，已释放存储空间！`);
                
            } catch (error) {
                console.error('删除旧文件失败:', error);
                alert('删除旧文件失败: ' + error.message);
            }
        }

        // 更新管理界面的容量显示
        async function updateManageCapacity() {
            const storageStats = await dataStorage.getStorageStats();
            const usagePercent = storageStats.usagePercent;
            
            manageCapacityFillEl.style.width = `${usagePercent}%`;
            manageCapacityTextEl.textContent = `当前使用: ${storageStats.totalSizeMB} MB / ${storageStats.maxCapacityMB} MB`;
            
            let statusText = '安全';
            let statusClass = 'capacity-safe';
            
            if (usagePercent > 80) {
                statusText = '危险';
                statusClass = 'capacity-danger';
            } else if (usagePercent > 60) {
                statusText = '警告';
                statusClass = 'capacity-warning';
            } else if (usagePercent > 40) {
                statusText = '正常';
                statusClass = 'capacity-safe';
            } else {
                statusText = '充足';
                statusClass = 'capacity-safe';
            }
            
            manageCapacityStatusEl.textContent = statusText;
            manageCapacityStatusEl.className = statusClass;
        }

        // 初始化应用
        window.onload = initApp;
    </script>
</body>
</html>